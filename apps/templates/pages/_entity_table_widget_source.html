{% extends 'layouts/vertical.html' %}

{% block title %}{% if page_title is defined %}{{ page_title }}{% else %}__PAGE_TITLE__{% endif %}{% endblock %}

{% block styles %}
<link href="{{ config.ASSETS_ROOT }}/libs/simple-datatables/style.css" rel="stylesheet" type="text/css"/>
<style>
    .entity-table-toolbar { display: flex; align-items: center; gap: 10px; flex-wrap: nowrap; margin-bottom: 16px; }
    .entity-table-toolbar .btn-plus-content { width: 48px; height: 48px; border-radius: 12px; display: inline-flex; align-items: center; justify-content: center; font-size: 24px; }
    /* Скрыть кнопку «плюс» (добавить сущность) везде в блоках таблиц */
    .entity-table-toolbar .btnAddEntityInSection { display: none !important; }
    /* Заглушка: скрыть настройки режимов (Редактирование / Просмотр / Скрыть) — логика в коде сохранена */
    .component-modes-admin,
    .table-mode-admin { display: none !important; }
    .entity-table-section .searchFilterRowInSection .btnFieldsInSection,
    .entity-table-section .searchFilterRowInSection .btn-search-filter-gear { width: 40px; height: 40px; display: inline-flex; align-items: center; justify-content: center; flex-shrink: 0; }
    .entity-table-section .gridTopRowInSection .btnDeleteTableInSection { width: 36px; height: 36px; display: inline-flex; align-items: center; justify-content: center; flex-shrink: 0; border-color: rgba(220,53,69,.35); color: var(--bs-danger, #dc3545); }
    .entity-table-section .gridTopRowInSection .btnDeleteTableInSection:hover { background: rgba(220,53,69,.08); border-color: rgba(220,53,69,.5); }
    /* Title + search + buttons in one row when they fit; search input flexible (e.g. 30%), can shrink. */
    .entity-table-section .searchFilterRowInSection .searchFilterInputWrap { flex: 0 1 30%; min-width: 8rem; max-width: 560px; }
    .entity-table-loading { padding: 24px; text-align: center; color: #64748b; }
    .entity-table-grid-wrap { min-width: 0; overflow: auto;}
    /* Те же стили, что у шаблонных table.datatable.datatable-table (simple-datatables + _tables.scss) */
    .entity-table-section .entity-table-grid-wrap .datatable-table,
    .entity-table-section .entity-table-grid-wrap table.datatable-table {
        width: max-content;
        min-width: 0;
        border-spacing: 0;
        border-collapse: separate;
        white-space: nowrap;
        table-layout: fixed !important;
    }
    .entity-table-section .entity-table-grid-wrap .datatable-table > thead {
        background-color: var(--bs-light, #f8f9fa) !important;
    }
    .entity-table-section .entity-table-grid-wrap .datatable-table > thead > tr > th {
        color: var(--bs-secondary-color, #495057);
        font-weight: 500;
        font-size: 13px;
        background-color: var(--bs-light, #f8f9fa);
        vertical-align: middle;
        text-align: left;
        padding: 0.5rem 0.75rem;
        border-bottom: 1px solid var(--bs-border-color, #dee2e6);
        overflow: hidden;
        min-width: 0;
        width: 1%;
        white-space: nowrap;
    }
    .entity-table-section .entity-table-grid-wrap .datatable-table > thead > tr > th .entity-table-th-inline {
        display: inline-flex;
        align-items: center;
        gap: 2px;
        min-width: 0;
        max-width: 100%;
        vertical-align: middle;
    }
    .entity-table-section .entity-table-grid-wrap .datatable-table > thead > tr > th .entity-table-th-label {
        display: inline-block;
        flex: 0 1 auto;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        min-width: 0;
        max-width: 100%;
    }
    .entity-table-section .entity-table-grid-wrap .datatable-table > tbody > tr > td,
    .entity-table-section .entity-table-grid-wrap .datatable-table > tbody > tr > th,
    .entity-table-section .entity-table-grid-wrap .datatable-table > thead > tr > td {
        vertical-align: middle;
        padding: 0.5rem 0.75rem;
        font-size: 13px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        min-width: 0;
        width: 1%;
    }
    .entity-table-section .entity-table-grid-wrap .datatable-table th a {
        text-decoration: none;
        color: inherit;
    }
    .modal-entity-list .entity-group { margin-bottom: 16px; }
    .modal-entity-list .entity-group-title { font-weight: 700; margin-bottom: 8px; }
    .modal-entity-list .form-check { margin-bottom: 4px; }
    .fields-modal-grid { display: grid; grid-template-columns: repeat(4, minmax(0, 1fr)); gap: 8px 16px; max-height: 70vh; overflow-y: auto; }
    .fields-modal-grid .form-check { min-width: 0; }
    .fields-modal-grid .form-check-label { white-space: normal; word-wrap: break-word; overflow-wrap: break-word; min-width: 0; }
    .fields-modal-grid .fields-modal-entity-header { grid-column: 1 / -1; font-weight: 500; color: var(bs-label-color, #656d9a); padding-top: 6px; margin-top: 2px; border-top: 1px dashed var(--bs-border-color, #dee2e6); }
    .fields-modal-grid .fields-modal-entity-header:first-child { border-top: 0; padding-top: 0; }
    .fields-modal-nested { margin-bottom: 12px; }
    .fields-modal-nested .nested-title { font-weight: 600; margin-bottom: 6px; }
    #paginationBlock.datatable-bottom { padding: 8px 10px; margin-top: 0; display: flex; align-items: center; flex-wrap: wrap; gap: 8px; }
    #paginationBlock .datatable-input { padding: 6px 12px; margin: 0 4px; }
    #paginationBlock .entity-table-pager-btn { border: 1px solid transparent; padding: 6px 12px; margin-left: 2px; text-decoration: none; color: #333; cursor: pointer; border-radius: 4px; background: transparent; font-size: inherit; }
    #paginationBlock .entity-table-pager-btn:hover:not(:disabled) { background-color: #d9d9d9; }
    #paginationBlock .entity-table-pager-btn:disabled { opacity: 0.4; cursor: not-allowed; }
    .entity-table-section .datatable-bottom.paginationBlockInSection { display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 8px; padding: 8px 0; margin-top: 0; width: 100%; max-width: 100%; min-width: 0; flex-shrink: 0; border-top: 1px solid var(--bs-border-color, #dee2e6); box-sizing: border-box; }
    .entity-table-section .paginationBlockInSection .pagination-left-in-section { flex: 1 1 auto; min-width: 0; overflow: hidden; }
    .entity-table-section .paginationBlockInSection .paginationNavInSection { flex: 0 0 auto; min-width: 0; }
    .entity-table-section .pagination-left-in-section { flex: 0 0 auto; }
    .entity-table-section .datatable-pagination.paginationNavInSection { margin-left: auto; flex-shrink: 0; }
    .entity-table-section .datatable-pagination ul { display: flex; flex-wrap: wrap; gap: 2px; margin: 0; padding: 0; list-style: none; }
    .entity-table-section .datatable-pagination li button { padding: 6px 12px; border: 1px solid var(--bs-border-color, #dee2e6); border-radius: var(--bs-border-radius, 4px); background: var(--bs-card-bg, #fff); color: var(--bs-body-color); cursor: pointer; font-size: inherit; }
    .entity-table-section .datatable-pagination li button:hover:not(:disabled) { background-color: var(--bs-tertiary-bg, #e9ecef); border-color: var(--bs-border-color); }
    .entity-table-section .datatable-pagination li.datatable-active button { background-color: #6f6af8; border-color: #6f6af8; color: #fff; }
    .entity-table-section .datatable-pagination li.datatable-disabled button { opacity: 0.4; cursor: not-allowed; }
    .entity-list-two-cols { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem 2rem; max-height: 50vh; overflow-y: auto; }
    @media (max-width: 576px) { .entity-list-two-cols { grid-template-columns: 1fr; } }
    .entity-select-hint .entity-select-hint-icon { width: 24px; height: 24px; min-width: 24px; font-size: 14px; font-weight: 600; font-style: normal; }
    #nestedCheckboxesRow .btn.nested-toggle.active { background-color: var(--bs-primary); color: #fff; border-color: var(--bs-primary); }
    #modalFields.modal-parent-hidden .modal-dialog { visibility: hidden; }
    #gridTopRow #btnFields { margin-left: auto !important; }
    .entity-table-grid-wrap th.entity-table-th-draggable { cursor: grab; user-select: none; }
    .entity-table-grid-wrap th.entity-table-th-draggable:active { cursor: grabbing; }
    .entity-table-grid-wrap th.dragging { opacity: 0.5; }
    .entity-table-grid-wrap th.drag-over { border-left: 2px solid var(--bs-primary); background-color: rgba(var(--bs-primary-rgb), 0.08); }
    .entity-table-grid-wrap .entity-table-sort-indicator { margin-left: 0; font-size: 0.72rem; opacity: 0.85; flex: 0 0 auto; display: none !important; }
    .entity-table-grid-wrap .entity-table-time-toggle {
        margin-left: 0;
        width: 22px;
        height: 22px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 0;
        border: 1px solid var(--bs-border-color, #dee2e6);
        border-radius: 6px;
        background: transparent;
        color: var(--bs-secondary-color, #6c757d);
        line-height: 1;
    }
    .entity-table-grid-wrap .entity-table-time-toggle:hover {
        background: var(--bs-tertiary-bg, #f8f9fa);
        border-color: var(--bs-border-color, #dee2e6);
        color: var(--bs-primary, #6f6af8);
    }
    .entity-table-grid-wrap .entity-table-time-toggle.is-active {
        background: rgba(var(--bs-primary-rgb), 0.12);
        border-color: rgba(var(--bs-primary-rgb), 0.35);
        color: var(--bs-primary, #6f6af8);
    }
    .entity-table-grid-wrap .entity-table-time-toggle i { font-size: 13px; line-height: 1; }
    .entity-table-grid-wrap th.entity-table-th-wrap { position: relative; padding-right: 16px; }
    /* auto — ширина колонок по содержимому; при ручном ресайзе сохраняем width в columnWidths */
    .entity-table-grid-wrap .datatable-table { table-layout: fixed !important; }
    .entity-table-grid-wrap th .entity-table-col-resize { position: absolute; right: 0; top: 0; bottom: 0; width: 6px; cursor: col-resize; user-select: none; touch-action: none; }
    .entity-table-section .entity-table-grid-wrap table caption.entity-table-caption { padding: 0.5rem 0; font-size: 0.875rem; color: var(--bs-secondary-color, #6c757d); caption-side: top; }
    /* Contextual Classes: alternating row colors like Dastone tables-basic */
    .entity-table-section .entity-table-grid-wrap table.table-contextual-rows tbody tr:nth-child(6n+1) { background-color: rgba(var(--bs-primary-rgb), 0.1); }
    .entity-table-section .entity-table-grid-wrap table.table-contextual-rows tbody tr:nth-child(6n+2) { background-color: transparent; }
    .entity-table-section .entity-table-grid-wrap table.table-contextual-rows tbody tr:nth-child(6n+3) { background-color: rgba(var(--bs-secondary-rgb), 0.15); }
    .entity-table-section .entity-table-grid-wrap table.table-contextual-rows tbody tr:nth-child(6n+4) { background-color: transparent; }
    .entity-table-section .entity-table-grid-wrap table.table-contextual-rows tbody tr:nth-child(6n+5) { background-color: rgba(var(--bs-success-rgb), 0.1); }
    .entity-table-grid-wrap th .entity-table-col-resize:hover { background: rgba(var(--bs-primary-rgb), 0.2); }
    /* Layout: sections take only the width they need; next table/widget can sit beside if room (like Dastone row/col cards). */
    #entityTablesContainer { display: flex; flex-wrap: wrap; gap: 1rem; align-items: start; }
    .entity-table-section { width: fit-content; max-width: 100%; min-width: min(320px, 100%); margin-bottom: 0; border: 1px solid var(--bs-border-color, #dee2e6); border-radius: 8px; padding: 1rem; background: var(--bs-body-bg, #fff); display: flex; flex-direction: column; box-shadow: 0 1px 3px rgba(0,0,0,0.06); }
    .entity-table-section .entity-table-toolbar { margin-bottom: 12px; }
    .entity-table-section .gridTopRowInSection { margin-bottom: 12px; }
    .entity-table-section .searchFilterRowInSection { margin-bottom: 12px; position: relative; overflow: visible; }
    .entity-table-section .gridTopRowInSection.table-title-search-row { flex-wrap: wrap; align-items: center; gap: 0.5rem 0.75rem; }
    .entity-table-section .gridTopRowInSection .tableTitleBlockInSection { min-width: 0; }
    /* Report card widget: same layout as Dastone report-card, fits in entityTablesContainer flex */
    .entity-report-card-section { width: fit-content; max-width: 100%; min-width: min(260px, 100%); }
    .entity-report-card-section .card.report-card { margin-bottom: 0; border: 1px solid var(--bs-border-color, #dee2e6); border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.06); }
    .entity-report-card-section .report-card-title { font-weight: 600; margin-bottom: 0.25rem; }
    .entity-report-card-section .report-card-main-value { font-size: 1.25rem; font-weight: 600; margin: 0.25rem 0; }
    .entity-report-card-section .report-card-secondary-value { font-size: 0.875rem; color: var(--bs-secondary-color); margin-bottom: 0; }
    .entity-report-card-section .report-card-icon-wrap { width: 48px; height: 48px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; flex-shrink: 0; }
    .entity-table-section .filterDropdownInSection { position: absolute; left: 0; top: calc(100% + 6px); width: min(380px, 96vw); display: none; z-index: 1070; }
    .entity-table-section .filterDropdownInSection.open { display: block; }
    .entity-table-section .filterDropdownCardInSection { border: 1px solid var(--bs-border-color, #dee2e6); border-radius: 8px; background: var(--bs-body-bg, #fff); box-shadow: 0 10px 24px rgba(0,0,0,.12); padding: 12px; max-height: 65vh; overflow: auto; }
    .entity-table-section .filterPanelInSection { border: 1px solid var(--bs-border-color); border-radius: 8px; padding: 1rem; margin-bottom: 12px; background: var(--bs-body-bg); }
    .entity-table-section .filterPanelInSection .filter-panel-title { font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; justify-content: space-between; }
    .entity-table-section .filterPanelInSection .filter-row-item { margin-bottom: 10px; }
    .entity-table-section .filterPanelInSection .filter-row-item label { font-size: 0.875rem; margin-bottom: 4px; display: block; }
    .entity-table-section .filterPanelInSection .filter-multiselect-wrap { position: relative; }
    .entity-table-section .filterPanelInSection .filter-multiselect-tags { display: flex; flex-wrap: wrap; gap: 6px; min-height: 38px; padding: 6px 12px; border: 1px solid var(--bs-border-color); border-radius: var(--bs-border-radius); background: var(--bs-body-bg); cursor: pointer; }
    .entity-table-section .filterPanelInSection .filter-multiselect-tags .tag { display: inline-flex; align-items: center; gap: 4px; padding: 2px 8px; border-radius: 6px; background: #eaf3ff; color: #35528f; font-size: 0.86rem; }
    .entity-table-section .filterPanelInSection .filter-multiselect-tags .tag-remove { cursor: pointer; opacity: 0.7; }
    .entity-table-section .filterPanelInSection .filter-multiselect-dropdown { display: none; position: absolute; left: 0; right: 0; top: 100%; margin-top: 2px; max-height: 200px; overflow-y: auto; border: 1px solid var(--bs-border-color); border-radius: var(--bs-border-radius); background: var(--bs-body-bg); box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 1050; }
    .entity-table-section .filterPanelInSection .filter-multiselect-dropdown.open { display: block; }
    .entity-table-section .filterPanelInSection .filter-multiselect-dropdown .form-check { padding: 8px 12px; margin: 0; }
    .entity-table-section .filterPanelInSection .filter-multiselect-dropdown .filter-option-item { display: flex; align-items: center; gap: 8px; }
    .entity-table-section .filterPanelInSection .filter-multiselect-dropdown .filter-multiselect-search-wrap { position: sticky; top: 0; background: var(--bs-body-bg); padding: 8px; border-bottom: 1px solid var(--bs-border-color); z-index: 1; }
    .entity-table-section .filterPanelInSection .filter-multiselect-dropdown .filter-multiselect-search { font-size: 0.85rem; }
    #modalFilter .modal-dialog { max-width: min(560px, 92vw); }
    #modalFilter .modal-content { min-height: 80vh; }
    #modalFilter .modal-body { max-height: calc(80vh - 130px); overflow-y: auto; }
    #modalFilter .filterPanelInSection .filter-row-item { margin-bottom: 10px; }
    #modalFilter .filterPanelInSection .filter-row-item label { font-size: 0.875rem; margin-bottom: 4px; display: block; }
    #modalFilter .filterPanelInSection .filter-multiselect-wrap { position: relative; }
    #modalFilter .filterPanelInSection .filter-multiselect-tags { display: flex; flex-wrap: wrap; gap: 6px; min-height: 38px; padding: 6px 12px; border: 1px solid var(--bs-border-color); border-radius: var(--bs-border-radius); background: var(--bs-body-bg); cursor: pointer; }
    #modalFilter .filterPanelInSection .filter-multiselect-tags .tag { display: inline-flex; align-items: center; gap: 4px; padding: 2px 8px; border-radius: 6px; background: #eaf3ff; color: #35528f; font-size: 0.86rem; }
    #modalFilter .filterPanelInSection .filter-multiselect-tags .tag-remove { cursor: pointer; opacity: 0.7; }
    #modalFilter .filterPanelInSection .filter-multiselect-dropdown { display: none; position: absolute; left: 0; right: 0; top: 100%; margin-top: 2px; max-height: 200px; overflow-y: auto; border: 1px solid var(--bs-border-color); border-radius: var(--bs-border-radius); background: var(--bs-body-bg); box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 1050; }
    #modalFilter .filterPanelInSection .filter-multiselect-dropdown.open { display: block; }
    #modalFilter .filterPanelInSection .filter-multiselect-dropdown .form-check { padding: 8px 12px; margin: 0; }
    #modalFilter .filterPanelInSection .filter-multiselect-dropdown .filter-option-item { display: flex; align-items: center; gap: 8px; }
    #modalFilter .filterPanelInSection .filter-multiselect-dropdown .filter-multiselect-search-wrap { position: sticky; top: 0; background: var(--bs-body-bg); padding: 8px; border-bottom: 1px solid var(--bs-border-color); z-index: 1; }
    #modalFilter .filterPanelInSection .filter-multiselect-dropdown .filter-multiselect-search { font-size: 0.85rem; }
    .entity-table-section .entity-table-grid-wrap { flex: 0 0 auto; width: fit-content; max-width: 100%; min-height: 0; border-radius: 6px;}
    .entity-table-section .entity-table-section-table { width: 100%; margin-bottom: 0; }
    .entity-table-section .entity-table-cell-link { color: var(--bs-primary, #6f6af8); text-decoration: none; max-width: 100%; overflow: hidden; text-overflow: ellipsis; display: inline-block; vertical-align: middle; }
    .entity-table-section .entity-table-cell-link:hover { text-decoration: underline; }
    .entity-table-section .entity-table-grid-wrap td.entity-table-cell-numeric { text-align: right; }
    .entity-insert-grid .insert-grid-cell { min-height: 72px; border: 2px dashed var(--bs-border-color); border-radius: 8px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: border-color .15s, background-color .15s; }
    .entity-insert-grid .insert-grid-cell:hover:not(.disabled) { border-color: var(--bs-primary); background-color: rgba(var(--bs-primary-rgb), 0.06); }
    .entity-insert-grid .insert-grid-cell.disabled { opacity: 0.4; cursor: not-allowed; }
    .entity-insert-grid .insert-grid-cell .cell-placeholder { color: var(--bs-secondary); font-size: 1.25rem; }
    .entity-insert-grid .insert-grid-cell-occupied { border-style: solid; background: rgba(var(--bs-primary-rgb), 0.08); border-color: rgba(var(--bs-primary-rgb), 0.3); }
    .entity-insert-grid .insert-grid-cell-occupied .cell-occupied { font-weight: 600; color: var(--bs-primary); }
    .entity-table-section-readonly .entity-table-toolbar,
    .entity-table-section-readonly .btnFieldsInSection,
    .entity-table-section-readonly .btnDeleteTableInSection,
    .entity-table-section-readonly .searchFilterRowInSection { display: none !important; }
    .entity-table-section-plus-hidden .entity-table-toolbar .btnAddEntityInSection { display: none !important; }
    .entity-table-section-plus-hidden .entity-table-toolbar .entity-table-section-hidden-label { display: none !important; }
    .entity-table-section-hidden .entity-table-toolbar .btnAddEntityInSection { display: none !important; }
    .entity-table-section-hidden .entity-table-toolbar .entity-table-section-hidden-label { display: none !important; }
    .entity-table-section-hidden .entity-table-loading.loadingBlockInSection,
    .entity-table-section-hidden .gridTopRowInSection,
    .entity-table-section-hidden .searchFilterRowInSection,
    .entity-table-section-hidden .filterPanelInSection,
    .entity-table-section-hidden .entity-table-grid-wrap,
    .entity-table-section-hidden .datatable-bottom.paginationBlockInSection { display: none !important; }
    .entity-section-draggable { cursor: grab; }
    .entity-section-draggable:active { cursor: grabbing; }
    /* Force next section to new row when startNewRow is set; responsive: natural wrap still applies */
    .entity-table-row-break { flex-basis: 100%; width: 100%; height: 0; min-height: 0; margin: 0; padding: 0; overflow: hidden; flex-shrink: 0; }
    .entity-table-section.entity-drop-new-row,
    .entity-report-card-section.entity-drop-new-row { position: relative; }
    .entity-table-section.entity-drop-new-row::before,
    .entity-report-card-section.entity-drop-new-row::before { content: ''; position: absolute; left: 0; right: 0; top: 0; bottom: 0; border: 2px dashed var(--bs-primary, #6f6af8); border-radius: 8px; pointer-events: none; }
</style>
{% endblock %}

{% block page_content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-2" id="entityTableAdminToolbar">
                <div class="d-flex align-items-center gap-2 component-modes-admin" id="componentModesAdmin" style="display: none !important;">
                    <label class="small text-muted mb-0">Режим страницы:</label>
                    <select class="form-select form-select-sm" id="pageModeSelect" style="width: auto; min-width: 140px;">
                        <option value="edit">Редактирование</option>
                        <option value="read_only">Только просмотр</option>
                        <option value="hide">Скрыть</option>
                    </select>
                </div>
            </div>
            <div id="entityTablesContainer">
                <!-- Sections (tables/cards) added via + in topbar; drag to reorder -->
                <div id="entityTablesError" class="d-none text-center text-muted py-4 small" role="alert"></div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalEntity" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Добавление таблицы</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body modal-entity-list">
                <div class="d-flex justify-content-end mb-3">
                    <div class="dropdown">
                        <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">Шаблоны</button>
                        <ul class="dropdown-menu dropdown-menu-end" id="templatesDropdown"></ul>
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label" for="tableNameInput">Название таблицы <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="tableNameInput" placeholder="Название таблицы" required>
                </div>
                <div class="mb-3">
                    <label class="form-label" for="tableDescriptionInput">Описание</label>
                    <textarea class="form-control" id="tableDescriptionInput" rows="2" placeholder="Описание"></textarea>
                </div>
                <div class="entity-select-hint col-auto ms-auto bg-primary-subtle p-2 border border-dashed border-primary rounded mb-3 d-flex align-items-center gap-2" role="alert">
                    <span class="entity-select-hint-icon rounded-circle bg-primary text-white d-inline-flex align-items-center justify-content-center">i</span>
                    <span class="text-dark">Выберите <strong>основную сущность</strong> для создания таблицы.</span>
                </div>
                <div id="modalEntityBody" class="entity-list-two-cols"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
                <button type="button" class="btn btn-primary" id="modalEntitySave">Сохранить</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalFields" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Настройка таблицы</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <ul class="nav nav-tabs mb-3" role="tablist">
                    <li class="nav-item">
                        <a class="nav-link active" data-bs-toggle="tab" href="#fieldsTabPane" role="tab">Поля для таблицы</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#settingsTabPane" role="tab">Настройки таблицы</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#customFieldTabPane" role="tab">Кастомные поля</a>
                    </li>
                </ul>
                <div class="tab-content">
                    <div class="tab-pane active" id="fieldsTabPane" role="tabpanel">
                        <div class="d-flex flex-wrap align-items-center gap-2 mb-3">
                            <div id="nestedCheckboxesRow" class="d-flex flex-wrap gap-2 align-items-center"></div>
                            <div class="flex-grow-1" style="min-width: 150px; max-width: 250px;">
                                <div class="input-group input-group-sm">
                                    <input type="text" class="form-control" id="fieldsSearchInput" placeholder="Поиск полей" autocomplete="off">
                                </div>
                            </div>
                        </div>
                        <button type="button" class="btn btn-sm btn-outline-primary d-none mb-2" id="toggleCustomFieldsInFieldsTabBtn">Кастомные поля</button>
                        <div class="fields-modal-grid" id="fieldsList"></div>
                        <div class="mt-3 d-none" id="customFieldsSectionInFieldsTab">
                            <div id="customFieldsListInFieldsTab" class="fields-modal-grid"></div>
                        </div>
                    </div>
                    <div class="tab-pane" id="settingsTabPane" role="tabpanel">
                        <div class="mb-3">
                            <label class="form-label text-muted small">Сущность таблицы</label>
                            <p class="mb-0 small" id="settingsModalEntityLabel">—</p>
                        </div>
                        <div class="mb-3">
                            <label class="form-label" for="settingsModalTableDescription">Описание таблицы</label>
                            <textarea class="form-control" id="settingsModalTableDescription" rows="2" placeholder="Описание таблицы"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label" for="tableStyleSelect">Стиль таблицы</label>
                            <select class="form-select" id="tableStyleSelect">
                                <option value="default">Default</option>
                                <option value="customers_details">Customers Details</option>
                                <option value="basic_example">Basic Example</option>
                                <option value="striped_rows">Striped Rows</option>
                                <option value="hoverable_rows">Hoverable Rows</option>
                                <option value="contextual_classes">Contextual Classes</option>
                                <option value="captions_table">Captions Table</option>
                                <option value="small_table">Small Table</option>
                                <option value="dark_table">Dark Table</option>
                                <option value="table_head_options">Table Head Options</option>
                                <option value="bordered_table">Bordered Table</option>
                            </select>
                        </div>
                        <div class="mt-4 pt-3 border-top">
                            <button type="button" class="btn btn-outline-danger btn-sm" id="settingsModalDeleteTableBtn" title="Удалить таблицу" aria-label="Удалить таблицу">
                                <i class="iconoir-trash"></i> Удалить таблицу
                            </button>
                        </div>
                    </div>
                    <div class="tab-pane" id="customFieldTabPane" role="tabpanel">
                        <div class="row g-3">
                            <div class="col-12">
                                <label class="form-label text-muted small">Сущность таблицы</label>
                                <p class="mb-0 small" id="customFieldEntityLabel">—</p>
                            </div>
                            <div class="col-12">
                                <label class="form-label" for="customFieldNameInput">Название поля</label>
                                <input type="text" class="form-control" id="customFieldNameInput" placeholder="Введите название поля">
                            </div>
                            <div class="col-12 col-md-6">
                                <label class="form-label" for="customFieldCodeInput">Код поле</label>
                                <input type="text" class="form-control" id="customFieldCodeInput" placeholder="Например: custom_field_code">
                            </div>
                            <div class="col-12 col-md-6">
                                <label class="form-label" for="customFieldDescriptionInput">Описание</label>
                                <input type="text" class="form-control" id="customFieldDescriptionInput" placeholder="Краткое описание">
                            </div>
                            <div class="col-12 col-md-6">
                                <label class="form-label" for="customFieldTypeSelect">Тип</label>
                                <select class="form-select" id="customFieldTypeSelect">
                                    <option value="single">Общее значение</option>
                                    <option value="card">Card</option>
                                </select>
                            </div>
                            <div class="col-12">
                                <div class="d-flex align-items-center gap-2">
                                    <label class="form-label mb-0" for="customFieldPayloadTextarea">Editor</label>
                                    <button
                                            type="button"
                                            class="btn btn-sm btn-outline-secondary rounded-circle d-inline-flex align-items-center justify-content-center"
                                            id="customFieldEditorHelpBtn"
                                            style="width: 24px; height: 24px; padding: 0;"
                                            data-bs-toggle="tooltip"
                                            data-bs-placement="top"
                                            data-bs-html="true"
                                            title="<div class='text-start'><div><b>Как пользоваться:</b></div><div>1) Нажмите <b>...</b> и вставьте поля</div><div>2) Напишите формулу в Editor</div><div>3) Нажмите <b>Проверить</b> (локально) или <b>Пересчитать</b> (записать в БД)</div><hr class='my-1'><div><b>Токены:</b> {Сущность.Поле}</div><div><b>Агрегаты:</b> COUNT(), SUM(...), AVG(...), MIN(...), MAX(...)</div><div><b>Функции:</b> CONCAT, UPPER, LOWER, IFNULL, COALESCE, LEN, NUMBER, ROUND</div><div><b>Пример:</b> ROUND(AVG({Vânzări realizare.Сумма}), 2)</div><div><b>Важно:</b> локальный расчет идет по загруженным строкам текущей таблицы</div><div><b>Важно (server row_wise):</b> пока только поля target entity (другие сущности дадут ошибку)</div></div>"
                                            aria-label="Шпаргалка по Editor"
                                    >i</button>
                                </div>
                                <div class="d-flex align-items-end gap-2">
                                    <textarea class="form-control flex-grow-1" id="customFieldPayloadTextarea" rows="6" placeholder="Форма и логика SQL"></textarea>
                                    <button type="button" class="btn btn-outline-primary flex-shrink-0" id="customFieldActionBtn" aria-label="Дополнительно">...</button>
                                </div>
                                <div class="d-flex justify-content-end gap-2 mt-2">
                                    <button type="button" class="btn btn-outline-secondary btn-sm" id="customFieldPreviewBtn">Проверить</button>
                                    <button type="button" class="btn btn-outline-primary btn-sm" id="customFieldEditOpenBtn">Редактировать</button>
                                    <button type="button" class="btn btn-outline-warning btn-sm" id="customFieldRecalcOpenBtn">Пересчитать</button>
                                    <button type="button" class="btn btn-danger btn-sm" id="customFieldDeleteOpenBtn">Удалить поле</button>
                                    <button type="button" class="btn btn-primary btn-sm" id="customFieldSaveBtn">Сохранить кастомное поле</button>
                                </div>
                                <div class="small text-primary mt-1 d-none" id="customFieldEditModeHint"></div>
                                <div class="small text-secondary mt-1 d-none" id="customFieldEditorReadableHint"></div>
                                <div class="small text-muted mt-2" id="customFieldPreviewResult"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-primary" id="modalFieldsSave">Сохранить</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="customFieldEditModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Редактировать кастомное поле</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="small text-muted mb-2">Выберите поле для редактирования</div>
                <div id="customFieldEditList" class="d-flex flex-column gap-2"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-primary" id="customFieldEditConfirmBtn">Открыть в форме</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="customFieldRecalcModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Пересчитать кастомное поле</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="small text-muted mb-2">Выберите поле для пересчета</div>
                <div id="customFieldRecalcList" class="d-flex flex-column gap-2"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-warning" id="customFieldRecalcConfirmBtn">Пересчитать</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="customFieldDeleteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Удалить кастомное поле</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="small text-muted mb-2">Выберите поле для удаления</div>
                <div id="customFieldDeleteList" class="d-flex flex-column gap-2"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-danger" id="customFieldDeleteConfirmBtn">Удалить</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalFilter" tabindex="-1">
    <div class="modal-dialog modal-dialog-scrollable modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Фильтр + поиск</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body filterPanelInSection">
                <div id="filterModalRowsContainer"></div>
                <a href="javascript:void(0)" class="addFilterFieldInModal text-primary small mt-2 d-inline-block" id="addFilterFieldInModal">Добавить поле</a>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
                <button type="button" class="btn btn-primary" id="modalFilterSave">Сохранить</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalCustomFieldPicker" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Выбор полей для Editor</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <input type="text" class="form-control form-control-sm" id="customFieldPickerSearchInput" placeholder="Поиск полей">
                </div>
                <div class="d-flex flex-wrap align-items-center gap-2 mb-3">
                    <div id="customFieldPickerNestedRow" class="d-flex flex-wrap gap-2 align-items-center"></div>
                </div>
                <div id="customFieldPickerList" class="fields-modal-grid"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-primary" id="customFieldPickerInsertBtn">Вставить</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalAddTableOrCard" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-sm">
        <div class="modal-content">
            <div class="modal-header border-0 pb-3">
                <h5 class="modal-title">Добавить визуал</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body pt-3">
                <div class="d-grid gap-2">
                    <button type="button" class="btn btn-outline-primary btn-add-choice py-3 d-flex align-items-center justify-content-center gap-2" id="btnChoiceTable" data-choice="table">
                        <i class="iconoir-list fs-4"></i>
                        <span>Таблицу</span>
                    </button>
                    <button type="button" class="btn btn-outline-secondary btn-add-choice py-3 d-flex align-items-center justify-content-center gap-2" id="btnChoiceCard" data-choice="card">
                        <i class="iconoir-report-columns fs-4"></i>
                        <span>Карточку</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalInsertTableGrid" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Куда вставить новую таблицу?</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="text-muted small mb-3">Выберите ячейку сетки — новая таблица появится в выбранной позиции.</p>
                <div id="insertTableGrid" class="entity-insert-grid row g-2" style="max-width: 320px;">
                    <!-- 3×3: ячейки с data-insert-index="0".."8" подставляются скриптом -->
                </div>
            </div>
        </div>
    </div>
</div>

{% include 'partials/entity_card_modal.html' %}

{% endblock %}

{% block javascripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        var PAGE_SLUG = '{% if page_slug is defined %}{{ page_slug }}{% else %}__PAGE_SLUG__{% endif %}';
        var pathMatch = window.location.pathname.match(/^\/([^\/]+)/);
        if (pathMatch && pathMatch[1] && (PAGE_SLUG === '__PAGE_SLUG__' || !PAGE_SLUG)) {
            PAGE_SLUG = pathMatch[1];
        }
        if (PAGE_SLUG === '__PAGE_SLUG__' || !PAGE_SLUG) {
            PAGE_SLUG = 'entity-table';
        }
        const API = {
            processesDeals: '/api/entity-table/processes-deals/',
            dealCategories: '/api/entity-table/deal-categories/',
            metaFields: '/api/entity-table/entity-meta-fields/',
            metaData: '/api/entity-table/entity-meta-data/',
            config: '/api/entity-table/config',
            customFields: '/api/entity-table/custom-fields',
            customFieldsPreview: '/api/entity-table/custom-fields/preview',
            templates: '/api/entity-table/templates',
            componentModes: '/api/entity-table/component-modes',
        };

        var isReadOnly = false;
        var currentPageMode = 'edit';
        var currentTableModes = {};
        var DASHBOARD_HIDE_CLASS = 'dashboard-toolbar-hidden';
        function applyReadOnlyMode() {
            var hide = isGuestUser();
            var toolbar = document.getElementById('entityTableAdminToolbar');
            if (toolbar) {
                if (hide) {
                    toolbar.style.setProperty('display', 'none', 'important');
                    toolbar.classList.add(DASHBOARD_HIDE_CLASS);
                } else {
                    toolbar.classList.remove(DASHBOARD_HIDE_CLASS);
                    toolbar.style.display = '';
                }
            }
            var topbarWrap = document.getElementById('topbarBtnAddEntityWrap');
            if (topbarWrap) { if (hide) { topbarWrap.style.setProperty('display', 'none', 'important'); topbarWrap.classList.add(DASHBOARD_HIDE_CLASS); } else { topbarWrap.classList.remove(DASHBOARD_HIDE_CLASS); topbarWrap.style.display = ''; } }
            if (entityTablesContainer) {
                entityTablesContainer.querySelectorAll('.btnAddEntityInSection, .btnFieldsInSection, .btnDeleteTableInSection, .btn-search-filter-gear').forEach(function(el) {
                    if (hide) { el.style.setProperty('display', 'none', 'important'); el.classList.add(DASHBOARD_HIDE_CLASS); } else { el.classList.remove(DASHBOARD_HIDE_CLASS); el.style.display = ''; }
                });
            }
        }
        function isDashboardSlug() {
            return (String(PAGE_SLUG || '').toLowerCase().indexOf('dash-') === 0);
        }
        function isGuestUser() {
            try { return !localStorage.getItem('auth_user_id'); } catch (e) { return true; }
        }

        function applyTableModes(tableModes) {
            /* Заглушка: правила режимов таблиц не влияют на интерфейс; только гость/админ определяют readonly */
            if (!entityTablesContainer) return;
            entityTablesContainer.querySelectorAll('.entity-table-section').forEach(function(section) {
                section.classList.remove('entity-table-section-readonly', 'entity-table-section-hidden', 'entity-table-section-plus-hidden');
                section.style.removeProperty('display');
            });
        }

        function applyPageMode(pageMode) {
            /* Заглушка: режим страницы не влияет на интерфейс; только гость/админ определяют readonly */
            var container = document.getElementById('entityTablesContainer');
            var wrapper = container && container.closest('.row');
            if (wrapper) wrapper.style.removeProperty('display');
        }

        function renderComponentModesAdmin() {
            if (isGuestUser()) return;
            /* Заглушка: блоки режимов скрыты в UI (CSS), логика ниже сохранена для возможного повторного включения */
            var adminEl = document.getElementById('componentModesAdmin');
            if (adminEl) { /* adminEl.style.setProperty('display', 'flex', 'important'); */ }
            var pageSelect = document.getElementById('pageModeSelect');
            if (pageSelect) pageSelect.value = currentPageMode;
            entityTablesContainer && entityTablesContainer.querySelectorAll('.tableModeSelect').forEach(function(sel) {
                var idx = sel.getAttribute('data-table-index');
                sel.value = currentTableModes[idx] || currentTableModes[String(idx)] || 'edit';
                var wrap = sel.closest('.table-mode-admin');
                if (wrap) { /* wrap.style.setProperty('display', 'block', 'important'); — скрыто заглушкой */ }
            });
        }

        function saveComponentModesPageMode(mode) {
            currentPageMode = (mode || 'edit').toLowerCase();
            fetch(API.componentModes, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ page_modes: { [getPageSlug()]: currentPageMode } })
            }).then(function() {
                isReadOnly = isGuestUser();
                applyPageMode(currentPageMode);
                applyReadOnlyMode();
            }).catch(function() {});
        }

        function saveComponentModesTableMode(tableIndex, mode) {
            currentTableModes[String(tableIndex)] = (mode || 'edit').toLowerCase();
            var payload = {};
            payload[getPageSlug()] = currentTableModes;
            fetch(API.componentModes, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ table_modes: payload })
            }).then(function() { applyTableModes(currentTableModes); }).catch(function() {});
        }

        var componentModesBound = false;
        function bindComponentModesListeners() {
            if (isGuestUser() || componentModesBound) return;
            componentModesBound = true;
            var pageSelect = document.getElementById('pageModeSelect');
            if (pageSelect) pageSelect.addEventListener('change', function() { saveComponentModesPageMode(this.value); });
            if (entityTablesContainer) entityTablesContainer.addEventListener('change', function(e) {
                if (!e.target || !e.target.classList.contains('tableModeSelect')) return;
                var idx = e.target.getAttribute('data-table-index');
                saveComponentModesTableMode(idx, e.target.value);
            });
        }

        /** Table style mapping: Dastone tables-basic / tables-datatable classes */
        var TABLE_STYLES = {
            default: { tableClass: 'table table-sm border-dashed', theadClass: 'table-light', caption: false },
            customers_details: { tableClass: 'table table-centered mb-0', theadClass: 'table-light', caption: false },
            basic_example: { tableClass: 'table mb-0 table-centered', theadClass: 'table-light', caption: false },
            striped_rows: { tableClass: 'table table-striped mb-0', theadClass: 'table-light', caption: false },
            hoverable_rows: { tableClass: 'table table-hover mb-0', theadClass: 'table-light', caption: false },
            contextual_classes: { tableClass: 'table mb-0 table-contextual-rows', theadClass: 'table-light', caption: false },
            captions_table: { tableClass: 'table mb-0', theadClass: 'table-light', caption: true },
            small_table: { tableClass: 'table table-sm mb-0', theadClass: 'table-light', caption: false },
            dark_table: { tableClass: 'table table-dark mb-0', theadClass: '', caption: false },
            table_head_options: { tableClass: 'table mb-0', theadClass: 'table-light', caption: false },
            bordered_table: { tableClass: 'table table-bordered mb-0 table-centered', theadClass: '', caption: false }
        };

        function defaultTableState() {
            return {
                type: 'table',
                selectedEntities: [],
                selectedFields: [],
                tableTitle: '',
                tableDescription: '',
                tableStyle: 'hoverable_rows',
                fullData: [],
                allColumns: [],
                currentPage: 1,
                pageSize: 25,
                columnWidths: {},
                sortKey: '',
                sortDir: '',
                showTime: false,
                dateTimeDisplayByColumn: {},
                guestFilterInitialized: false,
                filterFields: [{ label: 'Название', key: '', type: 'text' }],
                customFields: [],
                selectedCustomFieldCodes: [],
                customFieldTokenMap: {},
                startNewRow: false
            };
        }

        /** Report card: title, main value (formula), secondary value (formula), icon. Same entities/fields/filters as tables. */
        var CARD_AGGREGATES = [
            { value: 'count', label: 'Количество записей' },
            { value: 'sum', label: 'Сумма' },
            { value: 'avg', label: 'Среднее' },
            { value: 'min', label: 'Минимум' },
            { value: 'max', label: 'Максимум' }
        ];
        var REPORT_CARD_ICONS = ['iconoir-activity', 'iconoir-handbag', 'iconoir-clock', 'iconoir-user', 'iconoir-dollar-circle', 'iconoir-report-columns', 'iconoir-reports-solid', 'iconoir-trophy', 'iconoir-chat-bubble', 'iconoir-mail', 'iconoir-fire-flame', 'iconoir-suitcase', 'iconoir-bell', 'iconoir-calendar', 'iconoir-list', 'iconoir-candlestick-chart', 'iconoir-map-pin', 'iconoir-send-mail', 'iconoir-page-star', 'iconoir-heart-solid'];
        function defaultCardState() {
            return {
                type: 'card',
                cardTitle: '',
                icon: 'iconoir-activity',
                selectedEntities: [],
                selectedFields: [],
                filterFields: [{ label: 'Название', key: '', type: 'text' }],
                mainFormula: { aggregate: 'count', fieldKey: null },
                secondaryFormula: { aggregate: 'count', fieldKey: null, label: '' },
                fullData: [],
                startNewRow: false
            };
        }

        function isConfiguredSectionState(st) {
            return !!(st && Array.isArray(st.selectedEntities) && st.selectedEntities.length > 0);
        }

        let tableStates = [];
        let currentTableIndex = 0;
        let entitiesList = [];
        let fieldsCache = {};
        let guestConfigRefreshTimer = null;
        let lastRemoteConfigSignature = '';
        let fieldsModalForCustomEditorInsert = false;
        let customFieldEditingId = null;

        const entityTablesContainer = document.getElementById('entityTablesContainer');
        isReadOnly = isGuestUser();
        applyReadOnlyMode();
        const modalEntity = new bootstrap.Modal(document.getElementById('modalEntity'));
        const modalEntityBody = document.getElementById('modalEntityBody');
        const modalEntitySave = document.getElementById('modalEntitySave');
        const modalFields = new bootstrap.Modal(document.getElementById('modalFields'));
        const modalFieldsEl = document.getElementById('modalFields');
        const modalFilter = new bootstrap.Modal(document.getElementById('modalFilter'));
        const filterModalRowsContainerEl = document.getElementById('filterModalRowsContainer');
        const modalCustomFieldPickerEl = document.getElementById('modalCustomFieldPicker');
        const modalCustomFieldPicker = modalCustomFieldPickerEl ? new bootstrap.Modal(modalCustomFieldPickerEl) : null;
        const customFieldPickerList = document.getElementById('customFieldPickerList');
        const customFieldPickerSearchInput = document.getElementById('customFieldPickerSearchInput');
        const customFieldPickerInsertBtn = document.getElementById('customFieldPickerInsertBtn');
        const customFieldPickerNestedRow = document.getElementById('customFieldPickerNestedRow');
        const customFieldPayloadTextarea = document.getElementById('customFieldPayloadTextarea');
        const customFieldActionBtn = document.getElementById('customFieldActionBtn');
        const customFieldNameInput = document.getElementById('customFieldNameInput');
        const customFieldCodeInput = document.getElementById('customFieldCodeInput');
        const customFieldDescriptionInput = document.getElementById('customFieldDescriptionInput');
        const customFieldTypeSelect = document.getElementById('customFieldTypeSelect');
        const customFieldSaveBtn = document.getElementById('customFieldSaveBtn');
        const customFieldEditOpenBtn = document.getElementById('customFieldEditOpenBtn');
        const customFieldRecalcOpenBtn = document.getElementById('customFieldRecalcOpenBtn');
        const customFieldDeleteOpenBtn = document.getElementById('customFieldDeleteOpenBtn');
        const customFieldEditorHelpBtn = document.getElementById('customFieldEditorHelpBtn');
        const customFieldEditModeHint = document.getElementById('customFieldEditModeHint');
        const customFieldEditorReadableHint = document.getElementById('customFieldEditorReadableHint');
        const customFieldPreviewBtn = document.getElementById('customFieldPreviewBtn');
        const customFieldPreviewResult = document.getElementById('customFieldPreviewResult');
        const customFieldEditModalEl = document.getElementById('customFieldEditModal');
        const customFieldEditList = document.getElementById('customFieldEditList');
        const customFieldEditConfirmBtn = document.getElementById('customFieldEditConfirmBtn');
        const customFieldRecalcModalEl = document.getElementById('customFieldRecalcModal');
        const customFieldRecalcList = document.getElementById('customFieldRecalcList');
        const customFieldRecalcConfirmBtn = document.getElementById('customFieldRecalcConfirmBtn');
        const customFieldDeleteModalEl = document.getElementById('customFieldDeleteModal');
        const customFieldDeleteList = document.getElementById('customFieldDeleteList');
        const customFieldDeleteConfirmBtn = document.getElementById('customFieldDeleteConfirmBtn');
        const customFieldEditModal = customFieldEditModalEl ? new bootstrap.Modal(customFieldEditModalEl) : null;
        const customFieldRecalcModal = customFieldRecalcModalEl ? new bootstrap.Modal(customFieldRecalcModalEl) : null;
        const customFieldDeleteModal = customFieldDeleteModalEl ? new bootstrap.Modal(customFieldDeleteModalEl) : null;
        const toggleCustomFieldsInFieldsTabBtn = document.getElementById('toggleCustomFieldsInFieldsTabBtn');
        const customFieldsSectionInFieldsTab = document.getElementById('customFieldsSectionInFieldsTab');
        const customFieldsListInFieldsTab = document.getElementById('customFieldsListInFieldsTab');
        const fieldsList = document.getElementById('fieldsList');
        const modalFieldsSave = document.getElementById('modalFieldsSave');
        const nestedCheckboxesRow = document.getElementById('nestedCheckboxesRow');

        if (modalFieldsEl) {
            modalFieldsEl.addEventListener('hidden.bs.modal', function() {
                fieldsModalForFilterTableIndex = null;
                fieldsModalForFilterSource = null;
                fieldsModalForCustomEditorInsert = false;
                modalFieldsEl.classList.remove('modal-parent-hidden');
                modalFieldsEl.removeAttribute('data-custom-editor-mode');
                setCustomFieldFormMode(null);
            });
        }

        if (modalCustomFieldPickerEl && modalFieldsEl) {
            modalCustomFieldPickerEl.addEventListener('show.bs.modal', function() {
                if (modalFieldsEl.classList.contains('show')) {
                    modalFieldsEl.classList.add('modal-parent-hidden');
                }
            });
            modalCustomFieldPickerEl.addEventListener('hidden.bs.modal', function() {
                modalFieldsEl.classList.remove('modal-parent-hidden');
            });
        }

        function ensureCustomFieldsArray(st) {
            if (!st) return [];
            if (!Array.isArray(st.customFields)) st.customFields = [];
            return st.customFields;
        }
        function normalizeCustomFieldCodeInputValue(raw, fallbackName) {
            var code = String(raw || '').trim();
            if (!code && fallbackName) code = String(fallbackName || '').trim();
            code = code.toLowerCase();
            code = code.replace(/\s+/g, '_').replace(/[^a-z0-9_]/g, '_').replace(/_+/g, '_').replace(/^_+|_+$/g, '');
            if (!code) code = String(Date.now());
            if (code.indexOf('custom_') !== 0) code = 'custom_' + code.replace(/^_+/, '');
            return code;
        }
        function ensureSelectedCustomFieldCodes(st) {
            if (!st) return [];
            if (!Array.isArray(st.selectedCustomFieldCodes)) st.selectedCustomFieldCodes = [];
            return st.selectedCustomFieldCodes;
        }
        function ensureCustomFieldTokenMap(st) {
            if (!st) return {};
            if (!st.customFieldTokenMap || typeof st.customFieldTokenMap !== 'object') st.customFieldTokenMap = {};
            return st.customFieldTokenMap;
        }
        function ensureCustomFieldTokenRelationMap(st) {
            if (!st) return {};
            if (!st.customFieldTokenRelationMap || typeof st.customFieldTokenRelationMap !== 'object') st.customFieldTokenRelationMap = {};
            return st.customFieldTokenRelationMap;
        }
        function resolveColumnKeyForEditorTokenInsert(st, title, prefixKey, rowEntityKey, nestedType) {
            if (!st || !Array.isArray(st.allColumns)) return '';
            var normTitle = normalizeSearchText(title || '');
            var normPrefix = normalizeSearchText(prefixKey || '');
            var normRowEk = String(rowEntityKey || '').trim();
            var cols = st.allColumns || [];
            var exact = cols.find(function(col) {
                return col && normalizeSearchText(col.label || '') === normTitle
                    && (!normPrefix || normalizeSearchText(col.entityTitle || '') === normPrefix);
            });
            if (exact && exact.key) return exact.key;
            if (!nestedType && normRowEk) {
                var mainMatch = cols.find(function(col) {
                    return col && String(col.entityKey || '') === normRowEk
                        && normalizeSearchText(col.label || '') === normTitle;
                });
                if (mainMatch && mainMatch.key) return mainMatch.key;
            }
            if (nestedType && normPrefix) {
                var nestedMatch = cols.find(function(col) {
                    return col && normalizeSearchText(col.label || '') === normTitle
                        && normalizeSearchText(col.entityTitle || '') === normPrefix;
                });
                if (nestedMatch && nestedMatch.key) return nestedMatch.key;
            }
            return '';
        }

        function customFieldApiEntityPayload(ent) {
            if (!ent) return null;
            return {
                entity_key: entityKey(ent),
                type: ent.type || '',
                category_id: (ent.category_id != null && ent.category_id !== '') ? Number(ent.category_id) : null,
                title: ent.title || ent.name || ent.type || ''
            };
        }

        function loadCustomFieldsForTable(tableIndex) {
            var st = tableStates[tableIndex];
            if (!st) return Promise.resolve([]);
            if (!Array.isArray(st.selectedEntities) || !st.selectedEntities.length) {
                st.customFields = [];
                renderCustomFieldsInFieldsTab(tableIndex);
                return Promise.resolve([]);
            }
            var url = API.customFields
                + '?page_slug=' + encodeURIComponent(getPageSlug())
                + '&table_index=' + encodeURIComponent(String(tableIndex));
            return fetch(url, { method: 'GET' })
                .then(function(r) {
                    return r.json().catch(function() { return { ok: false, error: 'Invalid response' }; })
                        .then(function(body) { return { ok: r.ok, body: body, status: r.status }; });
                })
                .then(function(res) {
                    if (!res.ok || !res.body || res.body.ok === false) {
                        throw new Error((res.body && (res.body.error || res.body.detail)) || ('Load failed: ' + res.status));
                    }
                    st.customFields = Array.isArray(res.body.items) ? res.body.items : [];
                    renderCustomFieldsInFieldsTab(tableIndex);
                    return st.customFields;
                })
                .catch(function(err) {
                    if (typeof console !== 'undefined' && console.error) console.error('Custom fields load:', err);
                    return [];
                });
        }

        function createCustomFieldViaApi(tableIndex, payload) {
            return fetch(API.customFields, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            }).then(function(r) {
                return r.json().catch(function() { return { ok: false, error: 'Invalid response' }; })
                    .then(function(body) { return { ok: r.ok, body: body, status: r.status }; });
            }).then(function(res) {
                if (!res.ok || !res.body || res.body.ok === false) {
                    var msg = (res.body && (res.body.detail || res.body.error)) || ('Save failed: ' + res.status);
                    var err = new Error(msg);
                    err.status = res.status;
                    throw err;
                }
                return res.body.custom_field || null;
            });
        }
        function updateCustomFieldViaApi(id, payload, method) {
            return fetch(API.customFields + '/' + encodeURIComponent(String(id)), {
                method: (method || 'PATCH'),
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload || {})
            }).then(function(r) {
                return r.json().catch(function() { return { ok: false, error: 'Invalid response' }; })
                    .then(function(body) { return { ok: r.ok, body: body, status: r.status }; });
            }).then(function(res) {
                if (!res.ok || !res.body || res.body.ok === false) {
                    var msg = (res.body && (res.body.detail || res.body.error)) || ('Update failed: ' + res.status);
                    throw new Error(msg);
                }
                return res.body.custom_field || null;
            });
        }

        function deleteCustomFieldViaApi(id) {
            return fetch(API.customFields + '/' + encodeURIComponent(String(id)), {
                method: 'DELETE'
            }).then(function(r) {
                return r.json().catch(function() { return { ok: false, error: 'Invalid response' }; })
                    .then(function(body) { return { ok: r.ok, body: body, status: r.status }; });
            }).then(function(res) {
                if (!res.ok || !res.body || res.body.ok === false) {
                    throw new Error((res.body && (res.body.detail || res.body.error)) || ('Delete failed: ' + res.status));
                }
                return true;
            });
        }
        function recalculateCustomFieldViaApi(id) {
            return fetch(API.customFields + '/' + encodeURIComponent(String(id)) + '/recalculate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({})
            }).then(function(r) {
                return r.json().catch(function() { return { ok: false, error: 'Invalid response' }; })
                    .then(function(body) { return { ok: r.ok, body: body, status: r.status }; });
            }).then(function(res) {
                if (!res.ok || !res.body || res.body.ok === false) {
                    throw new Error((res.body && (res.body.detail || res.body.error)) || ('Recalculate failed: ' + res.status));
                }
                return res.body;
            });
        }
        function splitEditorTokenModeSuffix(tokenBody) {
            var raw = String(tokenBody || '');
            var m = raw.match(/^(.*?)(:(raw|display))$/i);
            if (!m) return { core: raw, suffix: '' };
            return { core: m[1] || '', suffix: m[2] || '' };
        }
        function normalizeTechnicalNestedEntityKeyForEditor(rawKey) {
            var k = String(rawKey || '').trim();
            if (!k) return '';
            var m = k.match(/^sp:(\d+)$/i);
            if (m) return 'smart_process_' + m[1];
            return k;
        }
        function buildLegacyNestedTokenReplacementMap(tableIndex) {
            return buildCustomFieldTokenDescriptorCatalog(tableIndex).then(function(catalog) {
                var map = {};
                Object.keys((catalog && catalog.byLegacy) || {}).forEach(function(k) {
                    var d = catalog.byLegacy[k];
                    if (!d || !d.tech_body) return;
                    if (!map[k]) map[k] = d.tech_body;
                });
                return map;
            });
        }
        function normalizeCustomFieldEditorForBackend(tableIndex, editorText) {
            var editor = String(editorText || '');
            if (!editor || editor.indexOf('{') < 0) return Promise.resolve(editor);
            return buildLegacyNestedTokenReplacementMap(tableIndex).then(function(replMap) {
                if (!replMap || !Object.keys(replMap).length) return editor;
                return editor.replace(/\{([^}]+)\}/g, function(full, tokenBody) {
                    var parts = splitEditorTokenModeSuffix(tokenBody);
                    var core = String(parts.core || '').trim();
                    if (!core) return full;
                    if (core.indexOf('|') >= 0) {
                        var seg = core.split('|');
                        if (seg.length === 3) {
                            seg[1] = normalizeTechnicalNestedEntityKeyForEditor(seg[1]);
                            return '{' + seg.join('|') + (parts.suffix || '') + '}';
                        }
                        return full;
                    }
                    var next = replMap[core];
                    if (!next) return full;
                    return '{' + next + (parts.suffix || '') + '}';
                });
            });
        }
        function normalizeTechEntityKeyComparable(rawKey) {
            var k = String(rawKey || '').trim().toLowerCase();
            if (!k) return '';
            var sp1 = k.match(/^sp:(\d+)$/);
            if (sp1) return 'smart_process_' + sp1[1];
            var sp2 = k.match(/^entity_(\d+)$/);
            if (sp2) return 'smart_process_' + sp2[1];
            return k;
        }
        function buildCustomFieldTokenDescriptorCatalog(tableIndex) {
            var st = tableStates[tableIndex];
            if (!st || !Array.isArray(st.selectedEntities) || !st.selectedEntities.length) {
                return Promise.resolve({ descriptors: [], byLegacy: {}, byTech: {} });
            }
            return Promise.all((st.selectedEntities || []).map(function(ent) {
                return loadFieldsForEntity(ent)
                    .then(function(res) { return { ent: ent, res: res || { fields: [] } }; })
                    .catch(function() { return { ent: ent, res: { fields: [] } }; });
            })).then(function(items) {
                var catalog = { descriptors: [], byLegacy: {}, byTech: {} };
                function registerDescriptor(desc) {
                    if (!desc) return;
                    catalog.descriptors.push(desc);
                    var techKey = String(desc.tech_key || '').trim();
                    if (techKey && !catalog.byTech[techKey]) catalog.byTech[techKey] = desc;
                    (desc.legacy_keys || []).forEach(function(k) {
                        if (!k) return;
                        if (!catalog.byLegacy[k]) catalog.byLegacy[k] = desc;
                    });
                }
                items.forEach(function(item) {
                    var ent = item.ent || {};
                    var parentEntityKey = String(entityKey(ent) || '').trim();
                    if (!parentEntityKey) return;
                    var parentTitle = String((ent && ent.title) || entityTitleForNested(ent) || parentEntityKey).trim();
                    var parentTitles = [
                        String((ent && ent.title) || '').trim(),
                        String(entityTitleForNested(ent) || '').trim(),
                        parentTitle
                    ].filter(Boolean).filter(function(v, i, arr) { return arr.indexOf(v) === i; });
                    (item.res.fields || []).forEach(function(f) {
                        if (!f) return;
                        var groupLabel = String((f.human_title || f.column_name || '')).trim();
                        if (Array.isArray(f.nested_fields) && f.nested_fields.length && groupLabel) {
                            var nestedRaw = String(f.nested_entity_key || '').trim();
                            var nestedNorm = normalizeTechEntityKeyComparable(f.nested_entity_key);
                            var nestedAliases = [nestedRaw, normalizeTechnicalNestedEntityKeyForEditor(f.nested_entity_key), nestedNorm]
                                .map(function(v) { return String(v || '').trim(); })
                                .filter(Boolean)
                                .filter(function(v, i, arr) { return arr.indexOf(v) === i; });
                            var relFieldCode = String(f.field_code || f.b24_field || f.column_name || '').trim();
                            var relB24Field = String(f.b24_field || '').trim();
                            var relColumnName = String(f.column_name || '').trim();
                            (f.nested_fields || []).forEach(function(n) {
                                var fieldCode = String((n && (n.field_code || n.b24_field || n.column_name) || '')).trim();
                                var fieldLabel = String((n && (n.human_title || n.column_name) || '')).trim();
                                if (!fieldCode || !fieldLabel) return;
                                var legacyKeys = [];
                                parentTitles.forEach(function(pt) { legacyKeys.push(pt + '.' + groupLabel + '.' + fieldLabel); });
                                nestedAliases.forEach(function(nk) {
                                    var nkNorm = normalizeTechEntityKeyComparable(nk);
                                    registerDescriptor({
                                        parent_entity_key: parentEntityKey,
                                        parent_title: parentTitle,
                                        nested_entity_key_raw: nestedRaw,
                                        nested_entity_key: nk,
                                        nested_entity_key_norm: nkNorm,
                                        field_code: fieldCode,
                                        field_label: fieldLabel,
                                        group_label: groupLabel,
                                        is_nested: true,
                                        legacy_keys: legacyKeys.slice(),
                                        readable_label: parentTitle + '.' + groupLabel + '.' + fieldLabel,
                                        relation_field_code: relFieldCode || relB24Field || relColumnName,
                                        relation_b24_field: relB24Field || relFieldCode || '',
                                        relation_column_name: relColumnName || '',
                                        tech_body: parentEntityKey + '|' + nk + '|' + fieldCode,
                                        tech_key: parentEntityKey + '|' + nkNorm + '|' + String(fieldCode).toLowerCase()
                                    });
                                });
                            });
                            return;
                        }
                        var topFieldCode = String((f.field_code || f.b24_field || f.column_name || '')).trim();
                        var topFieldLabel = String((f.human_title || f.column_name || '')).trim();
                        if (!topFieldCode || !topFieldLabel) return;
                        var topLegacy = [];
                        parentTitles.forEach(function(pt) { topLegacy.push(pt + '.' + topFieldLabel); });
                        registerDescriptor({
                            parent_entity_key: parentEntityKey,
                            parent_title: parentTitle,
                            nested_entity_key_raw: '',
                            nested_entity_key: '',
                            nested_entity_key_norm: '',
                            field_code: topFieldCode,
                            field_label: topFieldLabel,
                            group_label: '',
                            is_nested: false,
                            legacy_keys: topLegacy,
                            readable_label: parentTitle + '.' + topFieldLabel,
                            relation_field_code: '',
                            relation_b24_field: '',
                            relation_column_name: '',
                            tech_body: parentEntityKey + '||' + topFieldCode,
                            tech_key: parentEntityKey + '||' + String(topFieldCode).toLowerCase()
                        });
                    });
                });
                return catalog;
            });
        }
        function buildCustomFieldReadableTokenMap(tableIndex) {
            return buildCustomFieldTokenDescriptorCatalog(tableIndex).then(function(catalog) {
                var map = {};
                Object.keys((catalog && catalog.byTech) || {}).forEach(function(k) {
                    var d = catalog.byTech[k];
                    if (!d || !d.readable_label) return;
                    if (!map[k]) map[k] = d.readable_label;
                });
                return map;
            });
        }
        var customFieldReadableHintRenderSeq = 0;
        function renderCustomFieldEditorReadableHint() {
            if (!customFieldEditorReadableHint) return;
            if (!customFieldPayloadTextarea) {
                customFieldEditorReadableHint.textContent = '';
                customFieldEditorReadableHint.classList.add('d-none');
                return;
            }
            var editor = String(customFieldPayloadTextarea.value || '');
            if (!editor || editor.indexOf('{') < 0 || editor.indexOf('|') < 0) {
                customFieldEditorReadableHint.textContent = '';
                customFieldEditorReadableHint.classList.add('d-none');
                return;
            }
            var seq = ++customFieldReadableHintRenderSeq;
            buildCustomFieldReadableTokenMap(currentTableIndex).then(function(readableMap) {
                if (seq !== customFieldReadableHintRenderSeq) return;
                var rendered = editor.replace(/\{([^}]+)\}/g, function(full, tokenBody) {
                    var parts = splitEditorTokenModeSuffix(tokenBody);
                    var core = String(parts.core || '').trim();
                    if (!core || core.indexOf('|') < 0) return full;
                    var seg = core.split('|');
                    if (seg.length !== 3) return full;
                    var parentKey = String(seg[0] || '').trim();
                    var nestedKey = normalizeTechEntityKeyComparable(seg[1]);
                    var fieldCode = String(seg[2] || '').trim().toLowerCase();
                    if (!parentKey || !fieldCode) return full;
                    var key = parentKey + '|' + (nestedKey || '') + '|' + fieldCode;
                    var label = readableMap && readableMap[key] ? readableMap[key] : '';
                    if (!label) return full;
                    return '{' + label + (parts.suffix || '') + '}';
                });
                if (rendered === editor) {
                    customFieldEditorReadableHint.textContent = '';
                    customFieldEditorReadableHint.classList.add('d-none');
                    return;
                }
                customFieldEditorReadableHint.textContent = 'Читаемо: ' + rendered;
                customFieldEditorReadableHint.classList.remove('d-none');
            }).catch(function() {
                if (seq !== customFieldReadableHintRenderSeq) return;
                customFieldEditorReadableHint.textContent = '';
                customFieldEditorReadableHint.classList.add('d-none');
            });
        }
        function buildNestedSourceEntityHintsForEditor(tableIndex, originalEditorText, normalizedEditorText) {
            var st = tableStates[tableIndex];
            if (!st || !Array.isArray(st.selectedEntities) || !st.selectedEntities.length) return Promise.resolve([]);
            var originalEditor = String(originalEditorText || '');
            var normalizedEditor = String(normalizedEditorText || '');
            var tokenRelationMap = ensureCustomFieldTokenRelationMap(st);
            return buildCustomFieldTokenDescriptorCatalog(tableIndex).then(function(catalog) {
                var hints = [];
                var seen = {};
                function pushHint(h) {
                    if (!h) return;
                    var relKey = String(h.field_code || h.b24_field || h.column_name || '').trim();
                    var nestedKey = String(h.nested_entity_key || h.entity_key || '').trim();
                    var parentKey = String(h.parent_entity_key || '').trim();
                    if (!relKey || !nestedKey || !parentKey) return;
                    var k = parentKey + '|' + normalizeTechEntityKeyComparable(nestedKey) + '|' + relKey.toLowerCase();
                    if (seen[k]) return;
                    seen[k] = true;
                    hints.push(h);
                }
                function hintFromDescriptor(d) {
                    if (!d || !d.is_nested) return null;
                    return {
                        nested_entity_key: d.nested_entity_key || d.nested_entity_key_raw || '',
                        entity_key: d.nested_entity_key_norm || d.nested_entity_key || '',
                        parent_entity_key: d.parent_entity_key,
                        field_code: d.relation_field_code || d.relation_b24_field || d.relation_column_name,
                        b24_field: d.relation_b24_field || d.relation_field_code || '',
                        column_name: d.relation_column_name || '',
                        relation_field_code: d.relation_field_code || d.relation_b24_field || d.relation_column_name,
                        relation_b24_field: d.relation_b24_field || d.relation_field_code || '',
                        relation_column_name: d.relation_column_name || '',
                        link_field_code: d.relation_field_code || d.relation_b24_field || d.relation_column_name,
                        link_b24_field: d.relation_b24_field || d.relation_field_code || '',
                        link_column_name: d.relation_column_name || ''
                    };
                }
                // 1) Hints remembered from picker inserted technical tokens.
                if (normalizedEditor) {
                    normalizedEditor.replace(/\{([^}]+)\}/g, function(_, tokenBody) {
                        var parts = splitEditorTokenModeSuffix(tokenBody);
                        var core = String(parts.core || '').trim();
                        if (!core || core.indexOf('|') < 0) return _;
                        var mapped = tokenRelationMap[core];
                        if (mapped && typeof mapped === 'object') {
                            pushHint({
                                nested_entity_key: mapped.nested_entity_key,
                                entity_key: mapped.nested_entity_key,
                                parent_entity_key: mapped.parent_entity_key,
                                field_code: mapped.field_code || mapped.relation_field_code,
                                b24_field: mapped.b24_field || mapped.relation_b24_field,
                                column_name: mapped.column_name || mapped.relation_column_name,
                                relation_field_code: mapped.relation_field_code || mapped.field_code,
                                relation_b24_field: mapped.relation_b24_field || mapped.b24_field,
                                relation_column_name: mapped.relation_column_name || mapped.column_name,
                                link_field_code: mapped.link_field_code || mapped.relation_field_code || mapped.field_code,
                                link_b24_field: mapped.link_b24_field || mapped.relation_b24_field || mapped.b24_field,
                                link_column_name: mapped.link_column_name || mapped.relation_column_name || mapped.column_name
                            });
                        }
                        return _;
                    });
                }
                // 2) Hints derived from readable legacy nested tokens (Entity.Group.Field).
                if (originalEditor && originalEditor.indexOf('{') >= 0) {
                    originalEditor.replace(/\{([^}]+)\}/g, function(_, tokenBody) {
                        var parts = splitEditorTokenModeSuffix(tokenBody);
                        var core = String(parts.core || '').trim();
                        if (!core || core.indexOf('|') >= 0) return _;
                        if (catalog && catalog.byLegacy && catalog.byLegacy[core]) pushHint(hintFromDescriptor(catalog.byLegacy[core]));
                        return _;
                    });
                }
                // 3) Hints derived directly from technical tokens via metadata (works after reload/manual edit too).
                if (normalizedEditor && normalizedEditor.indexOf('{') >= 0) {
                    normalizedEditor.replace(/\{([^}]+)\}/g, function(_, tokenBody) {
                        var parts = splitEditorTokenModeSuffix(tokenBody);
                        var core = String(parts.core || '').trim();
                        if (!core || core.indexOf('|') < 0) return _;
                        var seg = core.split('|');
                        if (seg.length !== 3) return _;
                        var parentEntityKey = String(seg[0] || '').trim();
                        var nestedEntityKeyNeed = normalizeTechEntityKeyComparable(seg[1]);
                        var fieldCodeNeed = String(seg[2] || '').trim().toLowerCase();
                        if (!parentEntityKey || !nestedEntityKeyNeed || !fieldCodeNeed) return _;
                        var desc = catalog && catalog.byTech ? catalog.byTech[parentEntityKey + '|' + nestedEntityKeyNeed + '|' + fieldCodeNeed] : null;
                        if (desc) pushHint(hintFromDescriptor(desc));
                        return _;
                    });
                }
                return hints;
            });
        }
        function previewCustomFieldEditorViaApi(tableIndex, editorText) {
            var st = tableStates[tableIndex];
            if (!st) return Promise.reject(new Error('Нет активной таблицы'));
            if (!Array.isArray(st.selectedEntities) || !st.selectedEntities.length) return Promise.reject(new Error('Сначала выберите сущность таблицы'));
            var targetEntity = customFieldApiEntityPayload(st.selectedEntities[0]);
            if (!targetEntity || !targetEntity.entity_key) return Promise.reject(new Error('Не удалось определить target entity'));
            return normalizeCustomFieldEditorForBackend(tableIndex, editorText).then(function(normalizedEditor) {
                return buildNestedSourceEntityHintsForEditor(tableIndex, editorText, normalizedEditor).then(function(nestedHints) {
                var payload = {
                    page_slug: getPageSlug(),
                    table_index: tableIndex,
                    target_entity: targetEntity,
                    source_entities: (st.selectedEntities || []).map(customFieldApiEntityPayload).filter(Boolean).concat(Array.isArray(nestedHints) ? nestedHints : []),
                    editor: String(normalizedEditor || '')
                };
                return fetch(API.customFieldsPreview, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                }).then(function(r) {
                    return r.json().catch(function() { return { ok: false, error: 'Invalid response' }; })
                        .then(function(body) { return { ok: r.ok, body: body, status: r.status }; });
                }).then(function(res) {
                    if (!res.ok || !res.body || res.body.ok === false) {
                        throw new Error((res.body && (res.body.detail || res.body.error)) || ('Preview failed: ' + res.status));
                    }
                    return res.body;
                });
                });
            });
        }

        function renderCustomFieldsInFieldsTab(tableIndex) {
            if (!toggleCustomFieldsInFieldsTabBtn || !customFieldsSectionInFieldsTab || !customFieldsListInFieldsTab) return;
            var st = tableStates[tableIndex];
            var list = ensureCustomFieldsArray(st);
            toggleCustomFieldsInFieldsTabBtn.classList.toggle('d-none', !list.length);
            if (!list.length) {
                customFieldsSectionInFieldsTab.classList.add('d-none');
                customFieldsListInFieldsTab.innerHTML = '';
                toggleCustomFieldsInFieldsTabBtn.classList.remove('active', 'btn-primary');
                toggleCustomFieldsInFieldsTabBtn.classList.add('btn-outline-primary');
                return;
            }
            var html = '<div class="field-row fields-modal-entity-header" data-entity-header="1" data-entitykey="custom_fields"><span>Кастомные поля</span></div>';
            html += list.map(function(cf, idx) {
                var name = String((cf && cf.name) || '').trim() || '(без названия)';
                var code = String((cf && cf.code) || '').trim();
                var label = name;
                var safeId = 'cf_fields_tab_' + idx;
                var checked = (code && ensureSelectedCustomFieldCodes(st).indexOf(code) >= 0) ? ' checked' : '';
                return '<div class="form-check field-row" data-entitykey="custom_fields" data-nested-type="">'
                    + '<input class="form-check-input custom-fields-tab-cb" type="checkbox" id="' + safeId + '" data-custom-field-code="' + String(code || '').replace(/"/g, '&quot;') + '"' + checked + '>'
                    + '<label class="form-check-label" for="' + safeId + '">' + label.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;') + '</label>'
                    + '</div>';
            }).join('');
            customFieldsListInFieldsTab.innerHTML = html;
            var isOpen = !customFieldsSectionInFieldsTab.classList.contains('d-none');
            toggleCustomFieldsInFieldsTabBtn.classList.toggle('active', isOpen);
            toggleCustomFieldsInFieldsTabBtn.classList.toggle('btn-primary', isOpen);
            toggleCustomFieldsInFieldsTabBtn.classList.toggle('btn-outline-primary', !isOpen);
        }

        if (toggleCustomFieldsInFieldsTabBtn) {
            toggleCustomFieldsInFieldsTabBtn.addEventListener('click', function() {
                if (!customFieldsSectionInFieldsTab) return;
                customFieldsSectionInFieldsTab.classList.toggle('d-none');
                var isOpen = !customFieldsSectionInFieldsTab.classList.contains('d-none');
                toggleCustomFieldsInFieldsTabBtn.classList.toggle('active', isOpen);
                toggleCustomFieldsInFieldsTabBtn.classList.toggle('btn-primary', isOpen);
                toggleCustomFieldsInFieldsTabBtn.classList.toggle('btn-outline-primary', !isOpen);
            });
        }

        function saveCustomFieldFromForm() {
            var st = tableStates[currentTableIndex];
            if (!st) return;
            if (!Array.isArray(st.selectedEntities) || !st.selectedEntities.length) {
                alert('Select table entity first');
                return;
            }
            ensureCustomFieldsArray(st);
            var name = customFieldNameInput ? String(customFieldNameInput.value || '').trim() : '';
            if (!name) { alert('Enter field name'); return; }
            var code = normalizeCustomFieldCodeInputValue(customFieldCodeInput ? customFieldCodeInput.value : '', name);
            if (customFieldCodeInput) customFieldCodeInput.value = code;
            var targetEntity = customFieldApiEntityPayload(st.selectedEntities[0]);
            if (!targetEntity || !targetEntity.entity_key) {
                alert('Failed to resolve target entity');
                return;
            }
            var isEditMode = !!customFieldEditingId;
            var createdFieldCode = code;
            function isTimeoutLikeCustomFieldSaveError(err) {
                var msg = String((err && err.message) || '').toLowerCase();
                return msg.indexOf('timeout') >= 0
                    || msg.indexOf('read timed out') >= 0
                    || msg.indexOf('failed to fetch') >= 0
                    || msg.indexOf('networkerror') >= 0;
            }
            function tryRecoverCreatedFieldAfterSaveError() {
                return loadCustomFieldsForTable(currentTableIndex).then(function() {
                    var list = ensureCustomFieldsArray(st);
                    var recovered = list.find(function(x) {
                        return x && String((x.code || '')).trim() === String(createdFieldCode || '').trim();
                    }) || null;
                    if (recovered) {
                        setCustomFieldFormMode(recovered);
                        renderCustomFieldsInFieldsTab(currentTableIndex);
                        saveConfigToStorage();
                    }
                    return recovered;
                });
            }
            var requestPayload = isEditMode ? {
                custom_field: {
                    name: name,
                    description: customFieldDescriptionInput ? String(customFieldDescriptionInput.value || '').trim() : '',
                    type: (customFieldTypeSelect && customFieldTypeSelect.value === 'card') ? 'card' : 'single',
                    editor: customFieldPayloadTextarea ? String(customFieldPayloadTextarea.value || '') : ''
                }
            } : {
                page_slug: getPageSlug(),
                table_index: currentTableIndex,
                // Save quickly; run long recalc explicitly.
                recalculate_now: false,
                target_entity: targetEntity,
                custom_field: {
                    name: name,
                    code: code,
                    description: customFieldDescriptionInput ? String(customFieldDescriptionInput.value || '').trim() : '',
                    type: (customFieldTypeSelect && customFieldTypeSelect.value === 'card') ? 'card' : 'single',
                    editor: customFieldPayloadTextarea ? String(customFieldPayloadTextarea.value || '') : ''
                },
                source_entities: (st.selectedEntities || []).map(customFieldApiEntityPayload).filter(Boolean)
            };
            if (customFieldSaveBtn) customFieldSaveBtn.disabled = true;
            normalizeCustomFieldEditorForBackend(currentTableIndex, (requestPayload && requestPayload.custom_field && requestPayload.custom_field.editor) || '')
                .then(function(normalizedEditor) {
                    if (requestPayload && requestPayload.custom_field) {
                        requestPayload.custom_field.editor = String(normalizedEditor || '');
                    }
                    return buildNestedSourceEntityHintsForEditor(currentTableIndex, (customFieldPayloadTextarea ? String(customFieldPayloadTextarea.value || '') : ''), String(normalizedEditor || ''))
                        .then(function(nestedHints) {
                            if (Array.isArray(nestedHints) && nestedHints.length) {
                                if (!Array.isArray(requestPayload.source_entities)) requestPayload.source_entities = [];
                                requestPayload.source_entities = requestPayload.source_entities.concat(nestedHints);
                            }
                            return (isEditMode
                                ? updateCustomFieldViaApi(customFieldEditingId, requestPayload, 'PATCH')
                                : createCustomFieldViaApi(currentTableIndex, requestPayload));
                        });
                })
                .then(function(created) {
                    if (!created) return loadCustomFieldsForTable(currentTableIndex);
                    ensureCustomFieldsArray(st);
                    var idxExisting = st.customFields.findIndex(function(x) { return x && x.id === created.id; });
                    if (idxExisting >= 0) st.customFields[idxExisting] = created;
                    else st.customFields.push(created);
                    renderCustomFieldsInFieldsTab(currentTableIndex);
                    saveConfigToStorage();
                    setCustomFieldFormMode(created);
                    if (isEditMode) {
                        alert('Custom field updated. Click "Recalculate" to apply editor changes to data.');
                    } else {
                        alert('Custom field saved. Click "Recalculate" to fill values.');
                    }
                })
                .catch(function(err) {
                    if (!isEditMode && isTimeoutLikeCustomFieldSaveError(err)) {
                        tryRecoverCreatedFieldAfterSaveError()
                            .then(function(recovered) {
                                if (recovered) {
                                    alert('Custom field was likely saved, but response timed out. The field is present. Click "Recalculate".');
                                    return;
                                }
                                alert((err && err.message) ? err.message : 'Failed to create custom field');
                            })
                            .catch(function() {
                                alert((err && err.message) ? err.message : 'Failed to create custom field');
                            });
                        return;
                    }
                    alert((err && err.message) ? err.message : (isEditMode ? 'Failed to update custom field' : 'Failed to create custom field'));
                })
                .finally(function() {
                    if (customFieldSaveBtn) customFieldSaveBtn.disabled = false;
                });
        }
        function renderCustomFieldDeleteList() {
            if (!customFieldDeleteList) return;
            var st = tableStates[currentTableIndex];
            var list = ensureCustomFieldsArray(st);
            if (!list.length) {
                customFieldDeleteList.innerHTML = '<div class="text-muted small">Нет кастомных полей</div>';
                return;
            }
            customFieldDeleteList.innerHTML = list.map(function(cf, idx) {
                var id = 'customFieldDeletePick_' + idx;
                var name = String((cf && cf.name) || '').trim() || '(без названия)';
                var code = String((cf && cf.code) || '').trim();
                var type = String((cf && cf.type) || 'single').trim();
                var label = name + (code ? (' [' + code + ']') : '') + (type ? (' (' + type + ')') : '');
                var safe = label.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                return ''
                    + '<div class="form-check">'
                    + '  <input class="form-check-input" type="radio" name="customFieldDeletePick" id="' + id + '" value="' + idx + '"' + (idx === 0 ? ' checked' : '') + '>'
                    + '  <label class="form-check-label" for="' + id + '">' + safe + '</label>'
                    + '</div>';
            }).join('');
        }
        function renderCustomFieldEditList() {
            if (!customFieldEditList) return;
            var st = tableStates[currentTableIndex];
            var list = ensureCustomFieldsArray(st);
            if (!list.length) {
                customFieldEditList.innerHTML = '<div class="text-muted small">Нет кастомных полей</div>';
                return;
            }
            customFieldEditList.innerHTML = list.map(function(cf, idx) {
                var id = 'customFieldEditPick_' + idx;
                var name = String((cf && cf.name) || '').trim() || '(без названия)';
                var code = String((cf && cf.code) || '').trim();
                var label = name + (code ? (' [' + code + ']') : '');
                var safe = label.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                return ''
                    + '<div class="form-check">'
                    + '  <input class="form-check-input" type="radio" name="customFieldEditPick" id="' + id + '" value="' + idx + '"' + (idx === 0 ? ' checked' : '') + '>'
                    + '  <label class="form-check-label" for="' + id + '">' + safe + '</label>'
                    + '</div>';
            }).join('');
        }
        function setCustomFieldFormMode(item) {
            if (!item) {
                customFieldEditingId = null;
                if (customFieldEditModeHint) {
                    customFieldEditModeHint.textContent = '';
                    customFieldEditModeHint.classList.add('d-none');
                }
                if (customFieldSaveBtn) customFieldSaveBtn.textContent = 'Сохранить кастомное поле';
                if (customFieldCodeInput) customFieldCodeInput.disabled = false;
                if (customFieldPayloadTextarea) customFieldPayloadTextarea.value = '';
                renderCustomFieldEditorReadableHint();
                return;
            }
            customFieldEditingId = item.id || null;
            if (customFieldNameInput) customFieldNameInput.value = String(item.name || '');
            if (customFieldCodeInput) {
                customFieldCodeInput.value = String(item.code || '');
                customFieldCodeInput.disabled = true;
            }
            if (customFieldDescriptionInput) customFieldDescriptionInput.value = String(item.description || '');
            if (customFieldTypeSelect) customFieldTypeSelect.value = String(item.type || 'single') === 'card' ? 'card' : 'single';
            if (customFieldPayloadTextarea) customFieldPayloadTextarea.value = String(item.editor || '');
            if (customFieldEditModeHint) {
                customFieldEditModeHint.textContent = 'Режим редактирования: ' + (item.name || item.code || item.id || '');
                customFieldEditModeHint.classList.remove('d-none');
            }
            if (customFieldSaveBtn) customFieldSaveBtn.textContent = 'Сохранить изменения';
            renderCustomFieldEditorReadableHint();
        }
        function renderCustomFieldRecalcList() {
            if (!customFieldRecalcList) return;
            var st = tableStates[currentTableIndex];
            var list = ensureCustomFieldsArray(st);
            if (!list.length) {
                customFieldRecalcList.innerHTML = '<div class="text-muted small">Нет кастомных полей</div>';
                return;
            }
            customFieldRecalcList.innerHTML = list.map(function(cf, idx) {
                var id = 'customFieldRecalcPick_' + idx;
                var name = String((cf && cf.name) || '').trim() || '(без названия)';
                var code = String((cf && cf.code) || '').trim();
                var type = String((cf && cf.type) || 'single').trim();
                var label = name + (code ? (' [' + code + ']') : '') + (type ? (' (' + type + ')') : '');
                var safe = label.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                return ''
                    + '<div class="form-check">'
                    + '  <input class="form-check-input" type="radio" name="customFieldRecalcPick" id="' + id + '" value="' + idx + '"' + (idx === 0 ? ' checked' : '') + '>'
                    + '  <label class="form-check-label" for="' + id + '">' + safe + '</label>'
                    + '</div>';
            }).join('');
        }

        function deleteSelectedCustomField() {
            var st = tableStates[currentTableIndex];
            if (!st) return;
            var list = ensureCustomFieldsArray(st);
            if (!list.length) return;
            var checked = customFieldDeleteList ? customFieldDeleteList.querySelector('input[name="customFieldDeletePick"]:checked') : null;
            if (!checked) return;
            var idx = parseInt(checked.value, 10);
            if (!Number.isFinite(idx) || idx < 0 || idx >= list.length) return;
            var item = list[idx] || {};
            var finishLocalDelete = function() {
                list.splice(idx, 1);
                renderCustomFieldsInFieldsTab(currentTableIndex);
                renderCustomFieldDeleteList();
                saveConfigToStorage();
                if (customFieldDeleteModal && !list.length) customFieldDeleteModal.hide();
            };
            if (!item.id) {
                finishLocalDelete();
                return;
            }
            if (customFieldDeleteConfirmBtn) customFieldDeleteConfirmBtn.disabled = true;
            deleteCustomFieldViaApi(item.id)
                .then(function() {
                    finishLocalDelete();
                })
                .catch(function(err) {
                    alert((err && err.message) ? err.message : 'Не удалось удалить кастомное поле');
                })
                .finally(function() {
                    if (customFieldDeleteConfirmBtn) customFieldDeleteConfirmBtn.disabled = false;
                });
        }
        function recalculateSelectedCustomField() {
            var st = tableStates[currentTableIndex];
            if (!st) return;
            var list = ensureCustomFieldsArray(st);
            if (!list.length) return;
            var checked = customFieldRecalcList ? customFieldRecalcList.querySelector('input[name="customFieldRecalcPick"]:checked') : null;
            if (!checked) return;
            var idx = parseInt(checked.value, 10);
            if (!Number.isFinite(idx) || idx < 0 || idx >= list.length) return;
            var item = list[idx] || {};
            if (!item.id) {
                alert('У поля нет id для пересчета');
                return;
            }
            if (customFieldRecalcConfirmBtn) customFieldRecalcConfirmBtn.disabled = true;
            recalculateCustomFieldViaApi(item.id)
                .then(function(res) {
                    if (customFieldRecalcModal) customFieldRecalcModal.hide();
                    loadData(currentTableIndex);
                    var upd = res && res.recalculate_result && res.recalculate_result.updated_rows != null ? res.recalculate_result.updated_rows : null;
                    var modeDetail = res && res.recalculate_result && res.recalculate_result.mode_detail ? String(res.recalculate_result.mode_detail) : '';
                    if (upd != null) {
                        alert('Пересчет выполнен. Обновлено строк: ' + upd + (modeDetail ? ('\nРежим: ' + modeDetail) : ''));
                    }
                })
                .catch(function(err) {
                    alert((err && err.message) ? err.message : 'Не удалось пересчитать кастомное поле');
                })
                .finally(function() {
                    if (customFieldRecalcConfirmBtn) customFieldRecalcConfirmBtn.disabled = false;
                });
        }
        function openSelectedCustomFieldInForm() {
            var st = tableStates[currentTableIndex];
            if (!st) return;
            var list = ensureCustomFieldsArray(st);
            if (!list.length) return;
            var checked = customFieldEditList ? customFieldEditList.querySelector('input[name="customFieldEditPick"]:checked') : null;
            if (!checked) return;
            var idx = parseInt(checked.value, 10);
            if (!Number.isFinite(idx) || idx < 0 || idx >= list.length) return;
            var item = list[idx];
            if (!item) return;
            setCustomFieldFormMode(item);
            if (customFieldEditModal) customFieldEditModal.hide();
        }

        if (customFieldSaveBtn) {
            customFieldSaveBtn.addEventListener('click', function() {
                saveCustomFieldFromForm();
            });
        }
        if (customFieldDeleteOpenBtn) {
            customFieldDeleteOpenBtn.addEventListener('click', function() {
                renderCustomFieldDeleteList();
                if (customFieldDeleteModal) customFieldDeleteModal.show();
            });
        }
        if (customFieldEditOpenBtn) {
            customFieldEditOpenBtn.addEventListener('click', function() {
                renderCustomFieldEditList();
                if (customFieldEditModal) customFieldEditModal.show();
            });
        }
        if (customFieldRecalcOpenBtn) {
            customFieldRecalcOpenBtn.addEventListener('click', function() {
                renderCustomFieldRecalcList();
                if (customFieldRecalcModal) customFieldRecalcModal.show();
            });
        }
        if (customFieldDeleteConfirmBtn) {
            customFieldDeleteConfirmBtn.addEventListener('click', function() {
                deleteSelectedCustomField();
            });
        }
        if (customFieldRecalcConfirmBtn) {
            customFieldRecalcConfirmBtn.addEventListener('click', function() {
                recalculateSelectedCustomField();
            });
        }
        if (customFieldEditConfirmBtn) {
            customFieldEditConfirmBtn.addEventListener('click', function() {
                openSelectedCustomFieldInForm();
            });
        }

        function getSectionEls(sectionIndex) {
            var st = tableStates[sectionIndex];
            if (!st) return {};
            if (st.type === 'card') {
                var section = entityTablesContainer && entityTablesContainer.querySelector('.entity-report-card-section[data-card-index="' + sectionIndex + '"]');
                if (!section) return {};
                return {
                    section: section,
                    cardTitleEl: section.querySelector('.report-card-title'),
                    mainValueEl: section.querySelector('.report-card-main-value'),
                    secondaryValueEl: section.querySelector('.report-card-secondary-value'),
                    iconWrap: section.querySelector('.report-card-icon-wrap'),
                    iconEl: section.querySelector('.report-card-icon-wrap i'),
                    cardActions: section.querySelector('.card-actions-in-section'),
                    btnEditCard: section.querySelector('.btnEditCardInSection'),
                    btnDeleteCard: section.querySelector('.btnDeleteCardInSection')
                };
            }
            var section = entityTablesContainer && entityTablesContainer.querySelector('.entity-table-section[data-table-index="' + sectionIndex + '"]');
            if (!section) return {};
            return {
                section: section,
                loadingBlock: section.querySelector('.loadingBlockInSection'),
                loadingText: section.querySelector('.loadingTextInSection'),
                gridTopRow: section.querySelector('.gridTopRowInSection'),
                gridBlock: section.querySelector('.gridBlockInSection'),
                searchFilterRow: section.querySelector('.searchFilterRowInSection'),
                emptyBlock: section.querySelector('.emptyBlockInSection'),
                gridHead: section.querySelector('.entity-table-grid-head'),
                gridBody: section.querySelector('.entity-table-grid-body'),
                paginationBlock: section.querySelector('.paginationBlockInSection'),
                pageSizeSelect: section.querySelector('.pageSizeInSection'),
                paginationInfo: section.querySelector('.paginationInfoInSection'),
                paginationNav: section.querySelector('.paginationNavInSection'),
                btnFields: section.querySelector('.btnFieldsInSection'),
                filterDropdown: section.querySelector('.filterDropdownInSection'),
                filterDropdownRowsContainer: section.querySelector('.filterDropdownRowsContainerInSection'),
                filterDropdownAdd: section.querySelector('.addFilterFieldInDropdownInSection'),
                filterDropdownSave: section.querySelector('.filterDropdownSaveInSection'),
                filterDropdownClose: section.querySelector('.filterDropdownCloseInSection'),
                tableTitleBlock: section.querySelector('.tableTitleBlockInSection'),
                tableTitleText: section.querySelector('.tableTitleTextInSection')
            };
        }

        function syncSectionWidthToContent(tableIndex) {
            var st = tableStates[tableIndex];
            if (!st || st.type === 'card') return;
            var els = getSectionEls(tableIndex);
            var section = els.section;
            if (!section) return;
            var cs = window.getComputedStyle ? window.getComputedStyle(section) : null;
            var hPad = cs ? (
                (parseFloat(cs.paddingLeft) || 0) +
                (parseFloat(cs.paddingRight) || 0) +
                (parseFloat(cs.borderLeftWidth) || 0) +
                (parseFloat(cs.borderRightWidth) || 0)
            ) : 0;
            var contentWidth = 0;
            var gridVisible = !!(els.gridBlock && !(els.gridBlock.classList && els.gridBlock.classList.contains('d-none')));
            if (gridVisible) {
                var tbl = els.gridBlock.querySelector('table');
                contentWidth = Math.max(
                    els.gridBlock.scrollWidth || 0,
                    tbl ? (tbl.scrollWidth || tbl.offsetWidth || 0) : 0
                );
                // Prefer table width as the source of truth; top search row can wrap inside the section.
            } else {
                [els.loadingBlock, els.gridTopRow, els.searchFilterRow, els.paginationBlock].forEach(function(el) {
                    if (!el || (el.classList && el.classList.contains('d-none'))) return;
                    var w = Math.max(el.scrollWidth || 0, el.offsetWidth || 0);
                    if (w > contentWidth) contentWidth = w;
                });
            }
            if (!contentWidth) {
                section.style.width = '';
                return;
            }
            var parentWidth = section.parentElement ? (section.parentElement.clientWidth || 0) : 0;
            var target = Math.ceil(contentWidth + hPad);
            // Respect CSS min-width floor used by the layout.
            target = Math.max(320, target);
            if (parentWidth > 0) target = Math.min(target, parentWidth);
            section.style.width = target + 'px';
        }

        let entityRadioName = 0;

        /** Делегирование: при клике по кнопке/чекбоксу вложенности показывать/скрывать рубрику и поля в реальном времени. */
        if (nestedCheckboxesRow && fieldsList) {
            nestedCheckboxesRow.addEventListener('click', function(e) {
                var target = e.target.closest && e.target.closest('.nested-toggle') ? e.target.closest('.nested-toggle') : (e.target.classList && e.target.classList.contains('nested-toggle') ? e.target : null);
                if (!target) return;
                e.preventDefault();
                var ek = target.getAttribute('data-entitykey');
                var typ = target.getAttribute('data-type');
                if (!ek || !typ) return;
                var isButton = target.tagName === 'BUTTON' || target.getAttribute('role') === 'button';
                var show;
                if (isButton) {
                    show = !target.classList.contains('active');
                    target.classList.toggle('active', show);
                    target.setAttribute('data-active', show ? 'true' : 'false');
                } else {
                    show = target.checked;
                }
                fieldsList.querySelectorAll('[data-entitykey="' + ek + '"][data-nested-type="' + typ + '"]').forEach(function(el) {
                    el.style.display = show ? '' : 'none';
                });
                filterFieldsBySearch();
            });
        }

        function showLoading(tableIndex, show, text) {
            var els = getSectionEls(tableIndex);
            if (!els.loadingBlock) return;
            if (show) {
                els.loadingBlock.classList.remove('d-none');
                if (els.loadingText) els.loadingText.textContent = text || 'Загрузка...';
            } else {
                els.loadingBlock.classList.add('d-none');
            }
        }

        function entityKey(e) {
            return (e.entity_key || e.type) + (e.category_id != null ? '_' + e.category_id : '');
        }

        /** Служебные колонки не показываем и не сохраняем в настройках. */
        function isSystemColumn(key) {
            if (!key) return true;
            if (key === '_entityKey') return true;
            var i = key.indexOf('::');
            if (i >= 0 && key.slice(i + 2) === '_entityKey') return true;
            return false;
        }

        /** Убирает дубли сущностей и объединяет поля по entityKey (одна запись полей на сущность). */
        function normalizeEntitiesAndFields(entities, fields) {
            var seen = {};
            var dedupEntities = [];
            var fieldsByKey = {};
            (fields || []).forEach(function(f) {
                var k = f.entityKey;
                if (!k) return;
                if (!fieldsByKey[k]) fieldsByKey[k] = { entityKey: k, human_titles: [], activeNestedTypes: [], nestedFields: {} };
                if (f.human_titles && f.human_titles.length) {
                    f.human_titles.forEach(function(t) {
                        if (fieldsByKey[k].human_titles.indexOf(t) < 0) fieldsByKey[k].human_titles.push(t);
                    });
                }
                if (f.activeNestedTypes && f.activeNestedTypes.length) {
                    f.activeNestedTypes.forEach(function(typ) {
                        if (fieldsByKey[k].activeNestedTypes.indexOf(typ) < 0) fieldsByKey[k].activeNestedTypes.push(typ);
                    });
                }
                if (f.nestedFields && typeof f.nestedFields === 'object') {
                    Object.keys(f.nestedFields).forEach(function(typ) {
                        if (!fieldsByKey[k].nestedFields[typ]) fieldsByKey[k].nestedFields[typ] = [];
                        (f.nestedFields[typ] || []).forEach(function(t) {
                            if (fieldsByKey[k].nestedFields[typ].indexOf(t) < 0) fieldsByKey[k].nestedFields[typ].push(t);
                        });
                    });
                }
            });
            (entities || []).forEach(function(e) {
                var k = entityKey(e);
                if (seen[k]) return;
                seen[k] = true;
                dedupEntities.push(e);
            });
            return {
                entities: dedupEntities,
                fields: dedupEntities.map(function(e) {
                    var base = fieldsByKey[entityKey(e)] || { entityKey: entityKey(e), human_titles: [], activeNestedTypes: [], nestedFields: {} };
                    if (!base.nestedFields) base.nestedFields = {};
                    return base;
                })
            };
        }

        function updateUI(tableIndex) {
            var st = tableStates[tableIndex];
            if (!st) return;
            var els = getSectionEls(tableIndex);
            var hasEntities = st.selectedEntities.length > 0;
            if (els.btnFields) els.btnFields.classList.toggle('d-none', !hasEntities);
            var plusBtn = els.section && els.section.querySelector('.btnAddEntityInSection');
            if (plusBtn) plusBtn.classList.toggle('d-none', !hasEntities);
        }

        function saveTemplateSnapshot(preferredIndex) {
            var st = tableStates[preferredIndex] || tableStates[0];
            if (!st) return;
            var tablesPayload = tableStates.map(function(t) {
                return {
                    table_title: t.tableTitle || '',
                    table_description: t.tableDescription || '',
                    table_style: t.tableStyle || 'hoverable_rows',
                    entities: t.selectedEntities || [],
                    fields: t.selectedFields || [],
                    show_time: (t.showTime === true),
                    date_time_display: (t.dateTimeDisplayByColumn && Object.keys(t.dateTimeDisplayByColumn).length) ? t.dateTimeDisplayByColumn : null
                };
            });
            if (!tablesPayload.some(function(t) { return t.entities && t.entities.length > 0 && t.fields && t.fields.length > 0; })) return;
            var templateName = (st.tableTitle && String(st.tableTitle).trim()) || ('Шаблон ' + new Date().toLocaleString('ru-RU', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' }));
            fetch(API.templates, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name: templateName, tables: tablesPayload })
            }).then(function(r) { return r.json(); }).then(function(data) { if (data && data.ok) loadTemplates(); }).catch(function() {});
        }

        function deleteTableAtIndex(index) {
            if (index == null || isNaN(index) || index < 0 || index >= tableStates.length) return;
            tableStates.splice(index, 1);
            currentTableIndex = tableStates.length ? Math.min(Math.max(0, currentTableIndex), tableStates.length - 1) : 0;
            ensureSections();
            for (var i = 0; i < tableStates.length; i++) {
                if (tableStates[i].type === 'card') {
                    updateCardUI(i);
                    loadCardData(i);
                } else {
                    updateUI(i);
                    loadFieldsThenData(i, false);
                }
            }
            saveConfigToStorage();
            saveConfig();
            saveTemplateSnapshot(index > 0 ? index - 1 : 0);
        }

        function getPageSlug() {
            return (PAGE_SLUG && String(PAGE_SLUG).trim()) ? String(PAGE_SLUG).trim() : 'entity-table';
        }

        function canUseLocalTableStorage() {
            return !isGuestUser();
        }

        var STORAGE_KEY_PREFIX = 'entity_table_config_';
        var COLUMN_ORDER_KEY_PREFIX = 'entity_table_column_order_';

        function getColumnOrderStorageKey() {
            return COLUMN_ORDER_KEY_PREFIX + getPageSlug();
        }

        function saveColumnOrder() {
            if (!canUseLocalTableStorage()) return;
            try {
                var obj = {};
                tableStates.forEach(function(st, i) {
                    if (st.allColumns && st.allColumns.length) obj[i] = st.allColumns.map(function(c) { return c.key; });
                });
                localStorage.setItem(getColumnOrderStorageKey(), JSON.stringify(obj));
            } catch (e) {}
        }

        function loadColumnOrder(tableIndex) {
            if (!canUseLocalTableStorage()) return null;
            try {
                var raw = localStorage.getItem(getColumnOrderStorageKey());
                if (!raw) return null;
                var obj = JSON.parse(raw);
                return (obj && obj[tableIndex]) ? obj[tableIndex] : null;
            } catch (e) { return null; }
        }

        /** Порядок колонок: приоритет у локального (localStorage после перетаскивания), иначе с сервера. */
        function getColumnOrderForTable(tableIndex) {
            var local = loadColumnOrder(tableIndex);
            if (local && local.length) return local;
            var st = tableStates[tableIndex];
            if (st && st.columnOrderFromServer && st.columnOrderFromServer.length) return st.columnOrderFromServer;
            return null;
        }

        /** Сбросить сохранённый порядок колонок для одной таблицы (после смены полей удалённые колонки не должны влиять на порядок). */
        function clearColumnOrderForTable(tableIndex) {
            if (!canUseLocalTableStorage()) return;
            try {
                var raw = localStorage.getItem(getColumnOrderStorageKey());
                if (!raw) return;
                var obj = JSON.parse(raw);
                if (obj && obj[tableIndex] !== undefined) { delete obj[tableIndex]; localStorage.setItem(getColumnOrderStorageKey(), JSON.stringify(obj)); }
            } catch (e) {}
        }

        /** Clear saved column widths for a table so columns auto-fit to content after create/change. */
        function clearColumnWidthsForTable(tableIndex) {
            var st = tableStates[tableIndex];
            if (st) st.columnWidths = {};
            if (!canUseLocalTableStorage()) return;
            try {
                var raw = localStorage.getItem(getColumnWidthStorageKey());
                if (!raw) return;
                var obj = JSON.parse(raw);
                if (obj && obj[tableIndex] !== undefined) { delete obj[tableIndex]; localStorage.setItem(getColumnWidthStorageKey(), JSON.stringify(obj)); }
            } catch (e) {}
        }

        /** По selectedFields строит множество ключей колонок (key::title), которые реально выбраны (базовые + вложенные). _entityKey не включается ни для каких сущностей. */
        function getValidColumnKeysFromSelectedFields(st) {
            if (!st || !st.selectedEntities || !st.selectedFields) return {};
            var valid = {};
            var knownEntities = [];
            if (st._expandedLoadEntities && Array.isArray(st._expandedLoadEntities)) knownEntities = knownEntities.concat(st._expandedLoadEntities);
            if (st.selectedEntities && Array.isArray(st.selectedEntities)) knownEntities = knownEntities.concat(st.selectedEntities);
            if (entitiesList && Array.isArray(entitiesList)) knownEntities = knownEntities.concat(entitiesList);
            st.selectedEntities.forEach(function(ent) {
                var key = entityKey(ent);
                var sel = st.selectedFields.find(function(f) { return f.entityKey === key; });
                if (!sel) return;
                (sel.human_titles || []).forEach(function(t) {
                    var colKey = key + '::' + t;
                    if (!isSystemColumn(colKey)) valid[colKey] = true;
                });
                if (sel.nestedFields && typeof sel.nestedFields === 'object') {
                    Object.keys(sel.nestedFields).forEach(function(typ) {
                        (sel.nestedFields[typ] || []).forEach(function(t) {
                            var mappedEnt = resolveNestedMappedEntity(typ, knownEntities);
                            if (mappedEnt) {
                                var mappedKey = entityKey(mappedEnt) + '::' + t;
                                if (!isSystemColumn(mappedKey)) valid[mappedKey] = true;
                            } else {
                                var colKey = key + '::' + t;
                                if (!isSystemColumn(colKey)) valid[colKey] = true;
                            }
                        });
                    });
                }
            });
            ensureSelectedCustomFieldCodes(st).forEach(function(code) {
                if (!code) return;
                var cf = (st.customFields || []).find(function(x) { return x && String(x.code || '') === String(code); });
                if (!cf || !cf.target_entity || !cf.target_entity.entity_key) return;
                var ek = String(cf.target_entity.entity_key);
                var colKey = ek + '::' + String(code);
                if (!isSystemColumn(colKey)) valid[colKey] = true;
            });
            return valid;
        }

        /** Стандартный порядок колонок при первой загрузке (по названию поля). Остальные — после в текущем порядке. */
        var DEFAULT_COLUMN_ORDER = [
            'Воронка', 'Название', 'Кем создана', 'Ответственный', 'Валюта',
            'Дата создания', 'Дата изменения', 'Стадия', 'Стадия сделки', 'Источник',
            'Сумма', 'ID', 'Тип'
        ];
        function applyDefaultColumnOrder(columns) {
            if (!columns || !columns.length) return columns;
            var order = DEFAULT_COLUMN_ORDER;
            return columns.slice().sort(function(a, b) {
                var ia = order.indexOf(a.label);
                var ib = order.indexOf(b.label);
                if (ia === -1 && ib === -1) return 0;
                if (ia === -1) return 1;
                if (ib === -1) return -1;
                return ia - ib;
            });
        }

        function applyColumnOrder(columns, orderKeys) {
            /* Без сохранённого порядка оставляем порядок из конфига (selectedFields), чтобы дашборд совпадал с настройками. */
            if (!orderKeys || !orderKeys.length) return columns.slice();
            var byKey = {};
            columns.forEach(function(c) { byKey[c.key] = c; });
            var result = [];
            var added = {};
            orderKeys.forEach(function(k) {
                if (byKey[k] && !added[k]) { result.push(byKey[k]); added[k] = true; }
            });
            columns.forEach(function(c) {
                if (!added[c.key]) result.push(c);
            });
            return result;
        }

        var COLUMN_WIDTH_KEY_PREFIX = 'entity_table_column_widths_';
        var MIN_COL_WIDTH = 40;
        /** Минимальная ширина (px), при которой применяем сохранённую ширину; иначе колонка подстраивается под содержимое (даты, заголовки не обрезаются). */
        var MIN_CONTENT_SAFE_WIDTH = 180;
        var RESIZE_SORT_CLICK_SUPPRESS_MS = 350;

        function getColumnWidthStorageKey() {
            return COLUMN_WIDTH_KEY_PREFIX + getPageSlug();
        }

        function saveColumnWidths() {
            if (!canUseLocalTableStorage()) return;
            try {
                var obj = {};
                tableStates.forEach(function(st, i) {
                    if (st.columnWidths && Object.keys(st.columnWidths).length) obj[i] = st.columnWidths;
                });
                localStorage.setItem(getColumnWidthStorageKey(), JSON.stringify(obj));
            } catch (e) {}
        }

        function loadColumnWidths(tableIndex) {
            if (!canUseLocalTableStorage()) return {};
            try {
                var raw = localStorage.getItem(getColumnWidthStorageKey());
                if (!raw) return {};
                var obj = JSON.parse(raw);
                var t = obj && obj[tableIndex] ? obj[tableIndex] : {};
                return typeof t === 'object' ? t : {};
            } catch (e) { return {}; }
        }

        function getPersistedTableFilterFields(st) {
            if (!st || !Array.isArray(st.filterFields) || !st.filterFields.length) return [];
            var allowedKeys = {};
            if (Array.isArray(st.allColumns) && st.allColumns.length) {
                st.allColumns.forEach(function(c) {
                    if (c && c.key) allowedKeys[String(c.key)] = true;
                });
            }
            return st.filterFields.filter(function(f) {
                if (!f) return false;
                var key = String((f.key || '')).trim();
                if (!key) return false;
                if (!Object.keys(allowedKeys).length) return true;
                return !!allowedKeys[key];
            }).map(function(f) {
                var out = {
                    label: (f.label != null) ? String(f.label) : '',
                    key: (f.key != null) ? String(f.key) : '',
                    type: (f.type != null) ? String(f.type) : 'text'
                };
                if (f.value != null) out.value = String(f.value);
                if (Array.isArray(f.selectedValues)) out.selectedValues = f.selectedValues.slice();
                if (f.sourceFieldType != null) out.sourceFieldType = String(f.sourceFieldType);
                if (f.sourceB24Field != null) out.sourceB24Field = String(f.sourceB24Field);
                if (f.sourceColumnName != null) out.sourceColumnName = String(f.sourceColumnName);
                return out;
            });
        }

        function saveConfigToStorage() {
            if (!canUseLocalTableStorage()) return;
            try {
                var key = STORAGE_KEY_PREFIX + getPageSlug();
                var tables = [];
                tableStates.forEach(function(st, i) {
                    if (!isConfiguredSectionState(st)) return;
                    if (st.type === 'card' && window.EntityCard && typeof window.EntityCard.serializeCardState === 'function') {
                        tables.push(window.EntityCard.serializeCardState(st));
                        return;
                    }
                    if (st.type === 'card') {
                        tables.push({
                            type: 'card',
                            card_title: st.cardTitle,
                            icon: st.icon || 'iconoir-activity',
                            entities: st.selectedEntities,
                            fields: st.selectedFields,
                            filter_fields: (st.filterFields && st.filterFields.length) ? st.filterFields : [],
                            main_formula: st.mainFormula || { aggregate: 'count', fieldKey: null },
                            secondary_formula: st.secondaryFormula || null,
                            start_new_row: (st.startNewRow === true)
                        });
                        return;
                    }
                    var keys = (st.allColumns && st.allColumns.length) ? st.allColumns.map(function(c) { return c.key; }) : getColumnKeysFromSection(i);
                    tables.push({
                        type: 'table',
                        table_title: st.tableTitle,
                        table_description: st.tableDescription,
                        table_style: st.tableStyle || 'hoverable_rows',
                        entities: st.selectedEntities,
                        fields: buildFieldsFromAllColumns(st),
                        custom_fields: (st.customFields && Array.isArray(st.customFields)) ? st.customFields : [],
                        selected_custom_fields: ensureSelectedCustomFieldCodes(st).slice(),
                        filter_fields: getPersistedTableFilterFields(st),
                        column_order: keys.length ? keys : null,
                        column_widths: (st.columnWidths && Object.keys(st.columnWidths).length) ? st.columnWidths : null,
                        sort_key: st.sortKey || null,
                        sort_dir: st.sortDir || null,
                        show_time: (st.showTime === true),
                        date_time_display: (st.dateTimeDisplayByColumn && Object.keys(st.dateTimeDisplayByColumn).length) ? st.dateTimeDisplayByColumn : null,
                        start_new_row: (st.startNewRow === true)
                    });
                });
                localStorage.setItem(key, JSON.stringify({ tables: tables }));
            } catch (e) {}
        }

        function loadConfigFromStorage() {
            if (!canUseLocalTableStorage()) return null;
            try {
                var key = STORAGE_KEY_PREFIX + getPageSlug();
                var raw = localStorage.getItem(key);
                if (!raw) return null;
                var data = JSON.parse(raw);
                return data;
            } catch (e) { return null; }
        }

        function applyConfig(data, openModalIfNoFields) {
            if (openModalIfNoFields === undefined) openModalIfNoFields = true;
            if (data.tables && Array.isArray(data.tables) && data.tables.length > 0) {
                tableStates = data.tables.map(function(t) {
                    if (t.type === 'card' && window.EntityCard && typeof window.EntityCard.parseCardStateFromSaved === 'function') {
                        return window.EntityCard.parseCardStateFromSaved(t);
                    }
                    var norm = normalizeEntitiesAndFields(t.entities || [], t.fields || []);
                    if (t.type === 'card') {
                        return {
                            type: 'card',
                            cardTitle: (t.card_title != null) ? String(t.card_title) : '',
                            icon: (t.icon && typeof t.icon === 'string') ? t.icon : 'iconoir-activity',
                            selectedEntities: norm.entities,
                            selectedFields: norm.fields,
                            filterFields: (t.filter_fields && Array.isArray(t.filter_fields)) ? t.filter_fields : [{ label: 'Название', key: '', type: 'text' }],
                            mainFormula: (t.main_formula && typeof t.main_formula === 'object') ? { aggregate: t.main_formula.aggregate || 'count', fieldKey: t.main_formula.fieldKey != null ? t.main_formula.fieldKey : null } : { aggregate: 'count', fieldKey: null },
                            secondaryFormula: (t.secondary_formula && typeof t.secondary_formula === 'object') ? { aggregate: t.secondary_formula.aggregate || 'count', fieldKey: t.secondary_formula.fieldKey != null ? t.secondary_formula.fieldKey : null, label: (t.secondary_formula.label != null) ? String(t.secondary_formula.label) : '' } : null,
                            fullData: [],
                            startNewRow: (t.start_new_row === true)
                        };
                    }
                    var orderFromServer = (t.column_order && Array.isArray(t.column_order)) ? t.column_order : null;
                    var widthsFromServer = (t.column_widths && typeof t.column_widths === 'object') ? t.column_widths : {};
                    return {
                        type: 'table',
                        selectedEntities: norm.entities,
                        selectedFields: norm.fields,
                        tableTitle: (t.table_title != null) ? String(t.table_title) : '',
                        tableDescription: (t.table_description != null) ? String(t.table_description) : '',
                        tableStyle: (t.table_style && TABLE_STYLES[t.table_style]) ? t.table_style : 'hoverable_rows',
                        fullData: [],
                        allColumns: [],
                        currentPage: 1,
                        pageSize: 25,
                        columnOrderFromServer: orderFromServer,
                        columnWidths: Object.keys(widthsFromServer).length ? widthsFromServer : {},
                        sortKey: (t.sort_key != null) ? String(t.sort_key) : '',
                        sortDir: (t.sort_dir === 'asc' || t.sort_dir === 'desc') ? t.sort_dir : '',
                        showTime: (t.show_time === true),
                        dateTimeDisplayByColumn: (t.date_time_display && typeof t.date_time_display === 'object') ? t.date_time_display : {},
                        customFields: (t.custom_fields && Array.isArray(t.custom_fields)) ? t.custom_fields : [],
                        selectedCustomFieldCodes: (t.selected_custom_fields && Array.isArray(t.selected_custom_fields)) ? t.selected_custom_fields : [],
                        filterFields: (t.filter_fields && Array.isArray(t.filter_fields)) ? t.filter_fields : [{ label: 'Название', key: '', type: 'text' }],
                        startNewRow: (t.start_new_row === true)
                    };
                });
                tableStates = tableStates.filter(isConfiguredSectionState);
                ensureSections();
                tableStates.forEach(function(st, i) {
                    if (st.type === 'card') {
                        updateCardUI(i);
                        loadCardData(i);
                    } else {
                        if (!st.columnWidths || !Object.keys(st.columnWidths).length) st.columnWidths = loadColumnWidths(i);
                        applyTableStyleToSection(i);
                        updateUI(i);
                        loadFieldsThenData(i, openModalIfNoFields);
                    }
                });
                return;
            }
            if (data.entities && Array.isArray(data.entities) && data.entities.length > 0) {
                var norm = normalizeEntitiesAndFields(data.entities, data.fields || []);
                var orderFromServer = (data.column_order && Array.isArray(data.column_order)) ? data.column_order : null;
                var widthsFromServer = (data.column_widths && typeof data.column_widths === 'object') ? data.column_widths : {};
                tableStates = [{
                    selectedEntities: norm.entities,
                    selectedFields: norm.fields,
                    tableTitle: (data.table_title != null) ? String(data.table_title) : '',
                    tableDescription: (data.table_description != null) ? String(data.table_description) : '',
                    tableStyle: (data.table_style && TABLE_STYLES[data.table_style]) ? data.table_style : 'hoverable_rows',
                    fullData: [],
                    allColumns: [],
                    currentPage: 1,
                    pageSize: 25,
                    columnOrderFromServer: orderFromServer,
                    columnWidths: Object.keys(widthsFromServer).length ? widthsFromServer : loadColumnWidths(0),
                    sortKey: (data.sort_key != null) ? String(data.sort_key) : '',
                    sortDir: (data.sort_dir === 'asc' || data.sort_dir === 'desc') ? data.sort_dir : '',
                    showTime: (data.show_time === true),
                    dateTimeDisplayByColumn: (data.date_time_display && typeof data.date_time_display === 'object') ? data.date_time_display : {},
                    customFields: (data.custom_fields && Array.isArray(data.custom_fields)) ? data.custom_fields : [],
                    selectedCustomFieldCodes: (data.selected_custom_fields && Array.isArray(data.selected_custom_fields)) ? data.selected_custom_fields : [],
                    filterFields: (data.filter_fields && Array.isArray(data.filter_fields)) ? data.filter_fields : [{ label: 'Название', key: '', type: 'text' }]
                }];
                ensureSections();
                applyTableStyleToSection(0);
                updateUI(0);
                loadFieldsThenData(0, openModalIfNoFields);
            }
        }

        var fieldsModalForFilterTableIndex = null;
        var fieldsModalForFilterSource = null; // 'dropdown' | 'modal'

        var filterModalTableIndex = null;

        function isStageLikeField(label, key) {
            var sample = ((label || '') + ' ' + (key || '')).toLowerCase();
            return sample.indexOf('стад') >= 0
                || sample.indexOf('stage') >= 0
                || sample.indexOf('status') >= 0
                || sample.indexOf('воронк') >= 0
                || sample.indexOf('pipeline') >= 0;
        }

        function isFunnelLikeField(label, key) {
            var sample = ((label || '') + ' ' + (key || '')).toLowerCase();
            return sample.indexOf('воронк') >= 0
                || sample.indexOf('funnel') >= 0
                || sample.indexOf('category') >= 0
                || sample.indexOf('pipeline') >= 0;
        }

        function isDropdownFieldType(fieldType) {
            var ft = String(fieldType || '').toLowerCase();
            if (!ft) return false;
            return ft.indexOf('enum') >= 0
                || ft.indexOf('list') >= 0
                || ft.indexOf('select') >= 0
                || ft.indexOf('status') >= 0
                || ft.indexOf('stage') >= 0
                || ft.indexOf('bool') >= 0;
        }

        function collectFieldOptions(st, colKey, filterField) {
            var options = [];
            if (!st || !st.fullData || !st.fullData.length || !colKey) return options;
            var seen = {};
            st.fullData.forEach(function(r) {
                var v = r[colKey];
                if (v == null || v === '') return;
                var s = String(v).trim();
                if (!s || seen[s]) return;
                seen[s] = true;
                options.push(s);
            });
            options.sort();
            if (options.length) return options;
            if (!isStageLikeField(filterField && filterField.label, filterField && filterField.key)) return options;
            var idx = String(colKey).indexOf('::');
            if (idx <= 0) return options;
            var entityPrefix = String(colKey).slice(0, idx);
            var wantFunnel = isFunnelLikeField(filterField && filterField.label, filterField && filterField.key);
            var first = st.fullData[0] || {};
            var siblingKeys = Object.keys(first).filter(function(k) {
                if (k.indexOf(entityPrefix + '::') !== 0) return false;
                var s = k.toLowerCase();
                if (wantFunnel) return s.indexOf('воронк') >= 0 || s.indexOf('funnel') >= 0 || s.indexOf('category') >= 0 || s.indexOf('pipeline') >= 0;
                return s.indexOf('stage') >= 0 || s.indexOf('status') >= 0 || s.indexOf('стад') >= 0;
            });
            if (!siblingKeys.length) return options;
            var seen2 = {};
            st.fullData.forEach(function(r) {
                siblingKeys.forEach(function(sk) {
                    var vv = r[sk];
                    if (vv == null || vv === '') return;
                    var ss = String(vv).trim();
                    if (!ss || seen2[ss]) return;
                    seen2[ss] = true;
                    options.push(ss);
                });
            });
            options.sort();
            return options;
        }

        function normalizeFieldLabel(s) {
            return String(s || '')
                .toLowerCase()
                .replace(/\s*\([^)]*\)\s*$/, '')
                .replace(/\s+/g, ' ')
                .trim();
        }

        function normalizeSearchText(s) {
            var out = String(s || '').toLowerCase().trim();
            if (out.normalize) out = out.normalize('NFD').replace(/[\u0300-\u036f]/g, '');
            return out;
        }

        function resolveFilterColumnKey(st, f) {
            if (!st || !f) return '';
            var candidate = String(f.key || '').trim();
            var idxCandidate = candidate.indexOf('::');
            var prefix = idxCandidate > 0 ? candidate.slice(0, idxCandidate) : '';
            var aliasCandidates = [];
            if (prefix) {
                if (f.sourceB24Field) aliasCandidates.push(prefix + '::' + String(f.sourceB24Field).trim());
                if (f.sourceColumnName) aliasCandidates.push(prefix + '::' + String(f.sourceColumnName).trim());
            }
            if (candidate) {
                var hasCandidate = (st.allColumns || []).some(function(c) { return c && c.key === candidate; });
                if (hasCandidate) return candidate;
                var first = (st.fullData && st.fullData.length) ? (st.fullData[0] || {}) : {};
                if (Object.prototype.hasOwnProperty.call(first, candidate)) return candidate;
            }
            if (aliasCandidates.length) {
                var allByKey = st.allColumns || [];
                var byAlias = aliasCandidates.find(function(a) { return allByKey.some(function(c) { return c && c.key === a; }); });
                if (byAlias) return byAlias;
                var firstRow = (st.fullData && st.fullData.length) ? (st.fullData[0] || {}) : {};
                var byAliasRow = aliasCandidates.find(function(a) { return Object.prototype.hasOwnProperty.call(firstRow, a); });
                if (byAliasRow) return byAliasRow;
            }
            var labelNorm = normalizeFieldLabel(f.label || '');
            if (!labelNorm) return candidate;
            var byLabel = (st.allColumns || []).find(function(c) { return normalizeFieldLabel(c && c.label) === labelNorm; });
            if (byLabel && byLabel.key) return byLabel.key;
            var byKeyTitle = (st.allColumns || []).find(function(c) {
                var key = String((c && c.key) || '');
                var idx = key.indexOf('::');
                var title = idx >= 0 ? key.slice(idx + 2) : key;
                return normalizeFieldLabel(title) === labelNorm;
            });
            if (byKeyTitle && byKeyTitle.key) return byKeyTitle.key;
            return candidate;
        }

        function updateMultiselectCaption(tagsDiv, selected) {
            renderMultiselectTags(tagsDiv, selected);
        }

        function shouldRenderAsMultiselect(st, f, options) {
            if (f && f.type === 'multiselect') return true;
            if (isStageLikeField(f && f.label, f && f.key)) return true;
            if (isDropdownFieldType(f && f.sourceFieldType)) return true;
            var totalRows = (st && st.fullData && st.fullData.length) ? st.fullData.length : 0;
            var uniqCount = options ? options.length : 0;
            if (!totalRows || !uniqCount) return false;
            return uniqCount <= 60 && uniqCount < Math.max(3, Math.floor(totalRows * 0.7));
        }

        function renderMultiselectTags(tagsDiv, selected) {
            if (!tagsDiv) return;
            var values = Array.isArray(selected) ? selected : [];
            var arrowHtml = '<i class="iconoir-nav-arrow-down ms-auto"></i>';
            if (!values.length) {
                tagsDiv.innerHTML = '<span class="filter-multiselect-caption text-muted small">Выберите...</span>' + arrowHtml;
                return;
            }
            var tagsHtml = values.map(function(v) {
                var txt = String(v || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/"/g, '&quot;');
                return '<span class="tag">' + txt + ' <span class="tag-remove" data-value="' + txt + '">&times;</span></span>';
            }).join('');
            tagsDiv.innerHTML = tagsHtml + arrowHtml;
        }

        function applyConfiguredFieldFilters(rows, st) {
            if (!rows || !rows.length || !st || !st.filterFields || !st.filterFields.length) return rows || [];
            return rows.filter(function(row) {
                return st.filterFields.every(function(f) {
                    if (!f || !f.key) return true;
                    var raw = row[f.key];
                    var cell = raw == null ? '' : String(raw).toLowerCase();
                    var type = f.type || (isStageLikeField(f.label, f.key) ? 'multiselect' : 'text');
                    var hasMultiSelection = Array.isArray(f.selectedValues) && f.selectedValues.length > 0;
                    if (type !== 'multiselect' && hasMultiSelection) type = 'multiselect';
                    if (type === 'multiselect') {
                        var selected = Array.isArray(f.selectedValues) ? f.selectedValues : [];
                        if (!selected.length) return true;
                        return selected.some(function(v) { return String(v).trim().toLowerCase() === cell; });
                    }
                    var q = (f.value != null) ? String(f.value).trim().toLowerCase() : '';
                    if (!q) return true;
                    return cell.indexOf(q) >= 0;
                });
            });
        }

        function syncGuestFilterFieldsWithColumns(tableIndex) {
            var st = tableStates[tableIndex];
            if (!st) return;
            var cols = (st.allColumns || []).filter(function(c) { return c && c.key && !isSystemColumn(c.key); });
            if (!cols.length) return;
            var colKeyMap = {};
            cols.forEach(function(c) { colKeyMap[c.key] = true; });
            var firstRow = (st.fullData && st.fullData.length) ? (st.fullData[0] || {}) : {};
            var existingByKey = {};
            (st.filterFields || []).forEach(function(f) {
                if (!f) return;
                var resolvedKey = resolveFilterColumnKey(st, f) || String(f.key || '').trim();
                if (!resolvedKey) return;
                existingByKey[resolvedKey] = f;
            });
            st.filterFields = cols.map(function(c) {
                var prev = existingByKey[c.key] || {};
                var probe = {
                    label: c.label || c.key,
                    key: c.key,
                    type: prev.type,
                    sourceFieldType: prev.sourceFieldType,
                    sourceB24Field: prev.sourceB24Field,
                    sourceColumnName: prev.sourceColumnName
                };
                var options = collectFieldOptions(st, c.key, probe);
                var type = shouldRenderAsMultiselect(st, probe, options) ? 'multiselect' : 'text';
                var next = {
                    label: c.label || c.key,
                    key: c.key,
                    type: type,
                    sourceFieldType: prev.sourceFieldType,
                    sourceB24Field: prev.sourceB24Field,
                    sourceColumnName: prev.sourceColumnName
                };
                if (type === 'multiselect') {
                    next.selectedValues = Array.isArray(prev.selectedValues) ? prev.selectedValues.slice() : [];
                } else {
                    next.value = (prev.value != null) ? String(prev.value) : '';
                }
                return next;
            });
            st.guestFilterInitialized = true;
        }

        function renderFilterRows(tableIndex, rowsContainer) {
            var st = tableStates[tableIndex];
            var container = rowsContainer || filterModalRowsContainerEl;
            if (!st || !container) return;
            var guestMode = isGuestUser();
            if (guestMode) syncGuestFilterFieldsWithColumns(tableIndex);
            var addFilterFieldInModalEl = document.getElementById('addFilterFieldInModal');
            if (addFilterFieldInModalEl) addFilterFieldInModalEl.classList.toggle('d-none', guestMode);
            if (!st.filterFields || !st.filterFields.length) st.filterFields = [{ label: 'Название', key: '', type: 'text' }];
            st.filterFields.forEach(function(f) {
                if ((f.key === '' || !f.key) && f.label === 'Название' && st.allColumns && st.allColumns.length) {
                    var col = st.allColumns.find(function(c) { return (c.label === 'Название') || (c.key && String(c.key).indexOf('Название') >= 0); });
                    if (col && col.key) f.key = col.key;
                }
            });
            container.innerHTML = '';
            st.filterFields.forEach(function(f, rowIdx) {
                var colKey = resolveFilterColumnKey(st, f);
                if (colKey) f.key = colKey;
                var options = collectFieldOptions(st, colKey, f);
                var type = shouldRenderAsMultiselect(st, f, options) ? 'multiselect' : 'text';
                var row = document.createElement('div');
                row.className = 'filter-row-item';
                row.setAttribute('data-filter-row-index', rowIdx);
                var head = document.createElement('div');
                head.className = 'd-flex align-items-center justify-content-between mb-1';
                var label = document.createElement('label');
                label.textContent = f.label || '';
                head.appendChild(label);
                if (!guestMode) {
                    var removeBtn = document.createElement('button');
                    removeBtn.type = 'button';
                    removeBtn.className = 'btn btn-link btn-sm text-danger p-0 ms-2';
                    removeBtn.textContent = 'Удалить';
                    removeBtn.addEventListener('click', function() {
                        st.filterFields.splice(rowIdx, 1);
                        if (!st.filterFields.length) st.filterFields = [{ label: 'Название', key: '', type: 'text' }];
                        renderFilterRows(tableIndex, container);
                    });
                    head.appendChild(removeBtn);
                }
                row.appendChild(head);
                if (type === 'multiselect') {
                    if (!f.selectedValues || !Array.isArray(f.selectedValues)) f.selectedValues = [];
                    var selected = f.selectedValues;
                    var wrap = document.createElement('div');
                    wrap.className = 'filter-multiselect-wrap';
                    var tagsDiv = document.createElement('div');
                    tagsDiv.className = 'filter-multiselect-tags';
                    tagsDiv.setAttribute('data-column-key', colKey);
                    renderMultiselectTags(tagsDiv, selected);
                    var drop = document.createElement('div');
                    drop.className = 'filter-multiselect-dropdown';
                    var searchWrap = document.createElement('div');
                    searchWrap.className = 'filter-multiselect-search-wrap';
                    var searchInput = document.createElement('input');
                    searchInput.type = 'text';
                    searchInput.className = 'form-control form-control-sm filter-multiselect-search';
                    searchInput.placeholder = 'Поиск по значениям...';
                    searchWrap.appendChild(searchInput);
                    drop.appendChild(searchWrap);
                    options.forEach(function(opt) {
                        var cb = document.createElement('label');
                        cb.className = 'form-check filter-option-item';
                        cb.setAttribute('data-option-text', String(opt).toLowerCase());
                        var checked = selected.indexOf(opt) >= 0;
                        cb.innerHTML = '<input class="form-check-input filter-multiselect-option" type="checkbox" value="' + String(opt).replace(/"/g, '&quot;') + '"' + (checked ? ' checked' : '') + '><span class="form-check-label">' + String(opt).replace(/</g, '&lt;') + '</span>';
                        drop.appendChild(cb);
                    });
                    if (!options.length) {
                        var empty = document.createElement('div');
                        empty.className = 'small text-muted px-3 py-2 filter-multiselect-empty';
                        empty.textContent = 'Нет значений';
                        drop.appendChild(empty);
                    }
                    wrap.appendChild(tagsDiv);
                    wrap.appendChild(drop);
                    tagsDiv.addEventListener('click', function(e) {
                        var removeEl = e.target.closest('.tag-remove');
                        if (removeEl) {
                            e.preventDefault();
                            e.stopPropagation();
                            var valToRemove = removeEl.getAttribute('data-value');
                            var idxSel = selected.indexOf(valToRemove);
                            if (idxSel >= 0) selected.splice(idxSel, 1);
                            st.filterFields[rowIdx].selectedValues = selected.slice();
                            drop.querySelectorAll('.filter-multiselect-option').forEach(function(ch) {
                                if (ch.value === valToRemove) ch.checked = false;
                            });
                            updateMultiselectCaption(tagsDiv, selected);
                            return;
                        }
                        drop.classList.toggle('open');
                        if (drop.classList.contains('open')) {
                            searchInput.focus();
                            setTimeout(function() {
                                function closeDrop() {
                                    drop.classList.remove('open');
                                    document.removeEventListener('click', closeDrop);
                                }
                                document.addEventListener('click', closeDrop);
                            }, 0);
                        }
                    });
                    drop.querySelectorAll('.filter-multiselect-option').forEach(function(cb) {
                        cb.addEventListener('change', function() {
                            var val = this.value;
                            if (this.checked) {
                                if (selected.indexOf(val) < 0) selected.push(val);
                            } else {
                                var idx = selected.indexOf(val);
                                if (idx >= 0) selected.splice(idx, 1);
                            }
                            st.filterFields[rowIdx].selectedValues = selected.slice();
                            updateMultiselectCaption(tagsDiv, selected);
                        });
                    });
                    function applyDropdownSearch() {
                        var q = normalizeSearchText(searchInput.value || '');
                        var visibleCount = 0;
                        drop.querySelectorAll('.filter-multiselect-option').forEach(function(ch) {
                            var host = ch.closest('.form-check');
                            if (!host) return;
                            var labelTextEl = host.querySelector('.form-check-label');
                            var text = normalizeSearchText(labelTextEl ? labelTextEl.textContent : '');
                            var show = !q || text.indexOf(q) >= 0;
                            host.classList.toggle('d-none', !show);
                            if (show) visibleCount++;
                        });
                        var emptyEl = drop.querySelector('.filter-multiselect-empty');
                        if (emptyEl) {
                            if (options.length === 0) {
                                emptyEl.textContent = 'Нет значений';
                                emptyEl.style.display = '';
                            } else if (visibleCount === 0) {
                                emptyEl.textContent = 'Ничего не найдено';
                                emptyEl.style.display = '';
                            } else {
                                emptyEl.style.display = 'none';
                            }
                        }
                    }
                    searchInput.addEventListener('input', applyDropdownSearch);
                    searchInput.addEventListener('keyup', applyDropdownSearch);
                    searchInput.addEventListener('change', applyDropdownSearch);
                    wrap.addEventListener('click', function(e) { e.stopPropagation(); });
                    row.appendChild(wrap);
                } else {
                    var inp = document.createElement('input');
                    inp.type = 'text';
                    inp.className = 'form-control form-control-sm filter-text-input';
                    inp.placeholder = '';
                    inp.value = f.value != null ? String(f.value) : '';
                    inp.setAttribute('data-filter-row-index', rowIdx);
                    inp.addEventListener('input', function() { st.filterFields[rowIdx].value = this.value; });
                    row.appendChild(inp);
                }
                container.appendChild(row);
            });
        }

        function refreshFilterModalIfOpen(tableIndex) {
            var modalEl = document.getElementById('modalFilter');
            if (!modalEl || !modalEl.classList.contains('show')) return;
            if (filterModalTableIndex == null || filterModalTableIndex !== tableIndex) return;
            renderFilterRows(tableIndex, filterModalRowsContainerEl);
        }

        function closeFilterDropdown(tableIndex) {
            var els = getSectionEls(tableIndex);
            if (els && els.filterDropdown) els.filterDropdown.classList.remove('open');
        }

        function closeAllFilterDropdowns(exceptTableIndex) {
            if (!entityTablesContainer) return;
            entityTablesContainer.querySelectorAll('.entity-table-section').forEach(function(section) {
                var idx = parseInt(section.getAttribute('data-table-index'), 10);
                if (exceptTableIndex != null && !isNaN(idx) && idx === exceptTableIndex) return;
                var drop = section.querySelector('.filterDropdownInSection');
                if (drop) drop.classList.remove('open');
            });
        }

        function openFilterDropdown(tableIndex) {
            var els = getSectionEls(tableIndex);
            if (!els || !els.filterDropdown || !els.filterDropdownRowsContainer) return;
            closeAllFilterDropdowns(tableIndex);
            filterModalTableIndex = tableIndex;
            fieldsModalForFilterSource = 'dropdown';
            renderFilterRows(tableIndex, els.filterDropdownRowsContainer);
            if (els.filterDropdownAdd) els.filterDropdownAdd.classList.toggle('d-none', isGuestUser());
            els.filterDropdown.classList.add('open');
        }

        function openFilterModal(tableIndex) {
            closeAllFilterDropdowns();
            filterModalTableIndex = tableIndex;
            fieldsModalForFilterSource = 'modal';
            renderFilterRows(tableIndex, filterModalRowsContainerEl);
            modalFilter.show();
        }

        function getTableClassesForStyle(styleKey) {
            var s = TABLE_STYLES[styleKey] || TABLE_STYLES.default;
            return (s.tableClass || '') + ' datatable datatable-table entityTableInSection entity-table-section-table';
        }
        function getTheadClassesForStyle(styleKey) {
            var s = TABLE_STYLES[styleKey] || TABLE_STYLES.default;
            return (s.theadClass || '') + ' entity-table-grid-head';
        }
        function getTableCaptionForStyle(styleKey) {
            var s = TABLE_STYLES[styleKey] || TABLE_STYLES.default;
            return s.caption === true;
        }

        function createSectionHtml(tableIndex) {
            var st = tableStates[tableIndex];
            var styleKey = (st && st.tableStyle) ? st.tableStyle : 'hoverable_rows';
            var tableCls = getTableClassesForStyle(styleKey);
            var theadCls = getTheadClassesForStyle(styleKey);
            var hasCaption = getTableCaptionForStyle(styleKey);
            var captionHtml = hasCaption ? '<caption class="entity-table-caption">' + (st && st.tableDescription ? String(st.tableDescription).replace(/</g, '&lt;').replace(/>/g, '&gt;') : 'Данные таблицы') + '</caption>' : '';
            return '<div class="entity-table-section" data-table-index="' + tableIndex + '">' +
                '<div class="entity-table-toolbar d-flex align-items-center flex-wrap">' +
                '<button type="button" class="btn btn-primary btn-plus-content btnAddEntityInSection" title="Добавить сущность / настройки таблицы"><i class="iconoir-plus"></i></button>' +
                '<span class="entity-table-section-hidden-label text-muted small d-none">Блок скрыт</span>' +
                '<div class="table-mode-admin ms-2" style="display:none!important"><select class="form-select form-select-sm tableModeSelect" title="Режим таблицы" data-table-index="' + tableIndex + '" style="width:auto;min-width:120px">' +
                '<option value="edit">Редактирование</option><option value="read_only">Только просмотр</option><option value="hide">Скрыть</option></select></div></div>' +
                '<div class="entity-table-loading loadingBlockInSection d-none"><div class="spinner-border text-primary" role="status"></div><p class="mb-0 mt-2 loadingTextInSection">Загрузка...</p></div>' +
                '<div class="d-flex align-items-center gap-2 flex-wrap gridTopRowInSection searchFilterRowInSection table-title-search-row d-none mb-2"><div class="tableTitleBlockInSection d-none flex-grow-1"><h4 class="mb-0 tableTitleTextInSection" data-placeholder="Название таблицы"></h4></div><div class="input-group input-group-sm searchFilterInputWrap"><span class="input-group-text"><i class="iconoir-search"></i></span><input type="text" class="form-control searchFilterInputInSection" placeholder="Поиск, фильтр…" autocomplete="off" aria-label="Поиск по таблице"></div><button type="button" class="btn btn-outline-secondary btn-search-filter-gear" title="Настройки поиска и фильтра" aria-label="Настройки поиска"><i class="iconoir-settings"></i></button><div class="flex-grow-1"></div><button type="button" class="btn btn-outline-secondary btn-gear btnFieldsInSection d-none" title="Настроить поля таблицы" aria-label="Настройки таблицы"><i class="iconoir-settings"></i></button><div class="filterDropdownInSection"><div class="filterDropdownCardInSection filterPanelInSection"><div class="filterDropdownRowsContainerInSection"></div><a href="javascript:void(0)" class="addFilterFieldInDropdownInSection text-primary small mt-2 d-inline-block">Добавить поле</a><div class="d-flex justify-content-end gap-2 mt-3"><button type="button" class="btn btn-outline-secondary btn-sm filterDropdownCloseInSection">Закрыть</button><button type="button" class="btn btn-primary btn-sm filterDropdownSaveInSection">Сохранить</button></div></div></div></div>' +
                '<div class="entity-table-grid-wrap table-responsive gridBlockInSection d-none"><table class="' + tableCls + '">' +
                (hasCaption ? captionHtml : '') + '<thead class="' + theadCls + '"></thead><tbody class="entity-table-grid-body"></tbody></table></div>' +
                '<div class="datatable-bottom paginationBlockInSection d-none"><div class="pagination-left-in-section d-flex align-items-center flex-wrap gap-2"><span class="datatable-info small text-muted paginationInfoInSection">Показано 0 — 0 из 0 записей</span><span class="small text-muted">На странице:</span><select class="datatable-input pageSizeInSection" style="width:70px;"><option value="10">10</option><option value="25" selected>25</option><option value="50">50</option></select></div><nav class="datatable-pagination paginationNavInSection" aria-label="Пагинация таблицы"></nav></div></div>';
        }

        /** Report card section HTML: title, main value, secondary, icon; settings on double-click, delete in modal */
        function createCardSectionHtml(cardIndex) {
            var st = tableStates[cardIndex];
            var icon = (st && st.icon) ? st.icon : 'iconoir-activity';
            var iconClass = 'bg-primary-subtle text-primary';
            return '<div class="entity-report-card-section" data-card-index="' + cardIndex + '" role="button" tabindex="0" title="Двойной клик — настройки">' +
                '<div class="card report-card">' +
                '<div class="card-body">' +
                '<div class="row d-flex justify-content-center align-items-center">' +
                '<div class="col">' +
                '<p class="report-card-title text-dark mb-0"></p>' +
                '<h3 class="report-card-main-value my-1 fs-20">—</h3>' +
                '<p class="report-card-secondary-value text-muted mb-0"></p>' +
                '</div>' +
                '<div class="col-auto align-self-center">' +
                '<div class="report-card-icon-wrap ' + iconClass + '"><i class="' + icon + ' fs-4"></i></div>' +
                '</div>' +
                '</div>' +
                '</div>' +
                '</div>' +
                '</div>' +
                '</div>';
        }

        function ensureSections() {
            if (!entityTablesContainer) return;
            var sectionNodes = [].slice.call(entityTablesContainer.children).filter(function(c) {
                return c.classList && (c.classList.contains('entity-table-section') || c.classList.contains('entity-report-card-section'));
            });
            var existing = sectionNodes.length;
            for (var i = existing; i < tableStates.length; i++) {
                var st = tableStates[i];
                var div = document.createElement('div');
                div.innerHTML = (st.type === 'card') ? createCardSectionHtml(i) : createSectionHtml(i);
                var errEl = document.getElementById('entityTablesError');
                if (errEl && errEl.parentNode === entityTablesContainer) errEl.classList.add('d-none');
                entityTablesContainer.appendChild(div.firstElementChild);
            }
            for (var s = 0; s < 100; s++) {
                sectionNodes = [].slice.call(entityTablesContainer.children).filter(function(c) {
                    return c.classList && (c.classList.contains('entity-table-section') || c.classList.contains('entity-report-card-section'));
                });
                if (sectionNodes.length <= tableStates.length) break;
                if (sectionNodes[sectionNodes.length - 1]) sectionNodes[sectionNodes.length - 1].remove();
            }
            sectionNodes = [].slice.call(entityTablesContainer.children).filter(function(c) {
                return c.classList && (c.classList.contains('entity-table-section') || c.classList.contains('entity-report-card-section'));
            });
            for (var idx = 0; idx < sectionNodes.length; idx++) {
                var section = sectionNodes[idx];
                if (section.classList.contains('entity-report-card-section')) {
                    section.setAttribute('data-card-index', String(idx));
                } else {
                    section.setAttribute('data-table-index', String(idx));
                    var modeSel = section.querySelector('.tableModeSelect');
                    if (modeSel) modeSel.setAttribute('data-table-index', String(idx));
                }
            }
            syncRowBreaks();
            bindSectionListeners();
            bindSectionDragDrop();
            renderComponentModesAdmin();
        }

        /** Insert row-break elements before sections that have startNewRow so layout shows custom rows; responsive wrap unchanged. */
        function syncRowBreaks() {
            if (!entityTablesContainer) return;
            entityTablesContainer.querySelectorAll('.entity-table-row-break').forEach(function(el) { el.remove(); });
            var sectionNodes = [].slice.call(entityTablesContainer.children).filter(function(c) {
                return c.classList && (c.classList.contains('entity-table-section') || c.classList.contains('entity-report-card-section'));
            });
            for (var i = 0; i < sectionNodes.length; i++) {
                if (tableStates[i] && tableStates[i].startNewRow === true) {
                    var br = document.createElement('div');
                    br.className = 'entity-table-row-break';
                    br.setAttribute('aria-hidden', 'true');
                    entityTablesContainer.insertBefore(br, sectionNodes[i]);
                }
            }
        }

        function bindSectionDragDrop() {
            if (!entityTablesContainer || isGuestUser()) return;
            var sectionNodes = [].slice.call(entityTablesContainer.children).filter(function(c) {
                return c.classList && (c.classList.contains('entity-table-section') || c.classList.contains('entity-report-card-section'));
            });
            var draggedIndex = null;
            sectionNodes.forEach(function(section, idx) {
                section.setAttribute('data-section-index', String(idx));
                section.draggable = true;
                section.classList.add('entity-section-draggable');
            });
            entityTablesContainer.querySelectorAll('.entity-table-section, .entity-report-card-section').forEach(function(section) {
                section.ondragstart = function(e) {
                    var i = section.getAttribute('data-table-index');
                    if (i == null) i = section.getAttribute('data-card-index');
                    draggedIndex = i != null ? parseInt(i, 10) : -1;
                    e.dataTransfer.setData('text/plain', String(draggedIndex));
                    e.dataTransfer.effectAllowed = 'move';
                };
                section.ondragend = function() {
                    entityTablesContainer.querySelectorAll('.entity-drop-new-row').forEach(function(el) { el.classList.remove('entity-drop-new-row'); });
                };
                section.ondragover = function(e) {
                    e.preventDefault();
                    e.dataTransfer.dropEffect = 'move';
                    var rect = section.getBoundingClientRect();
                    var inLowerHalf = e.clientY >= rect.top + rect.height / 2;
                    if (inLowerHalf) section.classList.add('entity-drop-new-row'); else section.classList.remove('entity-drop-new-row');
                };
                section.ondragleave = function() { section.classList.remove('entity-drop-new-row'); };
                section.ondrop = function(e) {
                    e.preventDefault();
                    section.classList.remove('entity-drop-new-row');
                    var toIdx = section.getAttribute('data-table-index');
                    if (toIdx == null) toIdx = section.getAttribute('data-card-index');
                    toIdx = toIdx != null ? parseInt(toIdx, 10) : -1;
                    if (draggedIndex < 0 || toIdx < 0 || draggedIndex === toIdx) return;
                    var rect = section.getBoundingClientRect();
                    var dropNewRow = e.clientY >= rect.top + rect.height / 2;
                    var state = tableStates.splice(draggedIndex, 1)[0];
                    tableStates.splice(toIdx, 0, state);
                    state.startNewRow = dropNewRow;
                    var sections = [].slice.call(entityTablesContainer.children).filter(function(c) {
                        return c.classList && (c.classList.contains('entity-table-section') || c.classList.contains('entity-report-card-section'));
                    });
                    var fromEl = sections[draggedIndex];
                    var toEl = sections[toIdx];
                    if (fromEl && toEl && fromEl !== toEl) {
                        if (toIdx < draggedIndex) entityTablesContainer.insertBefore(fromEl, toEl);
                        else entityTablesContainer.insertBefore(fromEl, toEl.nextSibling || null);
                    }
                    ensureSections();
                    saveConfigToStorage();
                    saveConfig();
                };
            });
        }

        function bindSectionListeners() {
            if (!entityTablesContainer) return;
            entityTablesContainer.querySelectorAll('.btnDeleteTableInSection').forEach(function(btn) {
                var section = btn.closest('.entity-table-section');
                if (!section) return;
                var idx = parseInt(section.getAttribute('data-table-index'), 10);
                btn.onclick = function() {
                    deleteTableAtIndex(idx);
                };
            });
            entityTablesContainer.querySelectorAll('.btnAddEntityInSection').forEach(function(btn) {
                var section = btn.closest('.entity-table-section');
                var idx = parseInt(section.getAttribute('data-table-index'), 10);
                btn.onclick = function() { currentTableIndex = idx; openEntityModal(); };
            });
            entityTablesContainer.querySelectorAll('.btnFieldsInSection').forEach(function(btn) {
                var section = btn.closest('.entity-table-section');
                var idx = parseInt(section.getAttribute('data-table-index'), 10);
                btn.onclick = function() { currentTableIndex = idx; openFieldsModal(); };
            });
            entityTablesContainer.querySelectorAll('.btn-search-filter-gear').forEach(function(btn) {
                var section = btn.closest('.entity-table-section');
                if (!section) return;
                var idx = parseInt(section.getAttribute('data-table-index'), 10);
                btn.onclick = function() {
                    if (isGuestUser()) return;
                    openFilterModal(idx);
                };
            });
            entityTablesContainer.querySelectorAll('.addFilterFieldInDropdownInSection').forEach(function(btn) {
                var section = btn.closest('.entity-table-section');
                if (!section) return;
                var idx = parseInt(section.getAttribute('data-table-index'), 10);
                btn.onclick = function(e) {
                    e.preventDefault();
                    if (isGuestUser()) return;
                    fieldsModalForFilterTableIndex = idx;
                    fieldsModalForFilterSource = 'dropdown';
                    currentTableIndex = idx;
                    closeFilterDropdown(idx);
                    openFieldsModal();
                };
            });
            entityTablesContainer.querySelectorAll('.filterDropdownSaveInSection').forEach(function(btn) {
                var section = btn.closest('.entity-table-section');
                if (!section) return;
                var idx = parseInt(section.getAttribute('data-table-index'), 10);
                btn.onclick = function() {
                    if (tableStates[idx]) {
                        tableStates[idx].currentPage = 1;
                        saveConfigToStorage();
                        saveConfig();
                        loadData(idx);
                    }
                    closeFilterDropdown(idx);
                };
            });
            entityTablesContainer.querySelectorAll('.filterDropdownCloseInSection').forEach(function(btn) {
                var section = btn.closest('.entity-table-section');
                if (!section) return;
                var idx = parseInt(section.getAttribute('data-table-index'), 10);
                btn.onclick = function() {
                    closeFilterDropdown(idx);
                };
            });
            if (entityTablesContainer && !entityTablesContainer._cardDblclickBound) {
                entityTablesContainer._cardDblclickBound = true;
                entityTablesContainer.addEventListener('dblclick', function(e) {
                    var section = e.target && e.target.closest && e.target.closest('.entity-report-card-section');
                    if (!section || isGuestUser()) return;
                    var idx = parseInt(section.getAttribute('data-card-index'), 10);
                    if (!isNaN(idx)) openAddCardModal(idx);
                });
            }
            var addFilterFieldInModalEl = document.getElementById('addFilterFieldInModal');
            if (addFilterFieldInModalEl) addFilterFieldInModalEl.onclick = function(e) {
                e.preventDefault();
                if (isGuestUser()) return;
                if (filterModalTableIndex == null) return;
                fieldsModalForFilterTableIndex = filterModalTableIndex;
                fieldsModalForFilterSource = 'modal';
                currentTableIndex = filterModalTableIndex;
                modalFilter.hide();
                openFieldsModal();
            };
            var modalFilterSaveEl = document.getElementById('modalFilterSave');
            if (modalFilterSaveEl) modalFilterSaveEl.onclick = function() {
                if (filterModalTableIndex != null && tableStates[filterModalTableIndex]) {
                    tableStates[filterModalTableIndex].currentPage = 1;
                    saveConfigToStorage();
                    saveConfig();
                    loadData(filterModalTableIndex);
                }
                modalFilter.hide();
            };
            entityTablesContainer.querySelectorAll('.pageSizeInSection').forEach(function(sel) {
                var section = sel.closest('.entity-table-section');
                var idx = parseInt(section.getAttribute('data-table-index'), 10);
                sel.onchange = function() {
                    tableStates[idx].pageSize = parseInt(this.value, 10) || 25;
                    tableStates[idx].currentPage = 1;
                    renderGrid(idx);
                };
            });
            entityTablesContainer.querySelectorAll('.searchFilterInputInSection').forEach(function(inp) {
                var section = inp.closest('.entity-table-section');
                if (!section) return;
                var idx = parseInt(section.getAttribute('data-table-index'), 10);
                inp.onfocus = function() { openFilterDropdown(idx); };
                inp.onclick = function() { openFilterDropdown(idx); };
                inp.oninput = function() { closeFilterDropdown(idx); };
                inp.onkeydown = function(e) {
                    if (e.key !== 'Enter') return;
                    e.preventDefault();
                    if (!tableStates[idx]) return;
                    tableStates[idx].currentPage = 1;
                    renderGrid(idx);
                };
            });
            if (!document._entityFilterDropdownHandlersBound) {
                document._entityFilterDropdownHandlersBound = true;
                document.addEventListener('click', function(e) {
                    var t = e.target;
                    if (!t || !t.closest) { closeAllFilterDropdowns(); return; }
                    if (t.closest('.filterDropdownInSection')) return;
                    if (t.closest('.searchFilterInputInSection')) return;
                    if (t.closest('.btn-search-filter-gear')) return;
                    closeAllFilterDropdowns();
                });
                document.addEventListener('keydown', function(e) {
                    if (e.key === 'Escape') closeAllFilterDropdowns();
                });
            }
        }

        /** Делегирование: клики по кнопкам пагинации (prev/next/номер страницы) — привязывается один раз. */
        if (entityTablesContainer && !entityTablesContainer._paginationDelegationBound) {
            entityTablesContainer._paginationDelegationBound = true;
            entityTablesContainer.addEventListener('click', function(e) {
                var btn = e.target && e.target.closest && e.target.closest('[data-page]');
                if (!btn || !btn.closest('.paginationNavInSection')) return;
                var section = btn.closest('.entity-table-section');
                if (!section) return;
                var idx = parseInt(section.getAttribute('data-table-index'), 10);
                if (isNaN(idx) || !tableStates[idx]) return;
                var st = tableStates[idx];
                var page = btn.getAttribute('data-page');
                var totalPages = st.fullData.length ? Math.ceil(st.fullData.length / st.pageSize) : 0;
                if (page === 'prev' && st.currentPage > 1) { st.currentPage--; renderGrid(idx); }
                else if (page === 'next' && st.currentPage < totalPages) { st.currentPage++; renderGrid(idx); }
                else if (page !== 'prev' && page !== 'next') { var p = parseInt(page, 10); if (p >= 1 && p <= totalPages) { st.currentPage = p; renderGrid(idx); } }
            });
        }

        /** Загрузка конфига: сначала с сервера; если пусто или ошибка — восстанавливаем из localStorage. */
        function loadConfig() {
            var slug = getPageSlug();
            if (!isDashboardSlug() && canUseLocalTableStorage()) { try { localStorage.removeItem(STORAGE_KEY_PREFIX + slug); } catch (e) {} }
            fetch(API.config + '?page_slug=' + encodeURIComponent(slug))
                .then(function(r) {
                    if (!r.ok) return Promise.reject(new Error(r.status));
                    return r.json();
                })
                .then(function(data) {
                    if (!data || !data.ok) { if (isDashboardSlug()) showDashboardLoadError(); else tryApplyStored(); return; }
                    lastRemoteConfigSignature = getRemoteConfigSignature(data);
                    if (data.tables && Array.isArray(data.tables) && data.tables.length > 0) {
                        var isDashboard = !!(data.read_only || isDashboardSlug());
                        tableStates = data.tables.map(function(t) {
                            var norm = normalizeEntitiesAndFields(t.entities || [], t.fields || []);
                            var orderFromServer = (t.column_order && Array.isArray(t.column_order)) ? t.column_order : null;
                            var widthsFromServer = (t.column_widths && typeof t.column_widths === 'object') ? t.column_widths : {};
                            return {
                                selectedEntities: norm.entities,
                                selectedFields: norm.fields,
                                tableTitle: (t.table_title != null) ? String(t.table_title) : '',
                                tableDescription: (t.table_description != null) ? String(t.table_description) : '',
                                tableStyle: (t.table_style && TABLE_STYLES[t.table_style]) ? t.table_style : 'hoverable_rows',
                                fullData: [],
                                allColumns: [],
                                currentPage: 1,
                                pageSize: 25,
                                columnOrderFromServer: orderFromServer,
                                columnWidths: isDashboard ? {} : (Object.keys(widthsFromServer).length ? widthsFromServer : {}),
                                sortKey: (t.sort_key != null) ? String(t.sort_key) : '',
                                sortDir: (t.sort_dir === 'asc' || t.sort_dir === 'desc') ? t.sort_dir : '',
                                showTime: (t.show_time === true),
                                dateTimeDisplayByColumn: (t.date_time_display && typeof t.date_time_display === 'object') ? t.date_time_display : {},
                                customFields: (t.custom_fields && Array.isArray(t.custom_fields)) ? t.custom_fields : [],
                                selectedCustomFieldCodes: (t.selected_custom_fields && Array.isArray(t.selected_custom_fields)) ? t.selected_custom_fields : [],
                                filterFields: (t.filter_fields && Array.isArray(t.filter_fields)) ? t.filter_fields : [{ label: 'Название', key: '', type: 'text' }]
                            };
                        });
                        tableStates = tableStates.filter(isConfiguredSectionState);
                        var stored = isGuestUser() ? null : loadConfigFromStorage();
                        if (stored && stored.tables && Array.isArray(stored.tables)) {
                            tableStates.forEach(function(st, i) {
                                var s = stored.tables[i];
                                if (s && s.table_style && TABLE_STYLES[s.table_style]) st.tableStyle = s.table_style;
                            });
                        }
                        ensureSections();
                        tableStates.forEach(function(st, i) {
                            applyTableStyleToSection(i);
                        });
                        applyTableModes(data.table_modes);
                        tableStates.forEach(function(st, i) {
                            if (!isDashboard && (!st.columnWidths || !Object.keys(st.columnWidths).length)) st.columnWidths = loadColumnWidths(i);
                            updateUI(i);
                            loadFieldsThenData(i, false);
                        });
                        saveConfigToStorage();
                        isReadOnly = isGuestUser();
                        currentPageMode = (data.page_mode || 'edit').toLowerCase();
                        currentTableModes = data.table_modes && typeof data.table_modes === 'object' ? Object.assign({}, data.table_modes) : {};
                        applyPageMode(data.page_mode);
                        applyReadOnlyMode();
                        renderComponentModesAdmin();
                        bindComponentModesListeners();
                        return;
                    }
                    if (data.entities && Array.isArray(data.entities) && data.entities.length > 0) {
                        var norm = normalizeEntitiesAndFields(data.entities, data.fields || []);
                        tableStates = [{
                            selectedEntities: norm.entities,
                            selectedFields: norm.fields,
                            tableTitle: (data.table_title != null) ? String(data.table_title) : '',
                            tableDescription: (data.table_description != null) ? String(data.table_description) : '',
                            tableStyle: (data.table_style && TABLE_STYLES[data.table_style]) ? data.table_style : 'hoverable_rows',
                            fullData: [],
                            allColumns: [],
                            currentPage: 1,
                            pageSize: 25,
                            columnWidths: loadColumnWidths(0),
                            sortKey: (data.sort_key != null) ? String(data.sort_key) : '',
                            sortDir: (data.sort_dir === 'asc' || data.sort_dir === 'desc') ? data.sort_dir : '',
                            showTime: (data.show_time === true),
                            dateTimeDisplayByColumn: (data.date_time_display && typeof data.date_time_display === 'object') ? data.date_time_display : {},
                            filterFields: (data.filter_fields && Array.isArray(data.filter_fields)) ? data.filter_fields : [{ label: 'Название', key: '', type: 'text' }]
                        }];
                        ensureSections();
                        applyTableStyleToSection(0);
                        applyTableModes(data.table_modes);
                        updateUI(0);
                        loadFieldsThenData(0, false);
                        saveConfigToStorage();
                        isReadOnly = isGuestUser();
                        currentPageMode = (data.page_mode || 'edit').toLowerCase();
                        currentTableModes = data.table_modes && typeof data.table_modes === 'object' ? Object.assign({}, data.table_modes) : {};
                        applyPageMode(data.page_mode);
                        applyReadOnlyMode();
                        renderComponentModesAdmin();
                        bindComponentModesListeners();
                        return;
                    }
                    if (isDashboardSlug()) {
                        showDashboardLoadError();
                        return;
                    }
                    tableStates = [];
                    ensureSections();
                    applyTableModes(data.table_modes);
                    isReadOnly = isGuestUser();
                    currentPageMode = (data.page_mode || 'edit').toLowerCase();
                    currentTableModes = data.table_modes && typeof data.table_modes === 'object' ? Object.assign({}, data.table_modes) : {};
                    applyPageMode(data.page_mode);
                    applyReadOnlyMode();
                    renderComponentModesAdmin();
                    bindComponentModesListeners();
                    if (canUseLocalTableStorage()) { try { localStorage.removeItem(STORAGE_KEY_PREFIX + getPageSlug()); } catch (e) {} }
                    return;
                })
                .catch(function() { if (isDashboardSlug()) showDashboardLoadError(); else tryApplyStored(); });

            function showDashboardLoadError() {
                tableStates = [];
                ensureSections();
                isReadOnly = isGuestUser();
                applyReadOnlyMode();
                var errEl = document.getElementById('entityTablesError');
                if (errEl) { errEl.classList.remove('d-none'); errEl.textContent = 'Не удалось загрузить дэшборд. Проверьте подключение или обновите страницу.'; }
            }

            function tryApplyStored() {
                var stored = loadConfigFromStorage();
                if (stored && stored.tables && Array.isArray(stored.tables) && stored.tables.length > 0) {
                    applyConfig(stored, false);
                } else if (stored) {
                    applyConfig(stored, false);
                } else {
                    tableStates = [];
                    ensureSections();
                }
                isReadOnly = isGuestUser();
                applyReadOnlyMode();
            }
        }

        function getRemoteConfigSignature(data) {
            try {
                return JSON.stringify({
                    page_mode: data && data.page_mode ? data.page_mode : '',
                    table_modes: data && data.table_modes ? data.table_modes : {},
                    tables: data && Array.isArray(data.tables) ? data.tables : [],
                    entities: data && Array.isArray(data.entities) ? data.entities : [],
                    fields: data && Array.isArray(data.fields) ? data.fields : [],
                    table_title: data && data.table_title ? data.table_title : '',
                    table_description: data && data.table_description ? data.table_description : ''
                });
            } catch (e) {
                return '';
            }
        }

        function startGuestConfigAutoRefresh() {
            if (!isGuestUser()) return;
            if (guestConfigRefreshTimer) return;
            guestConfigRefreshTimer = setInterval(function() {
                if (document.hidden) return;
                var slug = getPageSlug();
                fetch(API.config + '?page_slug=' + encodeURIComponent(slug))
                    .then(function(r) { if (!r.ok) throw new Error(String(r.status || '')); return r.json(); })
                    .then(function(data) {
                        if (!data || !data.ok) return;
                        var nextSig = getRemoteConfigSignature(data);
                        if (!nextSig) return;
                        if (lastRemoteConfigSignature && nextSig === lastRemoteConfigSignature) return;
                        loadConfig();
                    })
                    .catch(function() {});
            }, 4000);
        }

        function saveConfig(opts) {
            opts = opts || {};
            var slug = getPageSlug();
            var tables = [];
            tableStates.forEach(function(st, i) {
                if (st.type === 'card' && window.EntityCard && typeof window.EntityCard.serializeCardState === 'function') {
                    tables.push(window.EntityCard.serializeCardState(st));
                    return;
                }
                if (st.type === 'card') {
                    tables.push({
                        type: 'card',
                        card_title: st.cardTitle,
                        icon: st.icon || 'iconoir-activity',
                        entities: st.selectedEntities,
                        fields: st.selectedFields,
                        filter_fields: (st.filterFields && st.filterFields.length) ? st.filterFields : [],
                        main_formula: st.mainFormula || { aggregate: 'count', fieldKey: null },
                        secondary_formula: st.secondaryFormula || null,
                        start_new_row: (st.startNewRow === true)
                    });
                    return;
                }
                var keys = (st.allColumns && st.allColumns.length) ? st.allColumns.map(function(c) { return c.key; }) : getColumnKeysFromSection(i);
                tables.push({
                    type: 'table',
                    table_title: st.tableTitle,
                    table_description: st.tableDescription,
                    table_style: st.tableStyle || 'hoverable_rows',
                    entities: st.selectedEntities,
                    fields: buildFieldsFromAllColumns(st),
                    custom_fields: (st.customFields && Array.isArray(st.customFields)) ? st.customFields : [],
                    selected_custom_fields: ensureSelectedCustomFieldCodes(st).slice(),
                    filter_fields: getPersistedTableFilterFields(st),
                    column_order: keys.length ? keys : null,
                    column_widths: (st.columnWidths && Object.keys(st.columnWidths).length) ? st.columnWidths : null,
                    sort_key: st.sortKey || null,
                    sort_dir: st.sortDir || null,
                    show_time: (st.showTime === true),
                    date_time_display: (st.dateTimeDisplayByColumn && Object.keys(st.dateTimeDisplayByColumn).length) ? st.dateTimeDisplayByColumn : null,
                    start_new_row: (st.startNewRow === true)
                });
            });
            var payload = { page_slug: slug, tables: tables };
            var fetchOpts = {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload),
            };
            if (opts.keepalive) fetchOpts.keepalive = true;
            return fetch(API.config, fetchOpts)
                .then(function(r) {
                    if (!r.ok) throw new Error('Save failed: ' + r.status);
                    return r.json();
                })
                .then(function(data) {
                    if (data && !data.ok) throw new Error(data.error || 'Save failed');
                })
                .catch(function(err) {
                    if (typeof console !== 'undefined' && console.error) console.error('Entity table config save:', err);
                });
        }

        function saveConfigBeforeUnload() {
            if (!tableStates.some(isConfiguredSectionState)) return;
            saveConfigToStorage();
            saveConfig({ keepalive: true });
        }

        /** Apply table style (classes + caption) to section DOM based on st.tableStyle */
        function applyTableStyleToSection(tableIndex) {
            var st = tableStates[tableIndex];
            if (!st) return;
            var els = getSectionEls(tableIndex);
            var section = els.section;
            if (!section) return;
            var tableEl = section.querySelector('.entity-table-grid-wrap table');
            var theadEl = section.querySelector('.entity-table-grid-head');
            if (!tableEl || !theadEl) return;
            var styleKey = st.tableStyle || 'hoverable_rows';
            var s = TABLE_STYLES[styleKey] || TABLE_STYLES.default;
            var tableCls = (s.tableClass || '') + ' datatable datatable-table entityTableInSection entity-table-section-table';
            tableEl.className = tableCls;
            theadEl.className = (s.theadClass || '') + ' entity-table-grid-head';
            var captionEl = tableEl.querySelector('caption.entity-table-caption');
            if (s.caption) {
                var captionText = (st.tableDescription && String(st.tableDescription).trim()) ? st.tableDescription.trim() : 'Данные таблицы';
                if (captionEl) {
                    captionEl.textContent = captionText;
                } else {
                    var cap = document.createElement('caption');
                    cap.className = 'entity-table-caption';
                    cap.textContent = captionText;
                    tableEl.insertBefore(cap, tableEl.firstChild);
                }
            } else if (captionEl) {
                captionEl.remove();
            }
        }

        function updateTableTitleBlock(tableIndex) {
            var st = tableStates[tableIndex];
            if (!st) return;
            var els = getSectionEls(tableIndex);
            if (!els.tableTitleBlock) return;
            var titleText = (st.tableTitle && String(st.tableTitle).trim()) || '';
            if (els.tableTitleText) {
                els.tableTitleText.textContent = titleText || els.tableTitleText.getAttribute('data-placeholder') || 'Название таблицы';
                els.tableTitleText.classList.toggle('text-muted', !titleText);
            }
            var gridHidden = !els.gridBlock || els.gridBlock.classList.contains('d-none');
            els.tableTitleBlock.classList.toggle('d-none', gridHidden);
            applyTableStyleToSection(tableIndex);
        }

        /** API может возвращать type: "entity" или "crm_entity" — оба считаем смарт-процессами. */
        function normalizeEntityType(e) {
            var t = (e && e.type) ? e.type : '';
            if (t === 'entity' || t === 'crm_entity') return Object.assign({}, e, { type: 'smart_process' });
            return e;
        }
        function loadEntitiesList() {
            return fetch(API.processesDeals).then(function(r) { return r.json(); }).then(function(data) {
                var raw = (data && data.entities) ? data.entities : [];
                entitiesList = raw.map(normalizeEntityType);
                return entitiesList;
            });
        }

        function openEntityModal() {
            var st = tableStates[currentTableIndex];
            if (!st) return;
            var nameInput = document.getElementById('tableNameInput');
            var descInput = document.getElementById('tableDescriptionInput');
            if (nameInput) nameInput.value = (st.tableTitle && String(st.tableTitle).trim()) ? st.tableTitle.trim() : '';
            if (descInput) descInput.value = (st.tableDescription && String(st.tableDescription).trim()) ? st.tableDescription.trim() : '';

            Promise.all([
                loadEntitiesList(),
                fetch(API.dealCategories).then(function(r) { return r.json(); }).then(function(d) { return (d && d.categories) ? d.categories : []; }).catch(function() { return []; })
            ]).then(function(results) {
                var entities = results[0];
                var dealCategories = results[1];
                entityRadioName++;
                var name = 'entity_radio_' + entityRadioName;
                var contact = entities.filter(function(e) { return e.type === 'contact'; })[0];
                var lead = entities.filter(function(e) { return e.type === 'lead'; })[0];
                var deal = entities.filter(function(e) { return e.type === 'deal'; })[0];
                var smartList = entities.filter(function(e) { return e.type === 'smart_process'; });

                var leftCol = '';
                var rightCol = '';
                if (contact) {
                    leftCol += '<div class="entity-group"><div class="entity-group-title">Контакты</div>';
                    leftCol += '<div class="form-check"><input class="form-check-input" type="radio" name="' + name + '" value="contact" data-entity=\'' + JSON.stringify({ type: 'contact', entity_key: 'contact', title: contact.title || 'Контакты' }) + '\'><label class="form-check-label">' + (contact.title || 'Контакты') + '</label></div></div>';
                }
                if (deal) {
                    leftCol += '<div class="entity-group"><div class="entity-group-title"><strong>Сделки</strong></div>';
                    if (dealCategories.length) {
                        dealCategories.forEach(function(c) {
                            var ent = { type: 'deal', entity_key: 'deal', category_id: c.id, title: c.title || 'Сделки (' + c.id + ')' };
                            leftCol += '<div class="form-check"><input class="form-check-input" type="radio" name="' + name + '" value="deal" data-entity=\'' + JSON.stringify(ent) + '\'><label class="form-check-label">' + (c.title || c.id) + '</label></div>';
                        });
                    } else {
                        leftCol += '<div class="form-check"><input class="form-check-input" type="radio" name="' + name + '" value="deal" data-entity=\'' + JSON.stringify({ type: 'deal', entity_key: 'deal', title: deal.title || 'Сделки' }) + '\'><label class="form-check-label">' + (deal.title || 'Сделки') + '</label></div>';
                    }
                    leftCol += '</div>';
                }
                if (lead) {
                    rightCol += '<div class="entity-group"><div class="entity-group-title">Лиды</div>';
                    rightCol += '<div class="form-check"><input class="form-check-input" type="radio" name="' + name + '" value="lead" data-entity=\'' + JSON.stringify({ type: 'lead', entity_key: 'lead', title: lead.title || 'Лиды' }) + '\'><label class="form-check-label">' + (lead.title || 'Лиды') + '</label></div></div>';
                }
                if (smartList.length) {
                    rightCol += '<div class="entity-group"><div class="entity-group-title"><strong>Смарт-процессы</strong></div>';
                    smartList.forEach(function(e) {
                        var ent = { type: 'smart_process', entity_key: e.entity_key, title: e.title || e.entity_key };
                        rightCol += '<div class="form-check"><input class="form-check-input" type="radio" name="' + name + '" value="smart" data-entity=\'' + JSON.stringify(ent) + '\'><label class="form-check-label">' + (e.title || e.entity_key) + '</label></div>';
                    });
                    rightCol += '</div>';
                }
                var html = (leftCol || rightCol) ? ('<div class="entity-list-col">' + (leftCol || '<p class="text-muted small">—</p>') + '</div><div class="entity-list-col">' + (rightCol || '<p class="text-muted small">—</p>') + '</div>') : '<p class="text-muted">Нет сущностей.</p>';
                modalEntityBody.innerHTML = html;
                modalEntity.show();
            });
        }

        modalEntitySave.addEventListener('click', function() {
            var st = tableStates[currentTableIndex];
            if (!st) return;
            var nameInput = document.getElementById('tableNameInput');
            var descInput = document.getElementById('tableDescriptionInput');
            var title = nameInput ? nameInput.value.trim() : '';
            var desc = descInput ? descInput.value.trim() : '';
            if (!title) { alert('Введите название таблицы.'); if (nameInput) nameInput.focus(); return; }
            st.tableTitle = title;
            st.tableDescription = desc;
            // Не сохраняем конфиг на сервер в первом модальном — только после выбора полей во втором
            saveConfigToStorage();
            updateTableTitleBlock(currentTableIndex);

            var radio = modalEntityBody.querySelector('input[type="radio"]:checked');
            if (radio) {
                var entity = JSON.parse(radio.getAttribute('data-entity') || '{}');
                if (entity.type && !st.selectedEntities.some(function(e) { return entityKey(e) === entityKey(entity); })) {
                    st.selectedEntities.push(entity);
                    st.selectedFields.push({ entityKey: entityKey(entity), human_titles: [], activeNestedTypes: [], nestedFields: {} });
                    updateUI(currentTableIndex);
                    saveConfigToStorage();
                    loadFieldsThenData(currentTableIndex);
                }
            }
            modalEntity.hide();
        });

        function loadFieldsForEntity(ent, callback) {
            const key = entityKey(ent);
            if (fieldsCache[key]) {
                if (callback) callback(fieldsCache[key]);
                return Promise.resolve(fieldsCache[key]);
            }
            var url = API.metaFields + '?type=' + encodeURIComponent(ent.type);
            // Передаём entity_key для всех сущностей, где он есть.
            // В смешанных таблицах upstream может опираться на этот параметр.
            if (ent.entity_key) url += '&entity_key=' + encodeURIComponent(ent.entity_key);
            if (ent.category_id != null && ent.category_id !== '') url += '&category_id=' + encodeURIComponent(ent.category_id);
            return fetch(url).then(function(r) { return r.json(); }).then(function(data) {
                var result = { fields: (data && data.fields) ? data.fields : [], nested: [] };
                if (result.fields) {
                    result.fields.forEach(function(f) {
                        if (f.nested_fields && f.nested_fields.length) result.nested.push(f);
                    });
                }
                fieldsCache[key] = result;
                if (callback) callback(result);
                return result;
            });
        }

        function filterCustomFieldPickerList() {
            if (!customFieldPickerList || !customFieldPickerSearchInput) return;
            var q = normalizeSearchText(customFieldPickerSearchInput.value || '');
            customFieldPickerList.querySelectorAll('.field-row').forEach(function(row) {
                var text = normalizeSearchText(row.getAttribute('data-search-text') || row.textContent || '');
                row.style.display = (!q || text.indexOf(q) >= 0) ? '' : 'none';
            });
            customFieldPickerList.querySelectorAll('.fields-modal-entity-header').forEach(function(header) {
                var key = header.getAttribute('data-entitykey') || '';
                if (!key) return;
                var anyVisible = false;
                customFieldPickerList.querySelectorAll('.field-row[data-entitykey="' + key + '"]').forEach(function(r) {
                    if (r.classList.contains('fields-modal-entity-header')) return;
                    if (r.style.display !== 'none') anyVisible = true;
                });
                header.style.display = anyVisible ? '' : 'none';
            });
        }

        if (customFieldPickerNestedRow && customFieldPickerList) {
            customFieldPickerNestedRow.addEventListener('click', function(e) {
                var target = e.target.closest && e.target.closest('.nested-toggle') ? e.target.closest('.nested-toggle') : (e.target.classList && e.target.classList.contains('nested-toggle') ? e.target : null);
                if (!target) return;
                e.preventDefault();
                var ek = target.getAttribute('data-entitykey');
                var typ = target.getAttribute('data-type');
                if (!ek || !typ) return;
                var show = !target.classList.contains('active');
                target.classList.toggle('active', show);
                target.setAttribute('data-active', show ? 'true' : 'false');
                customFieldPickerList.querySelectorAll('[data-entitykey="' + ek + '"][data-nested-type="' + typ + '"]').forEach(function(el) {
                    el.style.display = show ? '' : 'none';
                });
                filterCustomFieldPickerList();
            });
        }

        function openCustomFieldPickerModal() {
            var st = tableStates[currentTableIndex];
            if (!st || !st.selectedEntities || !st.selectedEntities.length) return;
            if (!modalCustomFieldPicker || !customFieldPickerList) return;
            customFieldPickerList.innerHTML = '<div class="text-muted small">Загрузка полей...</div>';
            if (customFieldPickerSearchInput) customFieldPickerSearchInput.value = '';
            Promise.all(st.selectedEntities.map(function(ent) {
                return loadFieldsForEntity(ent).then(function(res) { return { ent: ent, res: res || { fields: [] } }; })
                    .catch(function() { return { ent: ent, res: { fields: [] } }; });
            })).then(function(items) {
                customFieldPickerList.innerHTML = '';
                items.forEach(function(item) {
                    var ent = item.ent;
                    var key = entityKey(ent);
                    var entityTitle = (ent && ent.title) ? String(ent.title) : (ent.type || key);
                    var header = document.createElement('div');
                    header.className = 'fields-modal-entity-header field-row';
                    header.setAttribute('data-entitykey', key);
                    header.textContent = entityTitle;
                    customFieldPickerList.appendChild(header);
                    var seen = {};
                    (item.res.fields || []).forEach(function(f, idx) {
                        var title = String((f && (f.human_title || f.column_name)) || '').trim();
                        if (!title) return;
                        if (seen[title]) return;
                        seen[title] = true;
                        var row = document.createElement('div');
                        row.className = 'form-check field-row';
                        row.setAttribute('data-entitykey', key);
                        row.setAttribute('data-search-text', (entityTitle + ' ' + title).toLowerCase());
                        var id = 'cfp_' + key.replace(/[^a-zA-Z0-9_]/g, '_') + '_' + idx;
                        row.innerHTML = '<input class="form-check-input custom-field-picker-cb" type="checkbox" id="' + id + '" data-title="' + title.replace(/"/g, '&quot;') + '" data-token-prefix="' + String(entityTitle || key).replace(/"/g, '&quot;') + '"><label class="form-check-label" for="' + id + '">' + title.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;') + '</label>';
                        customFieldPickerList.appendChild(row);
                    });
                });
                filterCustomFieldPickerList();
            });
            modalCustomFieldPicker.show();
        }

        // Custom field picker (separate modal) reuses the same field/nested rendering model as fields modal.
        function filterCustomFieldPickerList() {
            if (!customFieldPickerList || !customFieldPickerSearchInput) return;
            var q = normalizeSearchText(customFieldPickerSearchInput.value || '');
            if (customFieldPickerNestedRow) {
                var nestedRowWrap = customFieldPickerNestedRow.parentElement;
                if (nestedRowWrap) nestedRowWrap.style.display = q ? 'none' : '';
            }
            customFieldPickerList.querySelectorAll('.field-row:not([data-entity-header="1"])').forEach(function(row) {
                if (row.classList && row.classList.contains('fields-modal-group-label')) {
                    row.style.display = 'none';
                    return;
                }
                var text = normalizeSearchText(row.getAttribute('data-search-text') || row.textContent || '');
                var ek = row.getAttribute('data-entitykey') || '';
                var nestedType = row.getAttribute('data-nested-type') || '';
                var nestedVisible = true;
                if (nestedType && ek) {
                    var safeId = (ek + '_' + nestedType).replace(/[^a-zA-Z0-9_]/g, '_');
                    var toggleEl = document.getElementById('cfp_nested_cb_' + safeId);
                    nestedVisible = !toggleEl || targetTruthy(toggleEl);
                }
                row.style.display = ((!q || text.indexOf(q) >= 0) && nestedVisible) ? '' : 'none';
            });
            customFieldPickerList.querySelectorAll('.fields-modal-group-label.field-row').forEach(function(labelRow) {
                var ek = labelRow.getAttribute('data-entitykey') || '';
                var nestedType = labelRow.getAttribute('data-nested-type') || '';
                var hasVisibleRows = false;
                customFieldPickerList.querySelectorAll('.field-row[data-entitykey="' + ek + '"][data-nested-type="' + nestedType + '"]').forEach(function(r) {
                    if (hasVisibleRows) return;
                    if (r === labelRow) return;
                    if (r.classList && r.classList.contains('fields-modal-group-label')) return;
                    if (r.style.display !== 'none') hasVisibleRows = true;
                });
                labelRow.style.display = hasVisibleRows ? '' : 'none';
            });
            customFieldPickerList.querySelectorAll('.fields-modal-entity-header').forEach(function(header) {
                var key = header.getAttribute('data-entitykey') || '';
                if (!key) return;
                var anyVisible = false;
                customFieldPickerList.querySelectorAll('.field-row[data-entitykey="' + key + '"]').forEach(function(r) {
                    if (r.classList.contains('fields-modal-entity-header')) return;
                    if (r.style.display !== 'none') anyVisible = true;
                });
                header.style.display = anyVisible ? '' : 'none';
            });

            function targetTruthy(btn) {
                return btn.classList.contains('active') || btn.getAttribute('data-active') === 'true';
            }
        }

        function openCustomFieldPickerModal() {
            var st = tableStates[currentTableIndex];
            if (!st || !st.selectedEntities || !st.selectedEntities.length) return;
            if (!modalCustomFieldPicker || !customFieldPickerList) return;
            if (customFieldPickerNestedRow) customFieldPickerNestedRow.innerHTML = '';
            customFieldPickerList.innerHTML = '<div class="text-muted small">Загрузка полей...</div>';
            if (customFieldPickerSearchInput) customFieldPickerSearchInput.value = '';
            Promise.all(st.selectedEntities.map(function(ent) {
                return loadFieldsForEntity(ent).then(function(res) { return { ent: ent, res: res || { fields: [] } }; })
                    .catch(function() { return { ent: ent, res: { fields: [] } }; });
            })).then(function(items) {
                customFieldPickerList.innerHTML = '';
                items.forEach(function(item) {
                    var ent = item.ent;
                    var key = entityKey(ent);
                    var entityTitle = (ent && ent.title) ? String(ent.title) : entityTitleForNested(ent);
                    var header = document.createElement('div');
                    header.className = 'field-row fields-modal-entity-header';
                    header.setAttribute('data-entitykey', key);
                    header.setAttribute('data-entity-header', '1');
                    header.setAttribute('data-search-text', (entityTitle || '').toLowerCase());
                    header.innerHTML = '<span>' + String(entityTitle || key).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/"/g, '&quot;') + '</span>';
                    customFieldPickerList.appendChild(header);

                    var mainFields = [];
                    var nestedByGroup = {};
                    (item.res.fields || []).forEach(function(f) {
                        if (f.nested_fields && f.nested_fields.length) {
                            var t = nestedTypeKey(f.field_type);
                            var slug = (f.human_title || f.column_name || String(f.id || '')).replace(/\s/g, '_').replace(/[^a-zA-Z0-9_-]/g, '_') || t;
                            var groupKey = t + '::' + slug;
                            if (!nestedByGroup[groupKey]) nestedByGroup[groupKey] = {
                                label: f.human_title || f.column_name || nestedTypeLabel(t),
                                fields: [],
                                nestedEntityKey: customFieldPickerMetaNestedEntityKey(f, null),
                                relationFieldCode: String(f.field_code || f.b24_field || f.column_name || '').trim(),
                                relationB24Field: String(f.b24_field || '').trim(),
                                relationColumnName: String(f.column_name || '').trim()
                            };
                            f.nested_fields.forEach(function(n) {
                                nestedByGroup[groupKey].fields.push({
                                    human_title: n.human_title,
                                    column_name: n.column_name,
                                    b24_field: n.b24_field,
                                    field_code: n.field_code,
                                    entity_key: n.entity_key,
                                    nested_entity_key: n.nested_entity_key,
                                    id: n.id
                                });
                            });
                        } else {
                            mainFields.push(f);
                        }
                    });

                    if (Object.keys(nestedByGroup).length && customFieldPickerNestedRow) {
                        var wrap = document.createElement('div');
                        wrap.className = 'd-flex flex-wrap gap-2 align-items-center';
                        Object.keys(nestedByGroup).forEach(function(typ) {
                            var group = nestedByGroup[typ];
                            var safeId = (key + '_' + typ).replace(/[^a-zA-Z0-9_]/g, '_');
                            var btn = document.createElement('button');
                            btn.type = 'button';
                            btn.className = 'btn btn-sm btn-outline-primary nested-toggle';
                            btn.setAttribute('data-entitykey', key);
                            btn.setAttribute('data-type', typ);
                            btn.setAttribute('data-active', 'false');
                            btn.id = 'cfp_nested_cb_' + safeId;
                            btn.textContent = group.label || typ;
                            wrap.appendChild(btn);
                        });
                        customFieldPickerNestedRow.appendChild(wrap);
                    }

                    mainFields.forEach(function(f, idx) {
                        var title = String((f && (f.human_title || f.column_name)) || '').trim();
                        if (!title) return;
                        var row = document.createElement('div');
                        row.className = 'form-check field-row';
                        row.setAttribute('data-entitykey', key);
                        row.setAttribute('data-nested-type', '');
                        row.setAttribute('data-search-text', ((entityTitle || '') + ' ' + title).toLowerCase());
                        var id = 'cfp_' + key.replace(/[^a-zA-Z0-9_]/g, '_') + '_main_' + idx;
                        var mainFieldCode = customFieldPickerMetaFieldCode(f);
                        row.innerHTML = '<input class="form-check-input custom-field-picker-cb" type="checkbox" id="' + id + '" data-title="' + title.replace(/"/g, '&quot;') + '" data-parent-entity-key="' + String(key || '').replace(/"/g, '&quot;') + '" data-nested-entity-key="" data-field-code="' + String(mainFieldCode || '').replace(/"/g, '&quot;') + '"><label class="form-check-label" for="' + id + '">' + title.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;') + '</label>';
                        customFieldPickerList.appendChild(row);
                    });

                    Object.keys(nestedByGroup).forEach(function(typ) {
                        var group = nestedByGroup[typ];
                        var groupLabel = document.createElement('div');
                        groupLabel.className = 'form-check fields-modal-group-label field-row';
                        groupLabel.setAttribute('data-entitykey', key);
                        groupLabel.setAttribute('data-nested-type', typ);
                        groupLabel.setAttribute('data-search-text', ((entityTitle || '') + ' ' + (group.label || typ)).toLowerCase());
                        groupLabel.style.display = 'none';
                        groupLabel.style.gridColumn = '1 / -1';
                        groupLabel.innerHTML = '<span class="fw-bold text-dark">Поля: ' + String(group.label || typ).replace(/&/g, '&amp;').replace(/</g, '&lt;') + '</span>';
                        customFieldPickerList.appendChild(groupLabel);
                        group.fields.forEach(function(n, idx) {
                            var title = String((n && (n.human_title || n.column_name)) || '').trim();
                            if (!title) return;
                            var row = document.createElement('div');
                            row.className = 'form-check field-row';
                            row.setAttribute('data-entitykey', key);
                            row.setAttribute('data-nested-type', typ);
                            row.style.display = 'none';
                            row.setAttribute('data-search-text', ((entityTitle || '') + ' ' + title).toLowerCase());
                            var id = 'cfp_' + key.replace(/[^a-zA-Z0-9_]/g, '_') + '_' + typ.replace(/[^a-zA-Z0-9_]/g, '_') + '_' + idx;
                            var nestedFieldCode = customFieldPickerMetaFieldCode(n);
                            var nestedEntityKey = customFieldPickerMetaNestedEntityKey(n, group);
                            row.innerHTML = '<input class="form-check-input custom-field-picker-cb" type="checkbox" id="' + id + '" data-title="' + title.replace(/"/g, '&quot;') + '" data-token-prefix="' + String(group.label || typ).replace(/"/g, '&quot;') + '" data-parent-entity-key="' + String(key || '').replace(/"/g, '&quot;') + '" data-nested-entity-key="' + String(nestedEntityKey || '').replace(/"/g, '&quot;') + '" data-field-code="' + String(nestedFieldCode || '').replace(/"/g, '&quot;') + '" data-relation-field-code="' + String(group.relationFieldCode || '').replace(/"/g, '&quot;') + '" data-relation-b24-field="' + String(group.relationB24Field || '').replace(/"/g, '&quot;') + '" data-relation-column-name="' + String(group.relationColumnName || '').replace(/"/g, '&quot;') + '"><label class="form-check-label" for="' + id + '">' + title.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;') + '</label>';
                            customFieldPickerList.appendChild(row);
                        });
                    });
                });
                filterCustomFieldPickerList();
            });
            modalCustomFieldPicker.show();
        }

        function insertTextAtTextareaCursor(textarea, text) {
            if (!textarea) return;
            textarea.focus();
            var start = textarea.selectionStart != null ? textarea.selectionStart : textarea.value.length;
            var end = textarea.selectionEnd != null ? textarea.selectionEnd : textarea.value.length;
            var before = textarea.value.slice(0, start);
            var after = textarea.value.slice(end);
            textarea.value = before + text + after;
            var pos = start + text.length;
            if (textarea.setSelectionRange) textarea.setSelectionRange(pos, pos);
            textarea.dispatchEvent(new Event('input', { bubbles: true }));
        }

        function customFieldPickerMetaFieldCode(meta) {
            if (!meta || typeof meta !== 'object') return '';
            var candidates = [meta.field_code, meta.b24_field, meta.column_name, meta.code];
            for (var i = 0; i < candidates.length; i++) {
                var v = String(candidates[i] || '').trim();
                if (v) return v;
            }
            return '';
        }

        function customFieldPickerMetaNestedEntityKey(meta, fallback) {
            var candidates = [];
            if (meta && typeof meta === 'object') {
                candidates.push(meta.nested_entity_key, meta.entity_key, meta.linked_entity_key, meta.target_entity_key);
            }
            if (fallback && typeof fallback === 'object') {
                candidates.push(fallback.nestedEntityKey, fallback.nested_entity_key, fallback.entity_key, fallback.linked_entity_key, fallback.target_entity_key);
            }
            for (var i = 0; i < candidates.length; i++) {
                var v = String(candidates[i] || '').trim();
                if (v) return normalizeTechnicalNestedEntityKeyForEditor(v);
            }
            return '';
        }

        if (customFieldActionBtn) {
            customFieldActionBtn.addEventListener('click', function() {
                openCustomFieldPickerModal();
            });
        }

        if (customFieldPickerSearchInput) {
            customFieldPickerSearchInput.addEventListener('input', filterCustomFieldPickerList);
        }

        if (customFieldPickerInsertBtn) {
            customFieldPickerInsertBtn.addEventListener('click', function() {
                if (!customFieldPickerList || !customFieldPayloadTextarea) return;
                var selected = Array.from(customFieldPickerList.querySelectorAll('.custom-field-picker-cb:checked'));
                if (!selected.length) {
                    if (modalCustomFieldPicker) modalCustomFieldPicker.hide();
                    return;
                }
                var tokens = selected
                    .map(function(cb) {
                        var technicalParentEntityKey = (cb.getAttribute('data-parent-entity-key') || '').trim();
                        var technicalNestedEntityKey = normalizeTechnicalNestedEntityKeyForEditor(cb.getAttribute('data-nested-entity-key'));
                        var technicalFieldCode = (cb.getAttribute('data-field-code') || '').trim();
                        var title = (cb.getAttribute('data-title') || '').trim();
                        var prefixKey = (cb.getAttribute('data-token-prefix') || '').trim();
                        var row = cb.closest('.field-row');
                        var ek = row ? (row.getAttribute('data-entitykey') || '').trim() : '';
                        var nestedType = row ? (row.getAttribute('data-nested-type') || '').trim() : '';
                        if (!prefixKey) {
                            if (nestedType && ek) {
                                var safeId = (ek + '_' + nestedType).replace(/[^a-zA-Z0-9_]/g, '_');
                                var nestedBtn = document.getElementById('cfp_nested_cb_' + safeId);
                                prefixKey = nestedBtn ? String(nestedBtn.textContent || '').trim() : '';
                            }
                            if (!prefixKey && ek) {
                                var header = customFieldPickerList.querySelector('.fields-modal-entity-header[data-entitykey="' + ek + '"]');
                                prefixKey = header ? String(header.textContent || '').trim() : '';
                            }
                        }
                        if (!title) return '';
                        var parentEntityTitle = '';
                        if (ek) {
                            var parentHeader = customFieldPickerList.querySelector('.fields-modal-entity-header[data-entitykey="' + ek + '"]');
                            parentEntityTitle = parentHeader ? String(parentHeader.textContent || '').trim() : '';
                        }
                        var tokenBody = '';
                        if (technicalParentEntityKey && technicalFieldCode) {
                            tokenBody = technicalParentEntityKey + '|' + (technicalNestedEntityKey || '') + '|' + technicalFieldCode;
                        } else if (nestedType && parentEntityTitle && prefixKey) {
                            tokenBody = parentEntityTitle + '.' + prefixKey + '.' + title;
                        } else {
                            tokenBody = (prefixKey ? (prefixKey + '.') : '') + title;
                        }
                        var token = '{' + tokenBody + '}';
                        var st = tableStates[currentTableIndex];
                        if (st) {
                            var colKey = resolveColumnKeyForEditorTokenInsert(st, title, prefixKey, ek, nestedType);
                            if (colKey) {
                                ensureCustomFieldTokenMap(st)[tokenBody] = colKey;
                            }
                            if (technicalParentEntityKey && technicalNestedEntityKey && nestedType) {
                                var relFieldCode = String(cb.getAttribute('data-relation-field-code') || '').trim();
                                var relB24Field = String(cb.getAttribute('data-relation-b24-field') || '').trim();
                                var relColumnName = String(cb.getAttribute('data-relation-column-name') || '').trim();
                                if (relFieldCode || relB24Field || relColumnName) {
                                    ensureCustomFieldTokenRelationMap(st)[tokenBody] = {
                                        parent_entity_key: technicalParentEntityKey,
                                        nested_entity_key: technicalNestedEntityKey,
                                        field_code: relFieldCode || relB24Field || relColumnName,
                                        b24_field: relB24Field || relFieldCode || '',
                                        column_name: relColumnName || '',
                                        relation_field_code: relFieldCode || relB24Field || relColumnName,
                                        relation_b24_field: relB24Field || relFieldCode || '',
                                        relation_column_name: relColumnName || '',
                                        link_field_code: relFieldCode || relB24Field || relColumnName,
                                        link_b24_field: relB24Field || relFieldCode || '',
                                        link_column_name: relColumnName || ''
                                    };
                                }
                            }
                        }
                        return token;
                    })
                    .filter(Boolean);
                if (!tokens.length) {
                    if (modalCustomFieldPicker) modalCustomFieldPicker.hide();
                    return;
                }
                var prefix = '';
                var taVal = customFieldPayloadTextarea.value || '';
                var pos = customFieldPayloadTextarea.selectionStart != null ? customFieldPayloadTextarea.selectionStart : taVal.length;
                if (taVal && pos > 0) {
                    var prevChar = taVal.charAt(pos - 1);
                    if (!/\s/.test(prevChar)) prefix = ' ';
                }
                insertTextAtTextareaCursor(customFieldPayloadTextarea, prefix + tokens.join(' '));
                if (modalCustomFieldPicker) modalCustomFieldPicker.hide();
            });
        }

        if (customFieldEditorHelpBtn && window.bootstrap && bootstrap.Tooltip) {
            bootstrap.Tooltip.getOrCreateInstance(customFieldEditorHelpBtn);
        }
        if (customFieldPayloadTextarea) {
            customFieldPayloadTextarea.addEventListener('input', function() {
                renderCustomFieldEditorReadableHint();
            });
        }

        function resolveCustomEditorTokenValue(tokenBody, st, row) {
            var raw = String(tokenBody || '').trim();
            if (!raw || !st || !row) return '';
            var mappedKey = (st.customFieldTokenMap && st.customFieldTokenMap[raw]) ? String(st.customFieldTokenMap[raw]) : '';
            if (mappedKey && Object.prototype.hasOwnProperty.call(row, mappedKey)) {
                var mappedVal = row[mappedKey];
                if (mappedVal == null) return '';
                if (typeof mappedVal === 'object') {
                    try { return JSON.stringify(mappedVal); } catch (e) { return String(mappedVal); }
                }
                return String(mappedVal);
            }
            var lastDot = raw.lastIndexOf('.');
            var prefix = lastDot > 0 ? raw.slice(0, lastDot).trim() : '';
            var fieldLabel = lastDot > 0 ? raw.slice(lastDot + 1).trim() : raw;
            if (!fieldLabel) return '';
            var cols = Array.isArray(st.allColumns) ? st.allColumns : [];
            var normField = normalizeSearchText(fieldLabel);
            var normPrefix = normalizeSearchText(prefix);
            var matches = cols.filter(function(col) {
                if (!col || normalizeSearchText(col.label || '') !== normField) return false;
                if (!normPrefix) return true;
                return normalizeSearchText(col.entityTitle || '') === normPrefix;
            });
            if (!matches.length && normPrefix) {
                matches = cols.filter(function(col) {
                    if (!col || normalizeSearchText(col.label || '') !== normField) return false;
                    return normalizeSearchText(col.key || '').indexOf(normPrefix) >= 0;
                });
            }
            var chosen = matches.length ? matches[0] : null;
            if (!chosen || !chosen.key) return '';
            var v = Object.prototype.hasOwnProperty.call(row, chosen.key) ? row[chosen.key] : '';
            if (v == null) return '';
            if (typeof v === 'object') {
                try { return JSON.stringify(v); } catch (e) { return String(v); }
            }
            return String(v);
        }

        function resolveCustomEditorTokenColumn(tokenBody, st) {
            var raw = String(tokenBody || '').trim();
            if (!raw || !st) return null;
            var mappedKey = (st.customFieldTokenMap && st.customFieldTokenMap[raw]) ? String(st.customFieldTokenMap[raw]) : '';
            if (mappedKey) {
                var mappedCol = (Array.isArray(st.allColumns) ? st.allColumns : []).find(function(c) { return c && c.key === mappedKey; });
                if (mappedCol) return mappedCol;
            }
            var lastDot = raw.lastIndexOf('.');
            var prefix = lastDot > 0 ? raw.slice(0, lastDot).trim() : '';
            var fieldLabel = lastDot > 0 ? raw.slice(lastDot + 1).trim() : raw;
            if (!fieldLabel) return null;
            var cols = Array.isArray(st.allColumns) ? st.allColumns : [];
            var normField = normalizeSearchText(fieldLabel);
            var normPrefix = normalizeSearchText(prefix);
            var matches = cols.filter(function(col) {
                if (!col || normalizeSearchText(col.label || '') !== normField) return false;
                if (!normPrefix) return true;
                return normalizeSearchText(col.entityTitle || '') === normPrefix;
            });
            if (!matches.length && normPrefix) {
                matches = cols.filter(function(col) {
                    if (!col || normalizeSearchText(col.label || '') !== normField) return false;
                    return normalizeSearchText(col.key || '').indexOf(normPrefix) >= 0;
                });
            }
            return (matches && matches.length) ? matches[0] : null;
        }

        function toPreviewNumber(v) {
            if (v && typeof v === 'object' && v.__customEditorTokenValue) v = v.current;
            if (typeof v === 'number') return isFinite(v) ? v : 0;
            var n = parseFloat(String(v == null ? '' : v).replace(',', '.'));
            return isNaN(n) ? 0 : n;
        }

        function customEditorTokenRuntimeValue(tokenBody, st, row) {
            var col = resolveCustomEditorTokenColumn(tokenBody, st);
            var current = resolveCustomEditorTokenValue(tokenBody, st, row);
            var rows = (st && Array.isArray(st.fullData)) ? st.fullData : [];
            var values = [];
            if (col && col.key) {
                values = rows.map(function(r) {
                    if (!r || !Object.prototype.hasOwnProperty.call(r, col.key)) return '';
                    var v = r[col.key];
                    if (v == null) return '';
                    if (typeof v === 'object') {
                        try { return JSON.stringify(v); } catch (e) { return String(v); }
                    }
                    return v;
                });
            }
            return {
                __customEditorTokenValue: true,
                token: String(tokenBody || ''),
                key: col && col.key ? col.key : '',
                current: current,
                values: values,
                valueOf: function() { return this.current == null ? '' : this.current; },
                toString: function() { return this.current == null ? '' : String(this.current); }
            };
        }

        function evalCustomEditorExpression(exprText) {
            var st = tableStates[currentTableIndex];
            var rows = (st && Array.isArray(st.fullData)) ? st.fullData : [];
            var row = rows.length ? rows[0] : null;
            if (!st) throw new Error('Нет активной таблицы');
            var expr = String(exprText || '').trim();
            if (!expr) throw new Error('Editor пустой');
            var values = [];
            var jsExpr = expr.replace(/\{([^}]+)\}/g, function(_, tokenBody) {
                var idx = values.length;
                values.push(customEditorTokenRuntimeValue(tokenBody, st, row));
                return '__t' + idx;
            });
            function tokenSeries(v) {
                if (v && typeof v === 'object' && v.__customEditorTokenValue) return Array.isArray(v.values) ? v.values : [];
                return null;
            }
            function scalar(v) {
                return (v && typeof v === 'object' && v.__customEditorTokenValue) ? v.current : v;
            }
            var argNames = values.map(function(_, i) { return '__t' + i; });
            var FNS = {
                COUNT: function(v) {
                    if (arguments.length === 0) return rows.length;
                    var s = tokenSeries(v);
                    if (s) return s.filter(function(x) { return x != null && x !== ''; }).length;
                    return (scalar(v) != null && scalar(v) !== '') ? 1 : 0;
                },
                SUM: function(v) {
                    var s = tokenSeries(v) || [scalar(v)];
                    return s.reduce(function(acc, x) { return acc + toPreviewNumber(x); }, 0);
                },
                AVG: function(v) {
                    var s = tokenSeries(v) || [scalar(v)];
                    var nums = s.map(toPreviewNumber);
                    if (!nums.length) return 0;
                    return nums.reduce(function(acc, x) { return acc + x; }, 0) / nums.length;
                },
                MIN: function(v) {
                    var s = tokenSeries(v) || [scalar(v)];
                    if (!s.length) return '';
                    var nums = s.map(toPreviewNumber);
                    return nums.length ? Math.min.apply(null, nums) : '';
                },
                MAX: function(v) {
                    var s = tokenSeries(v) || [scalar(v)];
                    if (!s.length) return '';
                    var nums = s.map(toPreviewNumber);
                    return nums.length ? Math.max.apply(null, nums) : '';
                },
                CONCAT: function() { return Array.prototype.slice.call(arguments).map(function(v) { return v == null ? '' : String(v); }).join(''); },
                UPPER: function(v) { v = scalar(v); return String(v == null ? '' : v).toUpperCase(); },
                LOWER: function(v) { v = scalar(v); return String(v == null ? '' : v).toLowerCase(); },
                IFNULL: function(v, alt) { v = scalar(v); return (v == null || v === '') ? alt : v; },
                COALESCE: function() {
                    for (var i = 0; i < arguments.length; i++) {
                        var sv = scalar(arguments[i]);
                        if (sv != null && sv !== '') return sv;
                    }
                    return '';
                },
                LEN: function(v) { v = scalar(v); return String(v == null ? '' : v).length; },
                NUMBER: function(v) { return toPreviewNumber(v); },
                ROUND: function(v, p) {
                    var n = toPreviewNumber(v);
                    var prec = parseInt(p, 10); if (isNaN(prec)) prec = 0;
                    var m = Math.pow(10, prec);
                    return Math.round(n * m) / m;
                }
            };
            var fnNames = Object.keys(FNS);
            var body = '"use strict"; return (' + jsExpr + ');';
            try {
                var fn = Function.apply(null, argNames.concat(fnNames).concat([body]));
                return fn.apply(null, values.concat(fnNames.map(function(n) { return FNS[n]; })));
            } catch (e) {
                throw new Error('Ошибка выражения: ' + (e && e.message ? e.message : e));
            }
        }

        function renderCustomEditorPreview() {
            if (!customFieldPreviewResult) return;
            customFieldPreviewResult.classList.remove('text-danger', 'text-success');
            customFieldPreviewResult.classList.add('text-muted');
            customFieldPreviewResult.textContent = 'Проверка...';
            previewCustomFieldEditorViaApi(currentTableIndex, customFieldPayloadTextarea ? customFieldPayloadTextarea.value : '')
                .then(function(body) {
                    var pr = (body && body.preview_result) ? body.preview_result : {};
                    var val = (pr.sample_value != null) ? pr.sample_value : '';
                    var modeDetail = pr.mode_detail ? String(pr.mode_detail) : '';
                    customFieldPreviewResult.classList.remove('text-muted', 'text-danger');
                    customFieldPreviewResult.classList.add('text-success');
                    customFieldPreviewResult.textContent = 'Результат: ' + ((val == null || val === '') ? 'Пусто' : String(val)) + (modeDetail ? (' (' + modeDetail + ')') : '');
                })
                .catch(function(e) {
                    customFieldPreviewResult.classList.remove('text-muted', 'text-success');
                    customFieldPreviewResult.classList.add('text-danger');
                    customFieldPreviewResult.textContent = e && e.message ? e.message : String(e);
                });
        }

        if (customFieldPreviewBtn) {
            customFieldPreviewBtn.addEventListener('click', function() {
                renderCustomEditorPreview();
            });
        }

        var NESTED_TYPE_LABELS = {
            contact: 'Контакт',
            company: 'Компания',
            lead: 'Лид',
            deal: 'Сделка',
            entity: 'Смарт-Процесс',
            smart_process: 'Смарт-Процесс'
        };
        var ENTITY_TYPE_TITLES = {
            contact: 'Контакты',
            lead: 'Лиды',
            deal: 'Сделки',
            smart_process: 'Смарт-процесс'
        };
        function nestedTypeLabel(type) {
            return NESTED_TYPE_LABELS[type] || type;
        }
        function entityTitleForNested(ent) {
            return ENTITY_TYPE_TITLES[ent.type] || ent.title || entityKey(ent);
        }

        /** В API поле field_type может быть entity или crm_entity — оба отображаем как Смарт-Процесс. */
        function nestedTypeKey(apiType) {
            var t = ((apiType || '').replace('crm_', '') || 'entity').toLowerCase();
            if (t === 'entity') t = 'smart_process';
            return t;
        }

        var FIELD_LABEL_MAX_CHARS = 15;
        function fieldLabelShort(full) {
            full = (full || '').trim();
            if (!full) return { display: '', title: '' };
            var display = full.length <= FIELD_LABEL_MAX_CHARS ? full : full.substring(0, FIELD_LABEL_MAX_CHARS) + '...';
            return { display: display, title: full };
        }
        function updateThLabelByWidth(th) {
            var full = th.getAttribute('data-full-label');
            if (full == null || full === '') return;
            var span = th.querySelector('.entity-table-th-label');
            if (!span) return;
            var short = fieldLabelShort(full).display;
            var section = th.closest('.entity-table-section');
            var tableIndex = section ? section.getAttribute('data-table-index') : null;
            var columnKey = th.getAttribute('data-column-key');
            var st = tableIndex != null ? tableStates[tableIndex] : null;
            var explicitWidth = st && st.columnWidths && columnKey != null ? st.columnWidths[columnKey] : null;
            span.textContent = full;
            if (th.scrollWidth > th.clientWidth) span.textContent = short;
        }
        function openFieldsModal() {
            var st = tableStates[currentTableIndex];
            if (!st || !st.selectedEntities.length) return;
            renderCustomFieldsInFieldsTab(currentTableIndex);
            loadCustomFieldsForTable(currentTableIndex);
            var isFilterMode = (fieldsModalForFilterTableIndex != null);
            var isCustomEditorInsertMode = !!fieldsModalForCustomEditorInsert || !!(modalFieldsEl && modalFieldsEl.getAttribute('data-custom-editor-mode') === '1');
            var tableStyleSelect = document.getElementById('tableStyleSelect');
            if (tableStyleSelect && TABLE_STYLES[st.tableStyle]) tableStyleSelect.value = st.tableStyle;
            var entityLabel = document.getElementById('settingsModalEntityLabel');
            var customEntityLabel = document.getElementById('customFieldEntityLabel');
            if (entityLabel) entityLabel.textContent = st.selectedEntities.length ? st.selectedEntities.map(function(e) { return e.title || e.type; }).join(', ') : '—';
            if (customEntityLabel) customEntityLabel.textContent = st.selectedEntities.length ? st.selectedEntities.map(function(e) { return e.title || e.type; }).join(', ') : 'вЂ”';
            var descField = document.getElementById('settingsModalTableDescription');
            if (descField) descField.value = (st.tableDescription && String(st.tableDescription).trim()) ? st.tableDescription.trim() : '';
            var settingsTab = document.querySelector('#modalFields [href="#settingsTabPane"]');
            var settingsPane = document.getElementById('settingsTabPane');
            var customTab = document.querySelector('#modalFields [href="#customFieldTabPane"]');
            if (settingsTab && settingsPane) {
                settingsTab.closest('.nav-item').classList.toggle('d-none', (isFilterMode || isCustomEditorInsertMode));
            }
            if (customTab) {
                customTab.closest('.nav-item').classList.toggle('d-none', isCustomEditorInsertMode);
            }
            var fieldsTabBtn = document.querySelector('#modalFields [href="#fieldsTabPane"]');
            if (fieldsTabBtn && window.bootstrap && bootstrap.Tab) {
                try { bootstrap.Tab.getOrCreateInstance(fieldsTabBtn).show(); } catch (e) {}
            }
            var nestedRow = document.getElementById('nestedCheckboxesRow');
            if (nestedRow) nestedRow.innerHTML = '';
            fieldsList.innerHTML = '';
            st.selectedEntities.forEach(function(ent) {
                var key = entityKey(ent);
                var sel = st.selectedFields.find(function(f) { return f.entityKey === key; });
                var titles = (sel && sel.human_titles) ? sel.human_titles : [];
                var entityTitle = (ent && ent.title) ? String(ent.title) : entityTitleForNested(ent);
                loadFieldsForEntity(ent).then(function(res) {
                    var mainFields = [];
                    var nestedByGroup = {};
                    (res.fields || []).forEach(function(f) {
                        if (f.nested_fields && f.nested_fields.length) {
                            var t = nestedTypeKey(f.field_type);
                            var slug = (f.human_title || f.column_name || String(f.id || '')).replace(/\s/g, '_').replace(/[^a-zA-Z0-9_-]/g, '_') || t;
                            var groupKey = t + '::' + slug;
                            if (!nestedByGroup[groupKey]) nestedByGroup[groupKey] = { label: f.human_title || f.column_name || nestedTypeLabel(t), fields: [] };
                            f.nested_fields.forEach(function(n) {
                                nestedByGroup[groupKey].fields.push({ human_title: n.human_title, column_name: n.column_name, id: n.id });
                            });
                        } else {
                            mainFields.push(f);
                        }
                    });

                    var entityHeader = document.createElement('div');
                    entityHeader.className = 'field-row fields-modal-entity-header';
                    entityHeader.setAttribute('data-entitykey', key);
                    entityHeader.setAttribute('data-entity-header', '1');
                    entityHeader.setAttribute('data-search-text', (entityTitle || '').toLowerCase());
                    entityHeader.innerHTML = '<span>' + String(entityTitle || key).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/"/g, '&quot;') + '</span>';
                    fieldsList.appendChild(entityHeader);

                    if (Object.keys(nestedByGroup).length && nestedRow) {
                        var wrap = document.createElement('div');
                        wrap.className = 'd-flex flex-wrap gap-2 align-items-center';
                        var activeNestedRaw = (sel && sel.activeNestedTypes && Array.isArray(sel.activeNestedTypes)) ? sel.activeNestedTypes : [];
                        var activeNested = activeNestedRaw.filter(function(typ) { return Object.prototype.hasOwnProperty.call(nestedByGroup, typ); });
                        Object.keys(nestedByGroup).forEach(function(typ) {
                            var group = nestedByGroup[typ];
                            var hasSelected = activeNested.indexOf(typ) >= 0;
                            var safeId = (key + '_' + typ).replace(/[^a-zA-Z0-9_]/g, '_');
                            var labelEsc = (group.label || typ).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/"/g, '&quot;');
                            var btn = document.createElement('button');
                            btn.type = 'button';
                            btn.className = 'btn btn-sm btn-outline-primary nested-toggle' + (hasSelected ? ' active' : '');
                            btn.setAttribute('data-entitykey', key);
                            btn.setAttribute('data-type', typ);
                            btn.setAttribute('data-active', hasSelected ? 'true' : 'false');
                            btn.id = 'nested_cb_' + safeId;
                            btn.textContent = group.label || typ;
                            wrap.appendChild(btn);
                        });
                        nestedRow.appendChild(wrap);
                    }

                    mainFields.forEach(function(f) {
                        var div = document.createElement('div');
                        div.className = 'form-check field-row';
                        div.setAttribute('data-entitykey', key);
                        div.setAttribute('data-nested-type', '');
                        div.setAttribute('data-search-text', ((entityTitle || '') + ' ' + (f.human_title || f.column_name || '')).toLowerCase());
                        var id = 'f_' + key + '_main_' + (f.human_title || f.column_name || f.id).replace(/\s/g, '_');
                        var checked = (!isFilterMode && !isCustomEditorInsertMode && titles.indexOf(f.human_title) >= 0) ? ' checked' : '';
                        var nestAttr = ' data-nested-type=""';
                        var lab = fieldLabelShort(f.human_title || f.column_name || '');
                        var labDisp = (lab.display || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/"/g, '&quot;');
                        var labTitle = (lab.title || '').replace(/"/g, '&quot;');
                        div.innerHTML = '<input class="form-check-input field-cb" type="checkbox" id="' + id + '" data-entitykey="' + key + '" data-human-title="' + (f.human_title || '').replace(/"/g, '&quot;') + '" data-field-type="' + String(f.field_type || '').replace(/"/g, '&quot;') + '" data-b24-field="' + String(f.b24_field || '').replace(/"/g, '&quot;') + '" data-column-name="' + String(f.column_name || '').replace(/"/g, '&quot;') + '"' + nestAttr + checked + '><label class="form-check-label" for="' + id + '" title="' + labTitle + '">' + labDisp + '</label>';
                        fieldsList.appendChild(div);
                    });

                    var activeNestedForLabels = (Array.isArray(activeNested) ? activeNested : []).slice();
                    Object.keys(nestedByGroup).forEach(function(typ) {
                        var group = nestedByGroup[typ];
                        var hasSelectedLabel = activeNestedForLabels.indexOf(typ) >= 0;
                        var titlesNested = (!isFilterMode && !isCustomEditorInsertMode && sel && sel.nestedFields && sel.nestedFields[typ] && Array.isArray(sel.nestedFields[typ])) ? sel.nestedFields[typ] : [];
                        var groupLabel = document.createElement('div');
                        groupLabel.className = 'form-check fields-modal-group-label field-row';
                        groupLabel.setAttribute('data-entitykey', key);
                        groupLabel.setAttribute('data-nested-type', typ);
                        groupLabel.setAttribute('data-search-text', ((entityTitle || '') + ' ' + (group.label || typ)).toLowerCase());
                        groupLabel.style.display = hasSelectedLabel ? '' : 'none';
                        groupLabel.style.gridColumn = '1 / -1';
                        groupLabel.innerHTML = '<span class="fw-bold text-dark">Поля: ' + (group.label || typ) + '</span>';
                        fieldsList.appendChild(groupLabel);
                        group.fields.forEach(function(n) {
                            var div = document.createElement('div');
                            div.className = 'form-check field-row';
                            div.setAttribute('data-entitykey', key);
                            div.setAttribute('data-nested-type', typ);
                            div.style.display = hasSelectedLabel ? '' : 'none';
                            div.setAttribute('data-search-text', ((entityTitle || '') + ' ' + (n.human_title || n.column_name || '')).toLowerCase());
                            var id = 'f_' + key + '_' + typ.replace(/[^a-zA-Z0-9_]/g, '_') + '_' + (n.human_title || n.column_name || n.id).replace(/\s/g, '_');
                            var checked = (!isFilterMode && !isCustomEditorInsertMode && titlesNested.indexOf(n.human_title) >= 0) ? ' checked' : '';
                            var nestAttr = ' data-nested-type="' + String(typ).replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/</g, '&lt;') + '"';
                            var lab = fieldLabelShort(n.human_title || n.column_name || '');
                            var labDisp = (lab.display || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/"/g, '&quot;');
                            var labTitle = (lab.title || '').replace(/"/g, '&quot;');
                            div.innerHTML = '<input class="form-check-input field-cb" type="checkbox" id="' + id + '" data-entitykey="' + key + '" data-human-title="' + (n.human_title || '').replace(/"/g, '&quot;') + '"' + nestAttr + checked + '><label class="form-check-label" for="' + id + '" title="' + labTitle + '">' + labDisp + '</label>';
                            fieldsList.appendChild(div);
                        });
                    });
                    filterFieldsBySearch();
                });
            });
            var searchEl = document.getElementById('fieldsSearchInput');
            if (searchEl) {
                searchEl.value = '';
                searchEl.oninput = filterFieldsBySearch;
            }
            modalFields.show();
        }

        function filterFieldsBySearch() {
            var modalTableIndex = (fieldsModalForFilterTableIndex != null) ? fieldsModalForFilterTableIndex : currentTableIndex;
            var st = tableStates[modalTableIndex];
            var allowedEntityKeys = {};
            if (st && Array.isArray(st.selectedEntities)) {
                st.selectedEntities.forEach(function(ent) {
                    allowedEntityKeys[entityKey(ent)] = true;
                });
            }
            var q = normalizeSearchText((document.getElementById('fieldsSearchInput') && document.getElementById('fieldsSearchInput').value || ''));
            var entityMeta = {};
            fieldsList.querySelectorAll('.field-row[data-entity-header="1"]').forEach(function(row) {
                var ek = row.getAttribute('data-entitykey') || '';
                if (ek && !allowedEntityKeys[ek]) { row.style.display = 'none'; return; }
                var text = normalizeSearchText(row.getAttribute('data-search-text') || row.textContent || '');
                var forceShow = !!q && text.indexOf(q) >= 0;
                entityMeta[ek] = { header: row, forceShow: forceShow, visibleCount: 0 };
                row.style.display = 'none';
            });
            fieldsList.querySelectorAll('.field-row:not([data-entity-header="1"])').forEach(function(row) {
                if (row.classList && row.classList.contains('fields-modal-group-label')) {
                    row.style.display = 'none';
                    return;
                }
                var text = normalizeSearchText(row.getAttribute('data-search-text') || row.textContent || '');
                var entityKeyVal = row.getAttribute('data-entitykey') || '';
                if (entityKeyVal && !allowedEntityKeys[entityKeyVal]) { row.style.display = 'none'; return; }
                var forceShowByEntity = !!(entityMeta[entityKeyVal] && entityMeta[entityKeyVal].forceShow);
                var passesSearch = forceShowByEntity || !q || text.indexOf(q) >= 0;
                var nestedType = row.getAttribute('data-nested-type');
                var nestedVisible = true;
                if (nestedType && entityKeyVal) {
                    var safeId = (entityKeyVal + '_' + nestedType).replace(/[^a-zA-Z0-9_]/g, '_');
                    var toggleEl = document.getElementById('nested_cb_' + safeId);
                    nestedVisible = !toggleEl || (toggleEl.checked === true || toggleEl.getAttribute('data-active') === 'true');
                }
                var show = (passesSearch && nestedVisible);
                row.style.display = show ? '' : 'none';
                if (show && entityMeta[entityKeyVal]) entityMeta[entityKeyVal].visibleCount++;
            });
            // Показываем заголовок nested-группы, если в ней есть видимые поля после поиска.
            fieldsList.querySelectorAll('.fields-modal-group-label.field-row').forEach(function(labelRow) {
                var entityKeyVal = labelRow.getAttribute('data-entitykey') || '';
                var nestedType = labelRow.getAttribute('data-nested-type') || '';
                if (!entityKeyVal || !nestedType || (entityKeyVal && !allowedEntityKeys[entityKeyVal])) {
                    labelRow.style.display = 'none';
                    return;
                }
                var hasVisibleRows = false;
                fieldsList.querySelectorAll('.field-row[data-entitykey="' + entityKeyVal + '"][data-nested-type="' + nestedType + '"]').forEach(function(r) {
                    if (hasVisibleRows) return;
                    if (r === labelRow) return;
                    if (r.classList && r.classList.contains('fields-modal-group-label')) return;
                    if (r.style.display !== 'none') hasVisibleRows = true;
                });
                labelRow.style.display = hasVisibleRows ? '' : 'none';
            });
            Object.keys(entityMeta).forEach(function(ek) {
                var meta = entityMeta[ek];
                if (!meta || !meta.header) return;
                meta.header.style.display = (meta.visibleCount > 0 || meta.forceShow) ? '' : 'none';
            });
        }

        modalFieldsSave.addEventListener('click', function() {
            if (fieldsModalForCustomEditorInsert || !!(modalFieldsEl && modalFieldsEl.getAttribute('data-custom-editor-mode') === '1')) {
                var selectedTokens = [];
                var seenTokenMap = {};
                fieldsList.querySelectorAll('.field-cb:checked').forEach(function(cb) {
                    var ht = (cb.getAttribute('data-human-title') || '').trim();
                    if (!ht) return;
                    var token = '{' + ht + '}';
                    if (seenTokenMap[token]) return;
                    seenTokenMap[token] = true;
                    selectedTokens.push(token);
                });
                if (selectedTokens.length && customFieldPayloadTextarea) {
                    var taVal = customFieldPayloadTextarea.value || '';
                    var pos = customFieldPayloadTextarea.selectionStart != null ? customFieldPayloadTextarea.selectionStart : taVal.length;
                    var prefix = (taVal && pos > 0 && !/\s/.test(taVal.charAt(pos - 1))) ? ' ' : '';
                    insertTextAtTextareaCursor(customFieldPayloadTextarea, prefix + selectedTokens.join(' '));
                }
                fieldsModalForCustomEditorInsert = false;
                if (modalFieldsEl) modalFieldsEl.removeAttribute('data-custom-editor-mode');
                var settingsTab = document.querySelector('#modalFields [href="#settingsTabPane"]');
                var customTab = document.querySelector('#modalFields [href="#customFieldTabPane"]');
                if (settingsTab) settingsTab.closest('.nav-item').classList.remove('d-none');
                if (customTab) {
                    customTab.closest('.nav-item').classList.remove('d-none');
                    if (window.bootstrap && bootstrap.Tab) {
                        try { bootstrap.Tab.getOrCreateInstance(customTab).show(); } catch (e) {}
                    }
                }
                return;
            }
            if (fieldsModalForFilterTableIndex != null) {
                var st = tableStates[fieldsModalForFilterTableIndex];
                if (!st) { fieldsModalForFilterTableIndex = null; fieldsModalForFilterSource = null; return; }
                var existingKeys = {};
                (st.filterFields || []).forEach(function(f) {
                    var fk = String((f && f.key) || '').trim().toLowerCase();
                    if (fk) existingKeys[fk] = true;
                });
                fieldsList.querySelectorAll('.field-cb:checked').forEach(function(cb) {
                    var k = (cb.getAttribute('data-entitykey') || '').trim();
                    var ht = (cb.getAttribute('data-human-title') || '').trim();
                    var fType = (cb.getAttribute('data-field-type') || '').trim();
                    var b24Field = (cb.getAttribute('data-b24-field') || '').trim();
                    var columnName = (cb.getAttribute('data-column-name') || '').trim();
                    var nt = (cb.getAttribute('data-nested-type') || '').trim();
                    if (!k || !ht || nt) return;
                    var key = k + '::' + ht;
                    var normKey = key.toLowerCase();
                    if (existingKeys[normKey]) return;
                    existingKeys[normKey] = true;
                    var type = (isStageLikeField(ht, key) || isDropdownFieldType(fType)) ? 'multiselect' : 'text';
                    st.filterFields = st.filterFields || [];
                    st.filterFields.push({ label: ht, key: key, type: type, sourceFieldType: fType, sourceB24Field: b24Field, sourceColumnName: columnName });
                });
                modalFields.hide();
                filterModalTableIndex = fieldsModalForFilterTableIndex;
                loadData(fieldsModalForFilterTableIndex);
                if (fieldsModalForFilterSource === 'modal') {
                    openFilterModal(fieldsModalForFilterTableIndex);
                } else {
                    openFilterDropdown(fieldsModalForFilterTableIndex);
                }
                fieldsModalForFilterTableIndex = null;
                fieldsModalForFilterSource = null;
                return;
            }
            var st = tableStates[currentTableIndex];
            if (!st) return;
            var byKey = {};
            var activeNestedByKey = {};
            var nestedFieldsByKey = {};
            st.selectedEntities.forEach(function(e) {
                var k = entityKey(e);
                byKey[k] = [];
                activeNestedByKey[k] = [];
                nestedFieldsByKey[k] = {};
            });
            fieldsList.querySelectorAll('.field-cb:checked').forEach(function(cb) {
                var k = cb.getAttribute('data-entitykey');
                var ht = cb.getAttribute('data-human-title');
                var nt = (cb.getAttribute('data-nested-type') || '').trim();
                if (k && ht && byKey[k]) byKey[k].push(ht);
                if (k && nt && activeNestedByKey[k] && activeNestedByKey[k].indexOf(nt) < 0) activeNestedByKey[k].push(nt);
                if (k && nt && ht && nestedFieldsByKey[k]) {
                    if (!nestedFieldsByKey[k][nt]) nestedFieldsByKey[k][nt] = [];
                    if (nestedFieldsByKey[k][nt].indexOf(ht) < 0) nestedFieldsByKey[k][nt].push(ht);
                }
            });
            st.selectedFields = st.selectedEntities.map(function(e) {
                var k = entityKey(e);
                return { entityKey: k, human_titles: byKey[k] || [], activeNestedTypes: activeNestedByKey[k] || [], nestedFields: nestedFieldsByKey[k] || {} };
            });
            st.selectedCustomFieldCodes = Array.from(document.querySelectorAll('#customFieldsListInFieldsTab .custom-fields-tab-cb:checked'))
                .map(function(cb) { return String(cb.getAttribute('data-custom-field-code') || '').trim(); })
                .filter(function(code, idx, arr) { return !!code && arr.indexOf(code) === idx; });
            var tableStyleSelect = document.getElementById('tableStyleSelect');
            if (tableStyleSelect && TABLE_STYLES[tableStyleSelect.value]) {
                st.tableStyle = tableStyleSelect.value;
                applyTableStyleToSection(currentTableIndex);
            }
            var descField = document.getElementById('settingsModalTableDescription');
            if (descField) st.tableDescription = (descField.value && String(descField.value).trim()) ? descField.value.trim() : '';
            updateTableTitleBlock(currentTableIndex);
            clearColumnOrderForTable(currentTableIndex);
            clearColumnWidthsForTable(currentTableIndex);
            rebuildAllColumnsFromSelectedFields(currentTableIndex);
            loadData(currentTableIndex);
            saveConfig();
            saveConfigToStorage();
            setTimeout(function() {
                saveConfig();
                saveConfigToStorage();
            }, 0);
            modalFields.hide();
            // Автосохранение шаблона на сервере (общий для всех пользователей) после выбора полей
            saveTemplateSnapshot(currentTableIndex);
        });

        var settingsModalDeleteTableBtn = document.getElementById('settingsModalDeleteTableBtn');
        if (settingsModalDeleteTableBtn) {
            settingsModalDeleteTableBtn.addEventListener('click', function() {
                var idx = currentTableIndex;
                modalFields.hide();
                deleteTableAtIndex(idx);
            });
        }

        function loadFieldsThenData(tableIndex, openModalIfNoFields) {
            if (openModalIfNoFields === undefined) openModalIfNoFields = true;
            var st = tableStates[tableIndex];
            if (!st) return;
            var els = getSectionEls(tableIndex);
            if (!st.selectedEntities.length) {
                if (els.emptyBlock) els.emptyBlock.classList.remove('d-none');
                if (els.gridBlock) els.gridBlock.classList.add('d-none');
                if (els.gridTopRow) els.gridTopRow.classList.add('d-none');
                if (els.searchFilterRow) els.searchFilterRow.classList.add('d-none');
                if (els.paginationBlock) els.paginationBlock.classList.add('d-none');
                return;
            }
            var hasAnyFields = st.selectedFields.some(function(f) { return f.human_titles && f.human_titles.length; });
            if (!hasAnyFields) {
                if (openModalIfNoFields) { currentTableIndex = tableIndex; openFieldsModal(); }
                else {
                    if (els.emptyBlock) els.emptyBlock.classList.remove('d-none');
                    if (els.gridBlock) els.gridBlock.classList.add('d-none');
                    if (els.gridTopRow) els.gridTopRow.classList.add('d-none');
                    if (els.searchFilterRow) els.searchFilterRow.classList.add('d-none');
                    if (els.paginationBlock) els.paginationBlock.classList.add('d-none');
                }
                return;
            }
            loadData(tableIndex);
        }

        var FIRST_BATCH_SIZE = 2000;
        function resolveSmartEntityByNestedType(typeToken, smartEntities) {
            var token = String(typeToken || '');
            if (!token || token.indexOf('smart_process::') !== 0) return null;
            var raw = token.slice('smart_process::'.length);
            var rawNorm = normalizeSearchText(raw.replace(/_/g, ' '));
            return (smartEntities || []).find(function(e) {
                var eKey = String((e && e.entity_key) || '');
                var eTitle = String((e && e.title) || eKey);
                return normalizeSearchText(eKey) === normalizeSearchText(raw)
                    || normalizeSearchText(eKey) === rawNorm
                    || normalizeSearchText(eTitle) === rawNorm;
            }) || null;
        }

        function resolveNestedMappedEntity(typeToken, knownEntities) {
            var typBase = String(typeToken || '').split('::')[0].toLowerCase();
            if (!typBase) return null;
            if (typBase === 'smart_process') return resolveSmartEntityByNestedType(typeToken, knownEntities || []);
            if (typBase === 'contact' || typBase === 'lead' || typBase === 'company') {
                return (knownEntities || []).find(function(e) {
                    return !!e && (
                        String(e.type || '').toLowerCase() === typBase
                        || String(e.entity_key || '').toLowerCase() === typBase
                    );
                }) || { type: typBase, entity_key: typBase, title: typBase };
            }
            return null;
        }

        function expandEntitiesFromNestedFields(st) {
            return loadEntitiesList().catch(function() { return entitiesList || []; }).then(function(list) {
                var knownEntities = (list || []);
                var expanded = (st && st.selectedEntities && Array.isArray(st.selectedEntities)) ? st.selectedEntities.slice() : [];
                var nestedTitlesByEntity = {};
                (st && st.selectedFields && Array.isArray(st.selectedFields) ? st.selectedFields : []).forEach(function(f) {
                    var nested = (f && f.nestedFields && typeof f.nestedFields === 'object') ? f.nestedFields : {};
                    Object.keys(nested).forEach(function(typ) {
                        var typBase = String(typ || '').split('::')[0].toLowerCase();
                        var ent = null;
                        if (typBase === 'smart_process') {
                            ent = resolveSmartEntityByNestedType(typ, knownEntities);
                        } else if (typBase === 'contact' || typBase === 'lead' || typBase === 'company') {
                            ent = (knownEntities || []).find(function(e) {
                                return !!e && (
                                    String(e.type || '').toLowerCase() === typBase
                                    || String(e.entity_key || '').toLowerCase() === typBase
                                );
                            }) || { type: typBase, entity_key: typBase, title: typBase };
                        }
                        if (!ent) return;
                        var ek = entityKey(ent);
                        if (!nestedTitlesByEntity[ek]) nestedTitlesByEntity[ek] = [];
                        (nested[typ] || []).forEach(function(t) {
                            if (t && nestedTitlesByEntity[ek].indexOf(t) < 0) nestedTitlesByEntity[ek].push(t);
                        });
                        if (!expanded.some(function(x) { return entityKey(x) === ek; })) {
                            expanded.push({
                                type: ent.type || typBase,
                                entity_key: ent.entity_key || typBase,
                                title: ent.title || ent.entity_key || typBase
                            });
                        }
                    });
                });
                return { expandedEntities: expanded, nestedTitlesByEntity: nestedTitlesByEntity };
            });
        }

        function fetchPage(ent, titles, key, offset, limit, filterFieldMaps) {
            var url = API.metaData + '?type=' + encodeURIComponent(ent.type) + '&limit=' + limit + '&offset=' + offset;
            // Передаём entity_key для всех сущностей, где он есть.
            // В смешанных таблицах upstream может опираться на этот параметр.
            if (ent.entity_key) url += '&entity_key=' + encodeURIComponent(ent.entity_key);
            if (ent.category_id != null && ent.category_id !== '') url += '&category_id=' + encodeURIComponent(String(ent.category_id));
            if (titles && titles.length) url += '&fields=' + titles.map(function(t) { return encodeURIComponent(t); }).join(',');
            return fetch(url).then(function(r) { return r.json(); }).then(function(data) {
                var list = (data && data.data) ? data.data : [];
                var total = (data && data.total) != null ? data.total : 0;
                var out = [];
                function resolveRowValue(row, title) {
                    if (!row) return '';
                    if (Object.prototype.hasOwnProperty.call(row, title)) return row[title];
                    var target = normalizeSearchText(title || '');
                    if (!target) return '';
                    var keys = Object.keys(row);
                    for (var i = 0; i < keys.length; i++) {
                        var kk = keys[i];
                        if (normalizeSearchText(kk) === target) return row[kk];
                    }
                    return '';
                }
                list.forEach(function(row) {
                    var o = { _entityKey: key };
                    titles.forEach(function(t) {
                        var val = resolveRowValue(row, t);
                        if (val !== null && typeof val === 'object' && !Array.isArray(val)) val = JSON.stringify(val);
                        o[key + '::' + t] = val != null ? val : '';
                    });
                    (filterFieldMaps || []).forEach(function(m) {
                        if (!m || !m.title) return;
                        var targetKey = key + '::' + m.title;
                        if (o[targetKey] != null && String(o[targetKey]).trim() !== '') return;
                        var aliases = m.aliases || [];
                        for (var i = 0; i < aliases.length; i++) {
                            var a = aliases[i];
                            if (!a) continue;
                            var vv = resolveRowValue(row, a);
                            if (vv == null || vv === '') continue;
                            if (vv !== null && typeof vv === 'object' && !Array.isArray(vv)) vv = JSON.stringify(vv);
                            o[targetKey] = vv;
                            break;
                        }
                    });
                    out.push(o);
                });
                return { rows: out, total: total };
            });
        }

        function loadData(tableIndex, skipMetaWarmup, skipEntityExpansion) {
            var st = tableStates[tableIndex];
            if (!st || !st.selectedEntities.length) return;
            if (st.type === 'card') return;
            if (!skipMetaWarmup) {
                var missingMetaEntities = st.selectedEntities.filter(function(ent) {
                    return !fieldsCache[entityKey(ent)];
                });
                if (missingMetaEntities.length) {
                    Promise.all(missingMetaEntities.map(function(ent) {
                        return loadFieldsForEntity(ent).catch(function() { return { fields: [], nested: [] }; });
                    })).then(function() {
                        loadData(tableIndex, true, false);
                    }).catch(function() {
                        loadData(tableIndex, true, false);
                    });
                    return;
                }
            }
            if (!skipEntityExpansion) {
                expandEntitiesFromNestedFields(st).then(function(ctx) {
                    st._expandedLoadEntities = (ctx && ctx.expandedEntities) ? ctx.expandedEntities : null;
                    st._nestedTitlesByEntity = (ctx && ctx.nestedTitlesByEntity) ? ctx.nestedTitlesByEntity : {};
                    loadData(tableIndex, true, true);
                }).catch(function() {
                    st._expandedLoadEntities = null;
                    st._nestedTitlesByEntity = {};
                    loadData(tableIndex, true, true);
                });
                return;
            }
            var els = getSectionEls(tableIndex);
            var previousAllColumns = Array.isArray(st.allColumns) ? st.allColumns.slice() : [];
            var previousDomColumnKeys = getColumnKeysFromSection(tableIndex);
            var savedOrderKeys = getColumnOrderForTable(tableIndex) || [];
            st.fullData = [];
            st.allColumns = [];
            showLoading(tableIndex, true, 'Загрузка данных...');
            var columnsByKey = [];
            var FUNNEL_FIELD = 'Воронка';
            var filterTitlesByEntityKey = {};
            var filterFieldMapsByEntityKey = {};
            (st.filterFields || []).forEach(function(f) {
                var k = (f && f.key) ? String(f.key) : '';
                var sep = k.indexOf('::');
                if (sep <= 0) return;
                var ek = k.slice(0, sep);
                var title = k.slice(sep + 2);
                if (!ek || !title) return;
                if (!filterTitlesByEntityKey[ek]) filterTitlesByEntityKey[ek] = [];
                if (filterTitlesByEntityKey[ek].indexOf(title) < 0) filterTitlesByEntityKey[ek].push(title);
                var aliases = [];
                if (f && f.sourceB24Field) aliases.push(String(f.sourceB24Field).trim());
                if (f && f.sourceColumnName) aliases.push(String(f.sourceColumnName).trim());
                if (aliases.length) {
                    if (!filterFieldMapsByEntityKey[ek]) filterFieldMapsByEntityKey[ek] = [];
                    filterFieldMapsByEntityKey[ek].push({ title: title, aliases: aliases });
                }
            });
            var entitiesForLoad = (st._expandedLoadEntities && st._expandedLoadEntities.length) ? st._expandedLoadEntities : st.selectedEntities;
            var nestedTitlesByEntity = st._nestedTitlesByEntity || {};
            entitiesForLoad.forEach(function(ent) {
                var key = entityKey(ent);
                var sel = st.selectedFields.find(function(f) { return f.entityKey === key; });
                var displayTitles = (sel && sel.human_titles) ? sel.human_titles.slice() : [];
                // Keep non-smart nested fields under their base entity (deal/contact/lead/company).
                // Smart nested fields are resolved to their own smart entity via nestedTitlesByEntity.
                if (sel && sel.nestedFields && typeof sel.nestedFields === 'object') {
                    Object.keys(sel.nestedFields).forEach(function(typ) {
                        var typBase = String(typ || '').split('::')[0].toLowerCase();
                        if (typBase === 'smart_process' || typBase === 'contact' || typBase === 'lead' || typBase === 'company') return;
                        (sel.nestedFields[typ] || []).forEach(function(t) {
                            if (t && displayTitles.indexOf(t) < 0) displayTitles.push(t);
                        });
                    });
                }
                if (!displayTitles.length && nestedTitlesByEntity[key] && nestedTitlesByEntity[key].length) {
                    displayTitles = nestedTitlesByEntity[key].slice();
                }
                // Also restore titles from currently rendered headers (before reload)
                if (previousDomColumnKeys && previousDomColumnKeys.length) {
                    previousDomColumnKeys.forEach(function(colKey) {
                        var k = String(colKey || '');
                        if (k.indexOf(key + '::') !== 0) return;
                        var t = k.slice((key + '::').length);
                        if (t && displayTitles.indexOf(t) < 0) displayTitles.push(t);
                    });
                }
                // Restore from persisted column order (server/local) for mixed-entity cases after reload.
                if (savedOrderKeys && savedOrderKeys.length) {
                    savedOrderKeys.forEach(function(colKey) {
                        var k = String(colKey || '');
                        if (k.indexOf(key + '::') !== 0) return;
                        var t = k.slice((key + '::').length);
                        if (t && displayTitles.indexOf(t) < 0) displayTitles.push(t);
                    });
                }
                // Fallback: if selectedFields lost titles for an entity, restore from current columns for that entity
                if (!displayTitles.length && previousAllColumns.length) {
                    previousAllColumns.forEach(function(col) {
                        if (!col || !col.key) return;
                        var k = String(col.key);
                        if (k.indexOf(key + '::') !== 0) return;
                        var t = k.slice((key + '::').length);
                        if (t && displayTitles.indexOf(t) < 0) displayTitles.push(t);
                    });
                }
                // In mixed mode, nested smart-process fields may be mirrored into deal.human_titles.
                // Keep them only under real smart entity to avoid duplicate columns.
                if (ent.type !== 'smart_process' && sel && sel.nestedFields && typeof sel.nestedFields === 'object') {
                    var mirroredNorm = {};
                    var baseFieldsMeta = (fieldsCache[key] && Array.isArray(fieldsCache[key].fields)) ? fieldsCache[key].fields : [];
                    function hasDirectFieldWithTitle(title) {
                        var wanted = normalizeSearchText(title);
                        if (!wanted) return false;
                        for (var mf = 0; mf < baseFieldsMeta.length; mf++) {
                            var meta = baseFieldsMeta[mf];
                            if (!meta) continue;
                            if (normalizeSearchText(String(meta.human_title || '')) === wanted) return true;
                            if (normalizeSearchText(String(meta.column_name || '')) === wanted) return true;
                        }
                        return false;
                    }
                    Object.keys(sel.nestedFields).forEach(function(typ) {
                        var typBase = String(typ || '').split('::')[0].toLowerCase();
                        if (typBase !== 'smart_process' && typBase !== 'contact' && typBase !== 'lead' && typBase !== 'company') return;
                        var mappedSmart = null;
                        if (typBase === 'smart_process') {
                            mappedSmart = resolveSmartEntityByNestedType(typ, entitiesForLoad);
                        } else {
                            mappedSmart = (entitiesForLoad || []).find(function(e) {
                                return String((e && e.type) || '').toLowerCase() === typBase
                                    || String((e && e.entity_key) || '').toLowerCase() === typBase;
                            }) || null;
                        }
                        if (!mappedSmart) return;
                        if (entityKey(mappedSmart) === key) return;
                        (sel.nestedFields[typ] || []).forEach(function(t) {
                            var normTitle = normalizeSearchText(t);
                            if (!normTitle) return;
                            // Do not hide a real field of the current entity just because another entity has the same title.
                            if (hasDirectFieldWithTitle(t)) return;
                            mirroredNorm[normTitle] = true;
                        });
                    });
                    if (Object.keys(mirroredNorm).length) {
                        displayTitles = displayTitles.filter(function(t) {
                            return !mirroredNorm[normalizeSearchText(t)];
                        });
                    }
                }
                // Keep unique titles in stable order.
                var seenTitle = {};
                displayTitles = displayTitles.filter(function(t) {
                    var n = normalizeSearchText(t);
                    if (!n || seenTitle[n]) return false;
                    seenTitle[n] = true;
                    return true;
                });
                if (!displayTitles.length) return;
                var fetchTitles = displayTitles.slice();
                var selectedFieldMaps = [];
                var cache = fieldsCache[key];
                displayTitles.forEach(function(title) {
                    var aliases = [];
                    if (cache && cache.fields && Array.isArray(cache.fields)) {
                        cache.fields.forEach(function(meta) {
                            if (!meta) return;
                            var ht = String(meta.human_title || '').trim();
                            if (!ht) return;
                            if (normalizeSearchText(ht) !== normalizeSearchText(title)) return;
                            var cn = String(meta.column_name || '').trim();
                            var b24 = String(meta.b24_field || '').trim();
                            if (cn && aliases.indexOf(cn) < 0) aliases.push(cn);
                            if (b24 && aliases.indexOf(b24) < 0) aliases.push(b24);
                        });
                    }
                    if (aliases.length) selectedFieldMaps.push({ title: title, aliases: aliases });
                });
                var extraFilterTitles = filterTitlesByEntityKey[key] || [];
                extraFilterTitles.forEach(function(t) {
                    if (fetchTitles.indexOf(t) < 0) fetchTitles.push(t);
                });
                (filterFieldMapsByEntityKey[key] || []).forEach(function(m) {
                    (m.aliases || []).forEach(function(a) {
                        if (a && fetchTitles.indexOf(a) < 0) fetchTitles.push(a);
                    });
                });
                if (ent.type === 'deal' && ent.category_id != null && displayTitles.indexOf(FUNNEL_FIELD) < 0) {
                    fetchTitles.push(FUNNEL_FIELD);
                }
                // console.debug helper: helps verify all selected entities are requested
                if (typeof console !== 'undefined' && console.debug) {
                    console.debug('[entity-table] request entity', key, { type: ent.type, titles: displayTitles.length, fetchTitles: fetchTitles.length });
                }
                displayTitles.forEach(function(t) {
                    st.allColumns.push({ key: key + '::' + t, label: t, entityKey: key, entityTitle: ent.title || entityTitleForNested(ent) });
                });
                var selectedCustomCodes = ensureSelectedCustomFieldCodes(st);
                if (selectedCustomCodes.length) {
                    (st.customFields || []).forEach(function(cf) {
                        if (!cf || !cf.target_entity || !cf.target_entity.entity_key) return;
                        if (String(cf.target_entity.entity_key) !== String(key)) return;
                        var code = String(cf.code || '').trim();
                        if (!code || selectedCustomCodes.indexOf(code) < 0) return;
                        if (fetchTitles.indexOf(code) < 0) fetchTitles.push(code);
                        var colKey = key + '::' + code;
                        if (!st.allColumns.some(function(c) { return c && c.key === colKey; })) {
                            st.allColumns.push({
                                key: colKey,
                                label: String((cf.name || code)).trim() || code,
                                entityKey: key,
                                entityTitle: ent.title || entityTitleForNested(ent)
                            });
                        }
                    });
                }
                columnsByKey.push({
                    ent: ent,
                    titles: fetchTitles,
                    key: key,
                    displayTitles: displayTitles,
                    filterFieldMaps: (selectedFieldMaps || []).concat(filterFieldMapsByEntityKey[key] || [])
                });
            });
            if (typeof console !== 'undefined' && console.debug) {
                console.debug('[entity-table] columnsByKey', columnsByKey.map(function(x) { return x.key + ' [' + x.displayTitles.length + ']'; }));
            }
            if (columnsByKey.length === 0) {
                showLoading(tableIndex, false);
                st.fullData = [];
                st.allColumns = [];
                if (els.emptyBlock) els.emptyBlock.classList.remove('d-none');
                if (els.gridBlock) els.gridBlock.classList.add('d-none');
                if (els.gridTopRow) els.gridTopRow.classList.add('d-none');
                if (els.searchFilterRow) els.searchFilterRow.classList.add('d-none');
                if (els.paginationBlock) els.paginationBlock.classList.add('d-none');
                renderGrid(tableIndex);
                return;
            }
            var seenKey = {};
            st.allColumns = st.allColumns.filter(function(c) {
                if (seenKey[c.key]) return false;
                seenKey[c.key] = true;
                return true;
            });
            var validKeys = getValidColumnKeysFromSelectedFields(st);
            st.allColumns = st.allColumns.filter(function(c) { return !isSystemColumn(c.key) && validKeys[c.key]; });
            var labelCount = {};
            st.allColumns.forEach(function(c) {
                var ln = normalizeFieldLabel(c.label || '');
                labelCount[ln] = (labelCount[ln] || 0) + 1;
            });
            var multiEntityMode = ((st._expandedLoadEntities && st._expandedLoadEntities.length) || (st.selectedEntities && st.selectedEntities.length) || 0) > 1;
            st.allColumns.forEach(function(c) {
                var ln = normalizeFieldLabel(c.label || '');
                if (multiEntityMode || labelCount[ln] > 1) c.label = c.label + ' (' + (c.entityTitle || c.entityKey) + ')';
            });
            st.allColumns = applyColumnOrder(st.allColumns, getColumnOrderForTable(tableIndex));
            if (!st.columnWidths || !Object.keys(st.columnWidths).length) st.columnWidths = loadColumnWidths(tableIndex);

            var firstBatchPromises = columnsByKey.map(function(obj) {
                return fetchPage(obj.ent, obj.titles, obj.key, 0, FIRST_BATCH_SIZE, obj.filterFieldMaps);
            });
            Promise.all(firstBatchPromises).then(function(firstResults) {
                function applyDealFunnelFilter(rows, obj) {
                    if (!obj || !obj.ent || obj.ent.type !== 'deal' || obj.ent.category_id == null) return rows || [];
                    var funnelKey = obj.key + '::' + FUNNEL_FIELD;
                    var funnelTitle = String(obj.ent.title || '').trim();
                    var funnelCatId = String(obj.ent.category_id).trim();
                    return (rows || []).filter(function(row) {
                        var v = row[funnelKey];
                        if (v == null || v === '') return false;
                        var s = String(v).trim();
                        return s === funnelTitle || s === funnelCatId;
                    });
                }
                var mergedEntityState = null;
                if (firstResults.length === 1) {
                    var onlyObj = columnsByKey[0];
                    var onlyRows = applyDealFunnelFilter(firstResults[0].rows, onlyObj);
                    onlyRows.forEach(function(row) { st.fullData.push(row); });
                } else {
                    mergedEntityState = firstResults.map(function(res, idx) {
                        var obj = columnsByKey[idx];
                        return {
                            obj: obj,
                            rows: applyDealFunnelFilter(res.rows, obj),
                            total: res.total || 0,
                            offset: (res.rows && res.rows.length) ? res.rows.length : 0
                        };
                    });
                    var initialMax = 0;
                    mergedEntityState.forEach(function(s) {
                        if (s.rows.length > initialMax) initialMax = s.rows.length;
                    });
                    for (var r = 0; r < initialMax; r++) {
                        var mergedRow = {};
                        mergedEntityState.forEach(function(s) {
                            if (s.rows[r]) Object.assign(mergedRow, s.rows[r]);
                        });
                        if (Object.keys(mergedRow).length) st.fullData.push(mergedRow);
                    }
                }
                showLoading(tableIndex, false);
                st.currentPage = 1;
                st.pageSize = parseInt(els.pageSizeSelect && els.pageSizeSelect.value ? els.pageSizeSelect.value : 25, 10) || 25;
                renderGrid(tableIndex);
                refreshFilterModalIfOpen(tableIndex);
                if (els.emptyBlock) els.emptyBlock.classList.add('d-none');
                if (els.gridTopRow) els.gridTopRow.classList.remove('d-none');
                if (els.searchFilterRow) els.searchFilterRow.classList.remove('d-none');
                if (els.gridBlock) els.gridBlock.classList.remove('d-none');
                if (els.paginationBlock) els.paginationBlock.classList.remove('d-none');
                updateTableTitleBlock(tableIndex);

                /* На дашборде (режим только просмотр) не догружаем все записи — только первая порция по настройке таблицы */
                var isDashboard = isReadOnly || isDashboardSlug();
                if (!isDashboard && firstResults.length === 1) {
                    columnsByKey.forEach(function(obj, idx) {
                        var res = firstResults[idx];
                        var total = res.total;
                        var offset = res.rows.length;
                        if (offset >= total) return;
                        var funnelKeyF = (obj.ent.type === 'deal' && obj.ent.category_id != null) ? (obj.key + '::' + FUNNEL_FIELD) : null;
                        var funnelTitleF = funnelKeyF ? String(obj.ent.title || '').trim() : '';
                        var funnelCatIdF = funnelKeyF ? String(obj.ent.category_id).trim() : '';
                        function fetchMore() {
                            fetchPage(obj.ent, obj.titles, obj.key, offset, 10000, obj.filterFieldMaps).then(function(nextRes) {
                                var rows = nextRes.rows;
                                if (funnelKeyF) {
                                    rows = rows.filter(function(row) {
                                        var v = row[funnelKeyF];
                                        if (v == null || v === '') return false;
                                        var s = String(v).trim();
                                        return s === funnelTitleF || s === funnelCatIdF;
                                    });
                                }
                                rows.forEach(function(row) { st.fullData.push(row); });
                                offset += nextRes.rows.length;
                                renderGrid(tableIndex);
                                refreshFilterModalIfOpen(tableIndex);
                                if (offset < nextRes.total) fetchMore();
                            }).catch(function() {});
                        }
                        fetchMore();
                    });
                } else if (!isDashboard && firstResults.length > 1 && mergedEntityState) {
                    // Mixed entity mode can explode into many heavy requests (for each entity and page).
                    // Keep first batch only to avoid request storms and UI lockups.
                }
            }).catch(function(err) {
                showLoading(tableIndex, false);
                console.error(err);
            });
        }

        /** Compute aggregate (count/sum/avg/min/max) over rows for card report. fieldKey is entityKey::title. */
        function computeAggregate(rows, formula, rowKeys) {
            if (!rows || !rows.length) return null;
            var agg = (formula && formula.aggregate) ? formula.aggregate : 'count';
            if (agg === 'count') return rows.length;
            var fieldKey = (formula && formula.fieldKey) ? formula.fieldKey : null;
            if (!fieldKey || !rowKeys || rowKeys.indexOf(fieldKey) < 0) return rows.length;
            var nums = [];
            rows.forEach(function(r) {
                var v = r[fieldKey];
                if (v == null || v === '') return;
                if (typeof v === 'number' && !isNaN(v)) { nums.push(v); return; }
                var s = String(v).trim().replace(/\s/g, '').replace(',', '.');
                var n = parseFloat(s);
                if (!isNaN(n)) nums.push(n);
            });
            if (nums.length === 0) return null;
            if (agg === 'sum') return nums.reduce(function(a, b) { return a + b; }, 0);
            if (agg === 'avg') return nums.reduce(function(a, b) { return a + b; }, 0) / nums.length;
            if (agg === 'min') return Math.min.apply(null, nums);
            if (agg === 'max') return Math.max.apply(null, nums);
            return null;
        }

        function loadCardData(cardIndex) {
            var st = tableStates[cardIndex];
            if (!st || st.type !== 'card') {
                if (st && st.type === 'card') updateCardUI(cardIndex);
                return;
            }
            if (window.EntityCard && typeof window.EntityCard.loadCardData === 'function') {
                window.EntityCard.loadCardData(cardIndex);
                return;
            }
            if (!st.selectedEntities.length) {
                updateCardUI(cardIndex);
                return;
            }
            var ent = st.selectedEntities[0];
            var key = entityKey(ent);
            var sel = st.selectedFields.find(function(f) { return f.entityKey === key; });
            var titles = (sel && sel.human_titles && sel.human_titles.length) ? sel.human_titles : [];
            if (titles.length === 0) {
                st.fullData = [];
                updateCardUI(cardIndex);
                return;
            }
            var filterFieldMaps = [];
            var cache = fieldsCache[key];
            if (cache && cache.fields && Array.isArray(cache.fields)) {
                (st.filterFields || []).forEach(function(f) {
                    if (!f || !f.label) return;
                    var ht = String(f.label || '').trim();
                    var aliases = [];
                    cache.fields.forEach(function(meta) {
                        if (!meta) return;
                        if (normalizeSearchText(String(meta.human_title || '')) === normalizeSearchText(ht)) {
                            var cn = String(meta.column_name || '').trim();
                            var b24 = String(meta.b24_field || '').trim();
                            if (cn && aliases.indexOf(cn) < 0) aliases.push(cn);
                            if (b24 && aliases.indexOf(b24) < 0) aliases.push(b24);
                        }
                    });
                    if (aliases.length) filterFieldMaps.push({ title: ht, aliases: aliases });
                });
            }
            fetchPage(ent, titles, key, 0, 10000, filterFieldMaps).then(function(res) {
                var rows = res.rows || [];
                if (st.filterFields && st.filterFields.length) {
                    rows = rows.filter(function(row) {
                        return st.filterFields.every(function(f) {
                            if (!f.label) return true;
                            var targetKey = key + '::' + f.label;
                            var val = row[targetKey];
                            if (f.selectedValues && f.selectedValues.length) return f.selectedValues.some(function(sv) { return String(val) === String(sv); });
                            if (f.value != null && String(f.value).trim() !== '') return String(val || '').toLowerCase().indexOf(String(f.value).trim().toLowerCase()) >= 0;
                            return true;
                        });
                    });
                }
                st.fullData = rows;
                var rowKeys = rows.length ? Object.keys(rows[0]) : [];
                var mainVal = computeAggregate(rows, st.mainFormula, rowKeys);
                var secVal = (st.secondaryFormula && (st.secondaryFormula.aggregate || st.secondaryFormula.fieldKey)) ? computeAggregate(rows, st.secondaryFormula, rowKeys) : null;
                var els = getSectionEls(cardIndex);
                if (els.mainValueEl) els.mainValueEl.textContent = (mainVal != null) ? (typeof mainVal === 'number' && (mainVal % 1 !== 0 || mainVal > 1e9) ? mainVal.toLocaleString('ru-RU', { maximumFractionDigits: 2 }) : mainVal) : '—';
                if (els.secondaryValueEl) {
                    if (secVal != null) els.secondaryValueEl.textContent = (st.secondaryFormula && st.secondaryFormula.label) ? (st.secondaryFormula.label + ': ' + secVal) : String(secVal);
                    else els.secondaryValueEl.textContent = (st.secondaryFormula && st.secondaryFormula.label) ? st.secondaryFormula.label : '';
                }
            }).catch(function() {
                var els = getSectionEls(cardIndex);
                if (els.mainValueEl) els.mainValueEl.textContent = '—';
                if (els.secondaryValueEl) els.secondaryValueEl.textContent = '';
            });
        }

        function updateCardUI(cardIndex) {
            var st = tableStates[cardIndex];
            if (!st || st.type !== 'card') return;
            if (window.EntityCard && typeof window.EntityCard.updateCardUI === 'function') {
                window.EntityCard.updateCardUI(cardIndex);
                return;
            }
            var els = getSectionEls(cardIndex);
            if (!els.section) return;
            if (els.cardTitleEl) els.cardTitleEl.textContent = (st.cardTitle && st.cardTitle.trim()) ? st.cardTitle.trim() : 'Карточка';
            if (els.iconEl) {
                els.iconEl.className = (st.icon || 'iconoir-activity') + ' fs-4';
            }
            if (els.iconWrap) {
                els.iconWrap.className = 'report-card-icon-wrap bg-primary-subtle text-primary';
            }
            loadCardData(cardIndex);
        }

        /** Восстанавливает allColumns из selectedEntities/selectedFields, если колонки потеряны. */
        function rebuildAllColumnsFromSelectedFields(tableIndex) {
            var st = tableStates[tableIndex];
            if (!st || !st.selectedEntities || !st.selectedEntities.length || !st.selectedFields) return;
            var cols = [];
            st.selectedEntities.forEach(function(ent) {
                var key = entityKey(ent);
                var sel = st.selectedFields.find(function(f) { return f.entityKey === key; });
                var displayTitles = (sel && sel.human_titles) ? sel.human_titles : [];
                displayTitles.forEach(function(t) {
                    cols.push({ key: key + '::' + t, label: t, entityKey: key, entityTitle: ent.title || entityTitleForNested(ent) });
                });
                if (sel && sel.nestedFields && typeof sel.nestedFields === 'object') {
                    Object.keys(sel.nestedFields).forEach(function(typ) {
                        (sel.nestedFields[typ] || []).forEach(function(t) {
                            var mappedEnt = resolveNestedMappedEntity(typ, (st.selectedEntities || []).concat(st._expandedLoadEntities || []).concat(entitiesList || []));
                            if (mappedEnt) {
                                var mappedKey = entityKey(mappedEnt);
                                cols.push({ key: mappedKey + '::' + t, label: t, entityKey: mappedKey, entityTitle: mappedEnt.title || entityTitleForNested(mappedEnt) });
                            } else {
                                cols.push({ key: key + '::' + t, label: t, entityKey: key, entityTitle: ent.title || entityTitleForNested(ent) });
                            }
                        });
                    });
                }
            });
            var seenKey = {};
            cols = cols.filter(function(c) { if (seenKey[c.key]) return false; seenKey[c.key] = true; return true; });
            cols = cols.filter(function(c) { return !isSystemColumn(c.key); });
            var validKeys = getValidColumnKeysFromSelectedFields(st);
            cols = cols.filter(function(c) { return validKeys[c.key]; });
            var labelCount = {};
            cols.forEach(function(c) {
                var ln = normalizeFieldLabel(c.label || '');
                labelCount[ln] = (labelCount[ln] || 0) + 1;
            });
            var multiEntityMode = ((st._expandedLoadEntities && st._expandedLoadEntities.length) || (st.selectedEntities && st.selectedEntities.length) || 0) > 1;
            cols.forEach(function(c) {
                var ln = normalizeFieldLabel(c.label || '');
                if (multiEntityMode || labelCount[ln] > 1) c.label = c.label + ' (' + (c.entityTitle || c.entityKey) + ')';
            });
            st.allColumns = applyColumnOrder(cols, getColumnOrderForTable(tableIndex));
        }

        /** Дополняет selectedFields из allColumns (для текущей страницы). */
        function syncSelectedFieldsFromAllColumns(tableIndex) {
            var st = tableStates[tableIndex];
            if (!st || !st.allColumns || !st.allColumns.length || !st.selectedFields) return;
            st.allColumns.forEach(function(c) {
                var idx = (c.key || '').indexOf('::');
                if (idx <= 0) return;
                var entityKey = c.key.slice(0, idx);
                var title = c.key.slice(idx + 2);
                var sel = st.selectedFields.find(function(f) { return f.entityKey === entityKey; });
                if (sel) {
                    if (!sel.human_titles) sel.human_titles = [];
                    if (sel.human_titles.indexOf(title) < 0) sel.human_titles.push(title);
                }
            });
        }

        /** Строит массив fields для сохранения дэшборда только из allColumns — без опоры на selectedFields. */
        function buildFieldsFromAllColumns(st) {
            if (!st || !st.allColumns || !st.allColumns.length) return (st && st.selectedFields) ? st.selectedFields : [];
            var selectedCustomCodes = ensureSelectedCustomFieldCodes(st);
            var keys = st.allColumns.map(function(c) { return c.key; }).filter(function(k) {
                if (!k) return false;
                var idx = String(k).indexOf('::');
                if (idx <= 0) return true;
                var tail = String(k).slice(idx + 2);
                return !(tail && selectedCustomCodes.indexOf(tail) >= 0);
            });
            return buildFieldsFromColumnKeys(keys);
        }

        /** По списку ключей колонок (entityKey::title) строит массив fields для сохранения. */
        function buildFieldsFromColumnKeys(columnKeys) {
            if (!columnKeys || !columnKeys.length) return [];
            var byKey = {};
            columnKeys.forEach(function(key) {
                if (isSystemColumn(key)) return;
                var idx = (key || '').indexOf('::');
                if (idx <= 0) return;
                var entityKey = key.slice(0, idx);
                var title = key.slice(idx + 2);
                if (!byKey[entityKey]) byKey[entityKey] = { entityKey: entityKey, human_titles: [] };
                if (byKey[entityKey].human_titles.indexOf(title) < 0) byKey[entityKey].human_titles.push(title);
            });
            return Object.keys(byKey).map(function(k) {
                var b = byKey[k];
                return { entityKey: b.entityKey, human_titles: b.human_titles.slice(), activeNestedTypes: [], nestedFields: {} };
            });
        }

        /** Берёт ключи колонок из DOM (то, что реально отрисовано в настройках) — так в дэшборд попадает точная копия. */
        function getColumnKeysFromSection(tableIndex) {
            var els = getSectionEls(tableIndex);
            if (!els.gridHead) return [];
            var keys = [];
            els.gridHead.querySelectorAll('th[data-column-key]').forEach(function(th) {
                var k = th.getAttribute('data-column-key');
                if (k) keys.push(k);
            });
            return keys;
        }

        /** Восстанавливает allColumns из ключей первой строки fullData, если в данных больше полей, чем в allColumns. */
        function rebuildAllColumnsFromData(tableIndex) {
            var st = tableStates[tableIndex];
            if (!st || !st.fullData || !st.fullData.length) return;
            var firstRow = st.fullData[0];
            var dataKeys = Object.keys(firstRow || {}).filter(function(k) { return !isSystemColumn(k); });
            if (!dataKeys.length) return;
            var cols = dataKeys.map(function(k) {
                var label = k;
                var idx = k.indexOf('::');
                if (idx >= 0) label = k.slice(idx + 2);
                return { key: k, label: label, entityKey: k.slice(0, idx >= 0 ? idx : 0), entityTitle: '' };
            });
            st.allColumns = applyColumnOrder(cols, getColumnOrderForTable(tableIndex));
        }

        function tryParseDateValue(v) {
            if (v == null) return null;
            var s = String(v).trim();
            if (!s) return null;
            var m;
            // yyyy-mm-dd / yyyy.mm.dd / yyyy/mm/dd [+ time]
            m = s.match(/^(\d{4})[./-](\d{2})[./-](\d{2})(?:[ T](\d{2}):(\d{2})(?::(\d{2}))?)?(?:\.\d+)?(?:Z)?$/);
            if (m) {
                var y = parseInt(m[1], 10);
                var mo = parseInt(m[2], 10) - 1;
                var d = parseInt(m[3], 10);
                var h = parseInt(m[4] || '0', 10);
                var mi = parseInt(m[5] || '0', 10);
                var se = parseInt(m[6] || '0', 10);
                return new Date(y, mo, d, h, mi, se).getTime();
            }
            // dd-mm-yyyy / dd.mm.yyyy / dd/mm/yyyy [+ time]
            m = s.match(/^(\d{2})[./-](\d{2})[./-](\d{4})(?:[ T](\d{2}):(\d{2})(?::(\d{2}))?)?$/);
            if (m) {
                var dd = parseInt(m[1], 10);
                var mm = parseInt(m[2], 10) - 1;
                var yy = parseInt(m[3], 10);
                var hh = parseInt(m[4] || '0', 10);
                var mii = parseInt(m[5] || '0', 10);
                var ss = parseInt(m[6] || '0', 10);
                return new Date(yy, mm, dd, hh, mii, ss).getTime();
            }
            // Generic parse for ISO-like strings
            var parsed = Date.parse(s);
            if (!isNaN(parsed) && /[-/T:]/.test(s)) return parsed;
            return null;
        }

        function formatDateTimeDisplay(value, includeTime) {
            if (value == null) return '';
            var s = String(value).trim();
            if (!s) return '';
            var m;
            // yyyy-mm-dd[ T]hh:mm[:ss][.ms][Z]
            m = s.match(/^(\d{4})[./-](\d{2})[./-](\d{2})(?:[ T](\d{2}):(\d{2})(?::\d{2})?)?(?:\.\d+)?(?:Z)?$/);
            if (m) {
                var y = m[1], mo = m[2], d = m[3], h = m[4], mi = m[5];
                if (includeTime !== false && h != null && mi != null) return d + '.' + mo + '.' + y + ' ' + h + ':' + mi;
                return d + '.' + mo + '.' + y;
            }
            // dd-mm-yyyy[ T]hh:mm[:ss]
            m = s.match(/^(\d{2})[./-](\d{2})[./-](\d{4})(?:[ T](\d{2}):(\d{2})(?::\d{2})?)?$/);
            if (m) {
                var dd = m[1], mm = m[2], yy = m[3], hh = m[4], mii = m[5];
                if (includeTime !== false && hh != null && mii != null) return dd + '.' + mm + '.' + yy + ' ' + hh + ':' + mii;
                return dd + '.' + mm + '.' + yy;
            }
            return '';
        }

        function isLikelyDateColumn(st, col) {
            if (!st || !col || !col.key) return false;
            var sampleLabel = String((col.label || '') + ' ' + (col.key || '')).toLowerCase();
            if (sampleLabel.indexOf('дата') >= 0 || sampleLabel.indexOf('date') >= 0) return true;
            var rows = st.fullData || [];
            var checked = 0;
            var parsed = 0;
            for (var i = 0; i < rows.length && checked < 20; i++) {
                var v = rows[i] ? rows[i][col.key] : null;
                if (v == null || String(v).trim() === '') continue;
                checked++;
                if (tryParseDateValue(v) != null) parsed++;
            }
            if (!checked) return false;
            return parsed >= Math.max(1, Math.ceil(checked * 0.6));
        }

        function isTimeVisibleForColumn(st, columnKey) {
            if (st && st.dateTimeDisplayByColumn && Object.prototype.hasOwnProperty.call(st.dateTimeDisplayByColumn, columnKey)) {
                return st.dateTimeDisplayByColumn[columnKey] !== false;
            }
            // Backward compatibility with old global setting
            return !!(st && st.showTime === true);
        }

        function toSortableValue(v) {
            if (v == null) return '';
            if (typeof v === 'number') return v;
            var s = String(v).trim();
            if (!s) return '';
            var dateValue = tryParseDateValue(s);
            if (dateValue != null) return dateValue;
            var compact = s.replace(/\s/g, '').replace(',', '.');
            if (/^-?\d+(\.\d+)?([eE][+-]?\d+)?%?$/.test(compact)) {
                var num = parseFloat(compact.replace('%', ''));
                if (!isNaN(num)) return num;
            }
            return s.toLowerCase();
        }

        function sortRowsByColumn(rows, sortKey, sortDir) {
            if (!rows || !rows.length || !sortKey || (sortDir !== 'asc' && sortDir !== 'desc')) return rows || [];
            var factor = sortDir === 'asc' ? 1 : -1;
            return rows.map(function(row, idx) { return { row: row, idx: idx }; }).sort(function(a, b) {
                var av = toSortableValue(a.row[sortKey]);
                var bv = toSortableValue(b.row[sortKey]);
                if (av < bv) return -1 * factor;
                if (av > bv) return 1 * factor;
                return a.idx - b.idx;
            }).map(function(x) { return x.row; });
        }

        function getDefaultSortColumn(st) {
            var cols = (st && st.allColumns && Array.isArray(st.allColumns)) ? st.allColumns : [];
            if (!cols.length) return '';
            function score(col) {
                var sample = normalizeSearchText(String((col && col.label) || '') + ' ' + String((col && col.key) || ''));
                if (!sample) return 0;
                if (sample.indexOf('когда создан') >= 0) return 100;
                if (sample.indexOf('дата создан') >= 0 || sample.indexOf('created at') >= 0) return 95;
                if (sample.indexOf('created') >= 0 || sample.indexOf('дата') >= 0 || sample.indexOf('date') >= 0) return 80;
                var key = String((col && col.key) || '').toLowerCase();
                if (key === 'id' || /::id$/.test(key)) return 70;
                return 0;
            }
            var bestKey = '';
            var bestScore = 0;
            cols.forEach(function(c) {
                var s = score(c);
                if (s > bestScore && c && c.key) {
                    bestScore = s;
                    bestKey = c.key;
                }
            });
            return bestKey;
        }

        function renderGrid(tableIndex) {
            var st = tableStates[tableIndex];
            if (!st) return;
            if (st.type === 'card') return;
            if (st.fullData && st.fullData.length > 0) {
                if (!st.allColumns || st.allColumns.length === 0) {
                    rebuildAllColumnsFromSelectedFields(tableIndex);
                    if (st.allColumns.length === 0) rebuildAllColumnsFromData(tableIndex);
                }
            }
            var els = getSectionEls(tableIndex);
            if (!els.gridHead || !els.gridBody) return;
            var searchInput = els.section ? els.section.querySelector('.searchFilterInputInSection') : null;
            var searchQuery = (searchInput && searchInput.value) ? String(searchInput.value).trim().toLowerCase() : '';
            var filteredRows = applyConfiguredFieldFilters(st.fullData, st);
            if (searchQuery) {
                var searchKeys = (st && st.allColumns && Array.isArray(st.allColumns))
                    ? st.allColumns.map(function(c) { return c && c.key ? c.key : ''; }).filter(Boolean)
                    : [];
                filteredRows = filteredRows.filter(function(row) {
                    return searchKeys.some(function(k) {
                        var v = row[k];
                        if (v == null) return false;
                        return String(v).toLowerCase().indexOf(searchQuery) >= 0;
                    });
                });
            }
            var effectiveSortKey = st.sortKey;
            var effectiveSortDir = st.sortDir;
            if (!effectiveSortKey || (effectiveSortDir !== 'asc' && effectiveSortDir !== 'desc')) {
                var fallbackSortKey = getDefaultSortColumn(st);
                if (fallbackSortKey) {
                    effectiveSortKey = fallbackSortKey;
                    effectiveSortDir = 'desc';
                }
            }
            var sortedRows = sortRowsByColumn(filteredRows, effectiveSortKey, effectiveSortDir);
            var totalRows = sortedRows.length;
            var totalPages = totalRows ? Math.ceil(totalRows / st.pageSize) : 0;
            if (totalPages > 0 && st.currentPage > totalPages) st.currentPage = totalPages;
            if (totalPages === 0) st.currentPage = 1;
            var start = (st.currentPage - 1) * st.pageSize;
            var slice = sortedRows.slice(start, start + st.pageSize);
            els.gridHead.innerHTML = '<tr>' + st.allColumns.map(function(c, i) {
                var fullLabel = c.label || c.key || '';
                var lab = fieldLabelShort(fullLabel);
                var labelEsc = (lab.display || fullLabel).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/"/g, '&quot;');
                var keyEsc = (c.key || '').replace(/"/g, '&quot;');
                var titleEsc = (fullLabel || '').replace(/"/g, '&quot;').replace(/</g, '&lt;');
                var fullLabelAttr = (fullLabel || '').replace(/"/g, '&quot;');
                var sortIcon = '';
                if (st.sortKey === c.key) sortIcon = (st.sortDir === 'asc') ? '&#9650;' : (st.sortDir === 'desc' ? '&#9660;' : '');
                var w = st.columnWidths[c.key];
                /* Apply saved width even if smaller than content so user can narrow columns; content truncates with ellipsis. */
                var style = (w != null && w >= 1) ? ' style="width:' + w + 'px;min-width:' + w + 'px;max-width:' + w + 'px;"' : '';
                var isDateColumn = isLikelyDateColumn(st, c);
                var showTime = isTimeVisibleForColumn(st, c.key);
                var timeToggle = isDateColumn
                    ? ('<button type="button" class="entity-table-time-toggle' + (showTime ? ' is-active' : '') + '" data-column-key="' + keyEsc + '" title="' + (showTime ? 'Скрыть время для этой колонки' : 'Показывать время для этой колонки') + '" aria-label="' + (showTime ? 'Скрыть время для этой колонки' : 'Показывать время для этой колонки') + '"><i class="iconoir-clock"></i></button>')
                    : '';
                return '<th class="entity-table-th-draggable entity-table-th-wrap" draggable="true" data-column-index="' + i + '" data-column-key="' + keyEsc + '" data-full-label="' + fullLabelAttr + '" title="' + titleEsc + '"' + style + '><span class="entity-table-th-inline"><span class="entity-table-th-label">' + labelEsc + '</span><span class="entity-table-sort-indicator">' + sortIcon + '</span>' + timeToggle + '</span><span class="entity-table-col-resize" title="Изменить ширину"></span></th>';
            }).join('') + '</tr>';
            els.gridBody.innerHTML = slice.map(function(row) {
                return '<tr>' + st.allColumns.map(function(c) {
                    var val = row[c.key];
                    if (val !== null && typeof val === 'object') val = JSON.stringify(val);
                    var str = val != null ? String(val).trim() : '';
                    var dtFmt = formatDateTimeDisplay(str, isTimeVisibleForColumn(st, c.key));
                    var displayStr = dtFmt || str;
                    var cellHtml = '';
                    if (str && (str.indexOf('http://') === 0 || str.indexOf('https://') === 0)) {
                        var hrefEsc = str.replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                        var textEsc = str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
                        cellHtml = '<a href="' + hrefEsc + '" target="_blank" rel="noopener noreferrer" class="entity-table-cell-link">' + textEsc + '</a>';
                    } else {
                        cellHtml = displayStr.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
                    }
                    var isNum = typeof row[c.key] === 'number' || (str && /^-?\d+([.,]\d+)?([eE][+-]?\d+)?%?$/.test(str.replace(/\s/g, '')));
                    return '<td' + (isNum ? ' class="entity-table-cell-numeric"' : '') + '>' + cellHtml + '</td>';
                }).join('') + '</tr>';
            }).join('');
            if (els.paginationInfo) els.paginationInfo.textContent = 'Показано ' + (totalRows ? (start + 1) : 0) + ' — ' + (start + slice.length) + ' из ' + totalRows + ' записей';
            if (els.paginationNav) {
                var ul = document.createElement('ul');
                if (totalPages > 0) {
                    var prevDisabled = st.currentPage <= 1;
                    var prevLi = document.createElement('li');
                    if (prevDisabled) prevLi.className = 'datatable-disabled';
                    var prevBtn = document.createElement('button');
                    prevBtn.type = 'button';
                    prevBtn.setAttribute('data-page', 'prev');
                    prevBtn.textContent = '‹';
                    prevBtn.disabled = prevDisabled;
                    prevLi.appendChild(prevBtn);
                    ul.appendChild(prevLi);
                    var maxPages = Math.min(totalPages, 10);
                    for (var p = 1; p <= maxPages; p++) {
                        var li = document.createElement('li');
                        if (p === st.currentPage) li.className = 'datatable-active';
                        var btn = document.createElement('button');
                        btn.type = 'button';
                        btn.setAttribute('data-page', String(p));
                        btn.textContent = String(p);
                        li.appendChild(btn);
                        ul.appendChild(li);
                    }
                    var nextDisabled = st.currentPage >= totalPages;
                    var nextLi = document.createElement('li');
                    if (nextDisabled) nextLi.className = 'datatable-disabled';
                    var nextBtn = document.createElement('button');
                    nextBtn.type = 'button';
                    nextBtn.setAttribute('data-page', 'next');
                    nextBtn.textContent = '›';
                    nextBtn.disabled = nextDisabled;
                    nextLi.appendChild(nextBtn);
                    ul.appendChild(nextLi);
                }
                els.paginationNav.innerHTML = '';
                els.paginationNav.appendChild(ul);
            }
            syncSectionWidthToContent(tableIndex);
            updateTableTitleBlock(tableIndex);

            els.gridHead.querySelectorAll('th[data-column-key]').forEach(function(th) {
                th.onclick = null;
                th.onclick = function(e) {
                    if (th._suppressSortClickUntil && Date.now() < th._suppressSortClickUntil) {
                        e.preventDefault();
                        e.stopPropagation();
                        return;
                    }
                    if (e.target && e.target.closest && e.target.closest('.entity-table-col-resize')) return;
                    if (e.target && e.target.closest && e.target.closest('.entity-table-time-toggle')) return;
                    var key = th.getAttribute('data-column-key');
                    if (!key) return;
                    if (st.sortKey !== key) {
                        st.sortKey = key;
                        st.sortDir = 'asc';
                    } else if (st.sortDir === 'asc') {
                        st.sortDir = 'desc';
                    } else if (st.sortDir === 'desc') {
                        st.sortKey = '';
                        st.sortDir = '';
                    } else {
                        st.sortDir = 'asc';
                    }
                    st.currentPage = 1;
                    saveConfigToStorage();
                    saveConfig();
                    renderGrid(tableIndex);
                };
            });

            els.gridHead.querySelectorAll('.entity-table-time-toggle').forEach(function(btn) {
                btn.onclick = null;
                btn.onclick = function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    var key = btn.getAttribute('data-column-key');
                    if (!key) return;
                    if (!st.dateTimeDisplayByColumn || typeof st.dateTimeDisplayByColumn !== 'object') st.dateTimeDisplayByColumn = {};
                    st.dateTimeDisplayByColumn[key] = !isTimeVisibleForColumn(st, key);
                    saveConfigToStorage();
                    saveConfig();
                    renderGrid(tableIndex);
                };
            });

            els.gridHead.querySelectorAll('.entity-table-col-resize').forEach(function(handle) {
                handle.onclick = null;
                handle.onclick = function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                };
                if (window.PointerEvent) {
                    handle.onpointerdown = null;
                    handle.onpointerdown = function(e) {
                        if (e.button != null && e.button !== 0) return;
                        e.preventDefault();
                        e.stopPropagation();
                        var th = handle.closest('th');
                        if (!th) return;
                        var columnKey = th.getAttribute('data-column-key');
                        if (!columnKey) return;
                        var columnIndex = parseInt(th.getAttribute('data-column-index'), 10);
                        var startX = e.clientX;
                        var startWidth = th.getBoundingClientRect().width || th.offsetWidth || 0;
                        var didResize = false;
                        var dynamicMinWidth = Math.max(24, Math.floor(startWidth * 0.1));
                        th._suppressSortClickUntil = Date.now() + RESIZE_SORT_CLICK_SUPPRESS_MS;
                        var prevDraggable = th.draggable;
                        th.draggable = false;
                        if (handle.setPointerCapture && e.pointerId != null) {
                            try { handle.setPointerCapture(e.pointerId); } catch (err) {}
                        }
                        function applyWidthToColumnCells(px) {
                            if (!els.gridBody || isNaN(columnIndex) || columnIndex < 0) return;
                            var cellIndex = columnIndex + 1;
                            els.gridBody.querySelectorAll('tr').forEach(function(tr) {
                                var td = tr.querySelector('td:nth-child(' + cellIndex + ')');
                                if (!td) return;
                                td.style.width = px + 'px';
                                td.style.minWidth = px + 'px';
                                td.style.maxWidth = px + 'px';
                            });
                        }
                        function onPointerMove(e2) {
                            var dx = e2.clientX - startX;
                            if (Math.abs(dx) > 1) didResize = true;
                            var newWidth = Math.max(dynamicMinWidth, startWidth + dx);
                            th.style.width = newWidth + 'px';
                            th.style.minWidth = newWidth + 'px';
                            th.style.maxWidth = newWidth + 'px';
                            applyWidthToColumnCells(newWidth);
                            st.columnWidths[columnKey] = newWidth;
                            syncSectionWidthToContent(tableIndex);
                        }
                        function onPointerUp(e2) {
                            handle.removeEventListener('pointermove', onPointerMove);
                            handle.removeEventListener('pointerup', onPointerUp);
                            handle.removeEventListener('pointercancel', onPointerUp);
                            document.body.style.userSelect = '';
                            document.body.style.cursor = '';
                            th._suppressSortClickUntil = Date.now() + RESIZE_SORT_CLICK_SUPPRESS_MS;
                            th.draggable = prevDraggable;
                            if (handle.releasePointerCapture && e2 && e2.pointerId != null) {
                                try { handle.releasePointerCapture(e2.pointerId); } catch (err) {}
                            }
                            saveColumnWidths();
                            if (didResize) {
                                saveConfigToStorage();
                                saveConfig();
                                updateThLabelByWidth(th);
                            }
                            syncSectionWidthToContent(tableIndex);
                        }
                        document.body.style.userSelect = 'none';
                        document.body.style.cursor = 'col-resize';
                        handle.addEventListener('pointermove', onPointerMove);
                        handle.addEventListener('pointerup', onPointerUp);
                        handle.addEventListener('pointercancel', onPointerUp);
                    };
                }
                handle.onmousedown = null;
                handle.onmousedown = function(e) {
                    if (window.PointerEvent) return;
                    e.preventDefault();
                    e.stopPropagation();
                    var th = handle.closest('th');
                    if (!th) return;
                    var columnKey = th.getAttribute('data-column-key');
                    if (!columnKey) return;
                    var startX = e.clientX;
                    var startWidth = th.offsetWidth;
                    var columnIndex = parseInt(th.getAttribute('data-column-index'), 10);
                    var didResize = false;
                    var dynamicMinWidth = Math.max(24, Math.floor(startWidth * 0.1));
                    th._suppressSortClickUntil = Date.now() + RESIZE_SORT_CLICK_SUPPRESS_MS;
                    var prevDraggable = th.draggable;
                    th.draggable = false;
                    function applyWidthToColumnCells(px) {
                        if (!els.gridBody || isNaN(columnIndex) || columnIndex < 0) return;
                        var cellIndex = columnIndex + 1; // nth-child is 1-based
                        els.gridBody.querySelectorAll('tr').forEach(function(tr) {
                            var td = tr.querySelector('td:nth-child(' + cellIndex + ')');
                            if (!td) return;
                            td.style.width = px + 'px';
                            td.style.minWidth = px + 'px';
                            td.style.maxWidth = px + 'px';
                        });
                    }
                    function onMove(e2) {
                        var dx = e2.clientX - startX;
                        if (Math.abs(dx) > 1) didResize = true;
                        var newWidth = Math.max(dynamicMinWidth, startWidth + dx);
                        th.style.width = newWidth + 'px';
                        th.style.minWidth = newWidth + 'px';
                        th.style.maxWidth = newWidth + 'px';
                        applyWidthToColumnCells(newWidth);
                        st.columnWidths[columnKey] = newWidth;
                        syncSectionWidthToContent(tableIndex);
                    }
                    function onUp() {
                        document.removeEventListener('mousemove', onMove);
                        document.removeEventListener('mouseup', onUp);
                        document.body.style.userSelect = '';
                        document.body.style.cursor = '';
                        th._suppressSortClickUntil = Date.now() + RESIZE_SORT_CLICK_SUPPRESS_MS;
                        th.draggable = prevDraggable;
                        saveColumnWidths();
                        if (didResize) {
                            saveConfigToStorage();
                            saveConfig();
                            updateThLabelByWidth(th);
                        }
                        syncSectionWidthToContent(tableIndex);
                    }
                    document.body.style.userSelect = 'none';
                    document.body.style.cursor = 'col-resize';
                    document.addEventListener('mousemove', onMove);
                    document.addEventListener('mouseup', onUp);
                };
            });
            setupColumnDragDropForSection(tableIndex);
        }

        function setupColumnDragDropForSection(tableIndex) {
            var els = getSectionEls(tableIndex);
            var gridHead = els.gridHead;
            if (!gridHead || gridHead._dragDropBound) return;
            gridHead._dragDropBound = true;
            var columnDropTargetIndex = null;

            gridHead.addEventListener('dragstart', function(e) {
                if (e.target.closest('.entity-table-col-resize')) { e.preventDefault(); return; }
                var th = e.target.closest('th');
                if (!th || !th.classList.contains('entity-table-th-draggable')) return;
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('text/plain', th.getAttribute('data-column-index'));
                e.dataTransfer.setData('text/html', th.innerHTML);
                th.classList.add('dragging');
                columnDropTargetIndex = null;
            });
            gridHead.addEventListener('dragend', function(e) {
                gridHead.querySelectorAll('th').forEach(function(el) {
                    el.classList.remove('dragging', 'drag-over');
                });
                columnDropTargetIndex = null;
            });
            gridHead.addEventListener('dragover', function(e) {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
                var th = document.elementFromPoint(e.clientX, e.clientY);
                if (th) th = th.closest('th');
                if (!th || !th.classList.contains('entity-table-th-draggable')) {
                    gridHead.querySelectorAll('th').forEach(function(el) { el.classList.remove('drag-over'); });
                    columnDropTargetIndex = null;
                    return;
                }
                var toIdx = parseInt(th.getAttribute('data-column-index'), 10);
                if (!isNaN(toIdx)) columnDropTargetIndex = toIdx;
                gridHead.querySelectorAll('th').forEach(function(el) { el.classList.remove('drag-over'); });
                th.classList.add('drag-over');
            });
            gridHead.addEventListener('dragleave', function(e) {
                if (!gridHead.contains(e.relatedTarget)) {
                    gridHead.querySelectorAll('th').forEach(function(el) { el.classList.remove('drag-over'); });
                    columnDropTargetIndex = null;
                }
            });
            gridHead.addEventListener('drop', function(e) {
                e.preventDefault();
                gridHead.querySelectorAll('th').forEach(function(el) { el.classList.remove('drag-over'); });
                var toIdx = columnDropTargetIndex;
                if (toIdx == null || isNaN(toIdx)) {
                    var th = document.elementFromPoint(e.clientX, e.clientY);
                    if (th) th = th.closest('th');
                    if (th && th.classList.contains('entity-table-th-draggable')) {
                        toIdx = parseInt(th.getAttribute('data-column-index'), 10);
                    }
                }
                if (toIdx == null || isNaN(toIdx)) return;
                var fromIdx = parseInt(e.dataTransfer.getData('text/plain'), 10);
                if (isNaN(fromIdx) || fromIdx === toIdx) return;
                var st = tableStates[tableIndex];
                if (!st) return;
                var cols = st.allColumns;
                var a = cols[fromIdx];
                var b = cols[toIdx];
                cols[fromIdx] = b;
                cols[toIdx] = a;
                st.columnOrderFromServer = cols.map(function(c) { return c.key; });
                saveColumnOrder();
                saveConfigToStorage();
                saveConfig();
                renderGrid(tableIndex);
                columnDropTargetIndex = null;
            });
        }

        (function setupAddTableGrid() {
            var modalEl = document.getElementById('modalInsertTableGrid');
            var gridEl = document.getElementById('insertTableGrid');
            if (!modalEl || !gridEl) return;
            var modal = new bootstrap.Modal(modalEl);
            var GRID_ROWS = 3;
            var GRID_COLS = 3;
            var MAX_CELLS = GRID_ROWS * GRID_COLS;

            function renderInsertModalGrid() {
                var n = tableStates.length;
                gridEl.innerHTML = '';
                for (var i = 0; i < GRID_ROWS; i++) {
                    for (var j = 0; j < GRID_COLS; j++) {
                        var idx = i * GRID_COLS + j;
                        var isOccupied = idx < n;
                        var isAddSlot = idx === n && n < MAX_CELLS;
                        var disabled = !isOccupied && !isAddSlot;
                        var div = document.createElement('div');
                        div.className = 'col-4';
                        var cell = document.createElement('div');
                        cell.className = 'insert-grid-cell' + (isOccupied ? ' insert-grid-cell-occupied' : '') + (disabled ? ' disabled' : '');
                        cell.setAttribute('data-insert-index', String(idx));
                        cell.setAttribute('role', 'button');
                        cell.setAttribute('tabindex', disabled ? '-1' : '0');
                        if (isOccupied) {
                            var st = tableStates[idx];
                            var isCard = st && st.type === 'card';
                            var label = isCard ? (st.cardTitle && st.cardTitle.trim()) ? st.cardTitle.trim() : 'Карточка' : (st && st.tableTitle && st.tableTitle.trim()) ? st.tableTitle.trim() : (st && st.selectedEntities && st.selectedEntities[0]) ? (st.selectedEntities[0].title || st.selectedEntities[0].type || '') : '';
                            if (label.length > 20) label = label.slice(0, 17) + '…';
                            cell.setAttribute('title', label ? ((isCard ? 'Карточка ' : 'Таблица ') + (idx + 1) + ': ' + label) : ((isCard ? 'Карточка ' : 'Таблица ') + (idx + 1)));
                            cell.innerHTML = '<span class="cell-placeholder cell-occupied">' + (idx + 1) + '</span>';
                        } else {
                            cell.innerHTML = '<span class="cell-placeholder">' + (disabled ? '—' : '+') + '</span>';
                        }
                        if (!disabled) {
                            cell.addEventListener('click', function() {
                                var index = parseInt(this.getAttribute('data-insert-index'), 10);
                                modal.hide();
                                tableStates.splice(index, 0, defaultTableState());
                                ensureSections();
                                for (var i = 0; i < tableStates.length; i++) {
                                    var s = tableStates[i];
                                    if (s.fullData && s.fullData.length > 0) {
                                        if (!s.allColumns || s.allColumns.length === 0) {
                                            rebuildAllColumnsFromSelectedFields(i);
                                            if (s.allColumns.length === 0) rebuildAllColumnsFromData(i);
                                        }
                                    }
                                    renderGrid(i);
                                }
                                updateUI(index);
                                currentTableIndex = index;
                                var nameInput = document.getElementById('tableNameInput');
                                var descInput = document.getElementById('tableDescriptionInput');
                                if (nameInput) nameInput.value = '';
                                if (descInput) descInput.value = '';
                                openEntityModal();
                            });
                        }
                        div.appendChild(cell);
                        gridEl.appendChild(div);
                    }
                }
            }

            window.openInsertTableGrid = function() {
                if (tableStates.length >= MAX_CELLS) {
                    alert('Достигнут максимум виджетов на странице (' + MAX_CELLS + ').');
                    return;
                }
                renderInsertModalGrid();
                modal.show();
            };
        })();

        (function setupAddTableOrCardChoice() {
            var choiceModalEl = document.getElementById('modalAddTableOrCard');
            var topbarWrap = document.getElementById('topbarBtnAddEntityWrap');
            var topbarBtn = document.getElementById('topbarBtnAddEntity');
            var btnChoiceTable = document.getElementById('btnChoiceTable');
            var btnChoiceCard = document.getElementById('btnChoiceCard');
            if (!choiceModalEl) return;
            var choiceModal = new bootstrap.Modal(choiceModalEl);
            if (topbarWrap && topbarBtn) {
                topbarWrap.classList.remove('d-none');
                topbarWrap.style.display = '';
                topbarBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    if (isGuestUser()) return;
                    choiceModal.show();
                });
            }
            if (btnChoiceTable) {
                btnChoiceTable.addEventListener('click', function() {
                    choiceModal.hide();
                    if (typeof window.openInsertTableGrid === 'function') window.openInsertTableGrid();
                });
            }
            if (btnChoiceCard) {
                btnChoiceCard.addEventListener('click', function() {
                    choiceModal.hide();
                    if (typeof window.openAddCardModal === 'function') window.openAddCardModal(null);
                });
            }
        })();

        /* Card add/edit modal and logic moved to partial entity_card_modal.html + entity-card-widget.js; window.openAddCardModal is set by that script. */

        // --- Шаблоны: с сервера (общие для всех), выпадающий список по кнопке «Шаблоны» ---
        function loadTemplates() {
            var modalDropdown = document.getElementById('templatesDropdown');
            var modalFieldsDropdown = document.getElementById('templatesDropdownFields');
            var emptyLi = '<li><span class="dropdown-item text-muted">Нет шаблонов</span></li>';
            if (!modalDropdown && !modalFieldsDropdown) return;
            if (modalDropdown) modalDropdown.innerHTML = emptyLi;
            if (modalFieldsDropdown) modalFieldsDropdown.innerHTML = emptyLi;

            fetch(API.templates)
                .then(function(r) { return r.json(); })
                .then(function(data) {
                    var list = (data && data.templates && Array.isArray(data.templates)) ? data.templates : [];
                    renderTemplatesList(list);
                })
                .catch(function() {
                    renderTemplatesList([]);
                });

            function renderTemplatesList(list) {
                var itemHtml = list.length
                    ? list.map(function(t) {
                        var nameEsc = (t.name || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/"/g, '&quot;');
                        var dataTables = (t.tables && t.tables.length) ? (JSON.stringify(t.tables).replace(/'/g, '&#39;')) : '';
                        var dataEntities = (JSON.stringify(t.entities || []).replace(/'/g, '&#39;'));
                        var dataFields = (JSON.stringify(t.fields || []).replace(/'/g, '&#39;'));
                        return '<li class="d-flex align-items-center dropdown-item-wrap">' +
                            '<a class="dropdown-item flex-grow-1 text-truncate" href="#" data-id="' + (t.id || '') + '" data-entities=\'' + dataEntities + '\' data-fields=\'' + dataFields + '\'' + (dataTables ? ' data-tables=\'' + dataTables + '\'' : '') + '>' + nameEsc + '</a>' +
                            '<button type="button" class="btn btn-link btn-sm text-danger p-1 ms-1" title="Удалить шаблон" data-delete-id="' + (t.id || '') + '" aria-label="Удалить">&times;</button>' +
                            '</li>';
                    }).join('')
                    : emptyLi;

                function bindDropdown(dropdownEl, onApply) {
                    if (!dropdownEl) return;
                    dropdownEl.innerHTML = itemHtml;
                    dropdownEl.querySelectorAll('a[data-id]').forEach(function(a) {
                        a.addEventListener('click', function(e) {
                            if (e.target.closest('button[data-delete-id]')) return;
                            e.preventDefault();
                            var idx = currentTableIndex;
                            var tablesStr = this.getAttribute('data-tables');
                            if (tablesStr && tablesStr.length) {
                                try {
                                    var tables = JSON.parse(tablesStr);
                                    if (tables && tables.length) {
                                        applyConfig({ tables: tables });
                                        ensureSections();
                                        tableStates.forEach(function(_, i) { loadFieldsThenData(i); });
                                        if (onApply) onApply();
                                        return;
                                    }
                                } catch (err) {}
                            }
                            var entities = [];
                            var fields = [];
                            try {
                                entities = JSON.parse(this.getAttribute('data-entities') || '[]');
                                fields = JSON.parse(this.getAttribute('data-fields') || '[]');
                            } catch (err) {}
                            var norm = normalizeEntitiesAndFields(entities, fields);
                            tableStates[idx].selectedEntities = norm.entities;
                            tableStates[idx].selectedFields = norm.fields;
                            updateUI(idx);
                            saveConfig();
                            saveConfigToStorage();
                            loadFieldsThenData(idx);
                            if (onApply) onApply();
                        });
                    });
                    dropdownEl.querySelectorAll('button[data-delete-id]').forEach(function(btn) {
                        btn.addEventListener('click', function(e) {
                            e.preventDefault();
                            e.stopPropagation();
                            var id = this.getAttribute('data-delete-id');
                            if (!id) return;
                            if (!confirm('Удалить этот шаблон?')) return;
                            fetch(API.templates + '/' + id, { method: 'DELETE' })
                                .then(function(r) { return r.json(); })
                                .then(function(res) { if (res && res.ok) loadTemplates(); })
                                .catch(function() {});
                        });
                    });
                }
                bindDropdown(modalDropdown, function() { modalEntity.hide(); });
                bindDropdown(modalFieldsDropdown, function() { modalFields.hide(); });
            }
        }

        (function setupTemplates() {
            var dd = document.getElementById('templatesDropdown');
            if (dd && dd.closest('.dropdown')) dd.closest('.dropdown').addEventListener('show.bs.dropdown', loadTemplates);
            var dd2 = document.getElementById('templatesDropdownFields');
            if (dd2 && dd2.closest('.dropdown')) dd2.closest('.dropdown').addEventListener('show.bs.dropdown', loadTemplates);
            var modalEntityEl = document.getElementById('modalEntity');
            var modalFieldsEl = document.getElementById('modalFields');
            if (modalEntityEl) modalEntityEl.addEventListener('shown.bs.modal', loadTemplates);
            if (modalFieldsEl) modalFieldsEl.addEventListener('shown.bs.modal', loadTemplates);
        })();

        isReadOnly = isGuestUser();
        applyReadOnlyMode();
        loadConfig();
        startGuestConfigAutoRefresh();
        /* ensureSections() is called inside loadConfig() / applyConfig() / tryApplyStored() / showDashboardLoadError() */

        window.addEventListener('beforeunload', saveConfigBeforeUnload);

        // Dependencies for entity-card-widget.js (BI-style card: separate data config per main/secondary value)
        window.__cardDeps = {
            getTableStates: function() { return tableStates; },
            entityKey: entityKey,
            fetchPage: fetchPage,
            getSectionEls: getSectionEls,
            ensureSections: ensureSections,
            saveConfigToStorage: saveConfigToStorage,
            saveConfig: saveConfig,
            deleteTableAtIndex: deleteTableAtIndex,
            loadEntitiesList: loadEntitiesList,
            loadFieldsForEntity: loadFieldsForEntity,
            normalizeEntitiesAndFields: normalizeEntitiesAndFields,
            getFieldsCache: function() { return fieldsCache; },
            getEntitiesList: function() { return entitiesList; },
            API: API,
            getPageSlug: getPageSlug
        };
    });
</script>
<script src="{{ config.ASSETS_ROOT }}/js/entity-card-widget.js"></script>
{% endblock %}

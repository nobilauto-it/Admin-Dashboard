{% extends 'layouts/base.html' %}

{% block title %}Login{% endblock %}

{% block styles %}

{% endblock styles %}

{% block content %}
<div class="container-xxl">
    <div class="row vh-100 d-flex justify-content-center">
        <div class="col-12 align-self-center">
            <div class="card-body">
                <div class="row">
                    <div class="col-lg-4 mx-auto">
                        <div class="card">
                            <div class="card-body p-0 bg-black auth-header-box rounded-top">
                                <div class="text-center p-3">
                                    <a class="logo logo-admin" href="/">
                                        <img alt="logo" class="auth-logo" height="50"
                                             src="{{ config.ASSETS_ROOT }}/images/logo-sm.png"/>
                                    </a>
                                    <h4 class="mt-3 mb-1 fw-semibold text-white fs-18">Let's Get Started Dastone</h4>
                                    <p class="text-muted fw-medium mb-0">Sign in to continue to Dastone.</p>
                                </div>
                            </div>
                            <div class="card-body">
                                <div id="login-error" class="alert alert-danger d-none" role="alert"></div>
                                <form id="login-form" action="/" class="my-4" method="post">
                                    <div class="form-group mb-2">
                                        <label class="form-label" for="username">Username <span class="text-danger">*</span></label>
                                        <input class="form-control" id="username" name="username" required
                                               placeholder="Enter username" type="text" autocomplete="username"/>
                                    </div><!--end form-group-->
                                    <div class="form-group">
                                        <label class="form-label" for="userpassword">Password <span class="text-danger">*</span></label>
                                        <input class="form-control" id="userpassword" name="password" required
                                               placeholder="Enter password" type="password" autocomplete="current-password"/>
                                    </div><!--end form-group-->
                                    <div class="form-group row mt-3">
                                        <div class="col-sm-6">
                                            <div class="form-check form-switch form-switch-primary">
                                                <input class="form-check-input" id="customSwitchPrimary"
                                                       type="checkbox"/>
                                                <label class="form-check-label" for="customSwitchPrimary">Remember
                                                    me</label>
                                            </div>
                                        </div><!--end col-->
                                        <div class="col-sm-6 text-end">
                                            <a class="text-muted font-13" href="/auth-recover-pw"><i
                                                    class="dripicons-lock"></i> Forgot password?</a>
                                        </div><!--end col-->
                                    </div><!--end form-group-->
                                    <div class="form-group mb-0 row">
                                        <div class="col-12">
                                            <div class="d-grid mt-3">
                                                <button class="btn btn-primary" type="submit" id="login-submit">Log In <i
                                                        class="fas fa-sign-in-alt ms-1"></i></button>
                                            </div>
                                        </div><!--end col-->
                                    </div> <!--end form-group-->
                                </form><!--end form-->
                                <div class="text-center mb-2">
                                    <p class="text-muted">Don't have an account ? <a class="text-primary ms-2"
                                                                                     href="/auth-register">Free
                                        Resister</a></p>
                                    <h6 class="px-3 d-inline-block">Or Login With</h6>
                                </div>
                                <div class="d-flex justify-content-center">
                                    <a class="d-flex justify-content-center align-items-center thumb-md bg-blue-subtle text-blue rounded-circle me-2"
                                       href="">
                                        <i class="fab fa-facebook align-self-center"></i>
                                    </a>
                                    <a class="d-flex justify-content-center align-items-center thumb-md bg-info-subtle text-info rounded-circle me-2"
                                       href="">
                                        <i class="fab fa-twitter align-self-center"></i>
                                    </a>
                                    <a class="d-flex justify-content-center align-items-center thumb-md bg-danger-subtle text-danger rounded-circle"
                                       href="">
                                        <i class="fab fa-google align-self-center"></i>
                                    </a>
                                </div>
                            </div><!--end card-body-->
                        </div><!--end card-->
                    </div><!--end col-->
                </div><!--end row-->
            </div><!--end card-body-->
        </div><!--end col-->
    </div><!--end row-->
</div><!-- container -->
{% endblock %}

{% block javascripts %}
<script>
(function() {
    var API_LOGIN_URL = '/api/login';
    var AUTH_USER_ID_KEY = 'auth_user_id';

    function showError(msg) {
        var el = document.getElementById('login-error');
        if (!el) return;
        el.textContent = msg || '';
        el.classList.toggle('d-none', !msg);
    }

    function setSubmitting(loading) {
        var btn = document.getElementById('login-submit');
        if (btn) {
            btn.disabled = loading;
            btn.innerHTML = loading ? 'Logging in…' : 'Log In <i class="fas fa-sign-in-alt ms-1"></i>';
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        var form = document.getElementById('login-form');
        if (!form) return;
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            showError('');
            var username = (document.getElementById('username') && document.getElementById('username').value) || '';
            var password = (document.getElementById('userpassword') && document.getElementById('userpassword').value) || '';
            username = username.trim();
            if (!username || !password) {
                showError('Username and Password are required');
                return;
            }
            setSubmitting(true);
            fetch(API_LOGIN_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ Username: username, Password: password })
            })
            .then(function(res) { return res.json().then(function(data) { return { ok: res.ok, status: res.status, data: data }; }); })
            .then(function(result) {
                setSubmitting(false);
                if (result.ok && result.data.success && result.data.user_id != null) {
                    localStorage.setItem(AUTH_USER_ID_KEY, String(result.data.user_id));
                    window.location.href = '/';
                    return;
                }
                if (result.status === 400) {
                    showError(result.data.detail || 'Username and Password are required');
                    return;
                }
                if (result.status === 401) {
                    showError(result.data.detail || 'Неверный логин или пароль');
                    return;
                }
                if (result.status >= 500) {
                    showError('Ошибка сервера, попробуйте позже');
                    return;
                }
                showError(result.data.detail || 'Ошибка входа');
            })
            .catch(function(err) {
                setSubmitting(false);
                showError('Ошибка сети или сервера. Попробуйте позже.');
            });
        });
    });
})();
</script>
{% endblock javascripts %}

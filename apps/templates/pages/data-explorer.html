{% extends 'layouts/vertical.html' %}

{% block title %}Data Explorer{% endblock %}

{% block styles %}
<style>
    .field-list {
        max-height: 260px;
        overflow-y: auto;
        border: 1px solid #e5e7eb;
        border-radius: 6px;
        padding: 10px;
    }
    .chart-container {
        min-height: 420px;
    }
    .table-scroll {
        max-height: 480px;
        overflow: auto;
        border: 1px solid #eef1f5;
        border-radius: 6px;
    }
    .badge-endpoint {
        font-size: 11px;
        background: #f4f6fb;
        color: #64748b;
        border: 1px dashed #e0e7ff;
    }
</style>
{% endblock styles %}

{% block page_content %}
<div class="row">
    <div class="col-sm-12">
        <div class="page-title-box d-md-flex justify-content-md-between align-items-center">
            <h4 class="page-title">Data Explorer</h4>
            <div class="">
                <ol class="breadcrumb mb-0">
                    <li class="breadcrumb-item"><a href="#">Dastone</a></li>
                    <li class="breadcrumb-item active">Data Explorer</li>
                </ol>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <div class="row g-2 align-items-center">
                    <div class="col-md-4">
                        <label class="form-label mb-1">Сущность</label>
                        <select id="entitySelect" class="form-select">
                            <option value="deal" selected>Сделки</option>
                            <option value="smart_process_1114">Смарт-процесс 1114</option>
                            <option value="contact">Контакты</option>
                            <option value="lead">Лиды</option>
                        </select>
                    </div>
                    <div class="col-md-8">
                        <div class="row g-2 align-items-center">
                            <div class="col-lg-5">
                                <label class="form-label mb-1">Компонент</label>
                                <select id="componentType" class="form-select form-select-sm">
                                    <option value="table">Только таблица</option>
                                    <option value="bar">Столбчатая</option>
                                    <option value="area">Area</option>
                                    <option value="line">Линейная</option>
                                    <option value="pie">Круговая</option>
                                    <option value="donut">Donut</option>
                                </select>
                            </div>
                            <div class="col-lg-7">
                                <label class="form-label mb-1">Поле для диаграммы</label>
                                <select id="vizField" class="form-select form-select-sm" disabled>
                                    <option value="">Выберите поле</option>
                                </select>
                            </div>
                            <div class="col-12">
                                <div class="d-flex flex-wrap align-items-center gap-2">
                                    <span class="badge badge-endpoint" id="fieldsEndpointBadge">fields: —</span>
                                    <span class="badge badge-endpoint" id="dataEndpointBadge">data: —</span>
                                    <div class="ms-auto">
                                        <button id="applySelection" class="btn btn-primary btn-sm">
                                            Применить
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-lg-4">
                        <div class="d-flex align-items-center justify-content-between mb-2 flex-wrap gap-2">
                            <h6 class="mb-0">Поля (отметьте для вывода)</h6>
                            <input id="fieldsSearch" type="text" class="form-control form-control-sm w-50" placeholder="Поиск полей">
                        </div>
                        <div class="d-flex gap-2 mb-2 flex-wrap">
                            <button class="btn btn-outline-primary btn-xs" id="selectAllFields">Выбрать всё</button>
                            <button class="btn btn-outline-secondary btn-xs" id="clearAllFields">Снять всё</button>
                            <button class="btn btn-outline-dark btn-xs" id="savePreset">Сохранить пресет</button>
                            <div class="input-group input-group-sm" style="width: 200px;">
                                <span class="input-group-text">Пресет</span>
                                <select id="presetSelect" class="form-select">
                                    <option value="">—</option>
                                </select>
                                <button class="btn btn-outline-secondary" id="loadPreset" type="button">Загрузить</button>
                            </div>
                        </div>
                        <div id="fieldsContainer" class="field-list small text-muted">
                            Загрузка полей...
                        </div>
                    </div>
                    <div class="col-lg-8">
                        <div class="d-flex justify-content-between align-items-center mb-2 flex-wrap gap-2">
                            <div class="d-flex align-items-center gap-2 flex-wrap">
                                <h6 class="mb-0">Диаграмма</h6>
                                <div class="input-group input-group-sm" style="width: 160px;">
                                    <span class="input-group-text">Top</span>
                                    <input type="number" id="topLimit" class="form-control" value="12" min="1" max="50">
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="checkbox" id="stackedToggle">
                                    <label class="form-check-label" for="stackedToggle">Stacked</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="checkbox" id="horizontalToggle">
                                    <label class="form-check-label" for="horizontalToggle">Horizontal</label>
                                </div>
                            </div>
                            <div class="d-flex align-items-center gap-2">
                                <button class="btn btn-outline-success btn-sm" id="exportCsv">Экспорт CSV</button>
                                <small class="text-muted" id="chartHint">Выберите тип и поле</small>
                            </div>
                        </div>
                        <div class="position-relative">
                            <div id="chartArea" class="chart-container"></div>
                            <div id="loaderOverlay" class="position-absolute top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center bg-white bg-opacity-75" style="display:none;">
                                <div class="spinner-border text-primary" role="status" style="width: 2rem; height:2rem;">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h4 class="card-title mb-0">Данные</h4>
                <small class="text-muted" id="rowsCount">0 записей</small>
            </div>
            <div class="card-body">
                <div class="table-scroll">
                    <table class="table mb-0 table-sm" id="dataTable">
                        <thead class="table-light">
                            <tr id="dataHeader">
                                <th>Нет данных</th>
                            </tr>
                        </thead>
                        <tbody id="dataBody">
                            <tr><td>Выберите сущность и поля, затем нажмите «Применить».</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block javascripts %}
<script src="{{ config.ASSETS_ROOT }}/libs/apexcharts/apexcharts.min.js"></script>
<script>
const endpoints = {
    deal: {
        label: 'Сделки',
        fields: '/api/data-explorer/fields?entity=deal',
        data:   '/api/data-explorer/data?entity=deal&limit=100'
    },
    smart_process_1114: {
        label: 'Смарт-процесс 1114',
        fields: '/api/data-explorer/fields?entity=smart_process_1114',
        data:   '/api/data-explorer/data?entity=smart_process_1114&limit=100'
    },
    contact: {
        label: 'Контакты',
        fields: '/api/data-explorer/fields?entity=contact',
        data:   '/api/data-explorer/data?entity=contact&limit=100'
    },
    lead: {
        label: 'Лиды',
        fields: '/api/data-explorer/fields?entity=lead',
        data:   '/api/data-explorer/data?entity=lead&limit=100'
    },
};

let chart = null;
let lastSelectedFields = [];
let allFields = [];
const palette = ['#5b8def','#5ad8a6','#5d7092','#f6bd16','#e8684a','#6dc8ec','#9270ca','#ff9d4d','#269a99','#ff99c3'];
const PRESET_KEY = 'data_explorer_presets';

function updateBadges(entityKey) {
    const f = document.getElementById('fieldsEndpointBadge');
    const d = document.getElementById('dataEndpointBadge');
    if (endpoints[entityKey]) {
        f.textContent = `fields: ${endpoints[entityKey].fields}`;
        d.textContent = `data: ${endpoints[entityKey].data}`;
    }
}

async function fetchJson(url, timeout = 15000) {
    const controller = new AbortController();
    const timer = setTimeout(() => controller.abort(), timeout);
    try {
        const res = await fetch(url, { signal: controller.signal });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        return await res.json();
    } finally {
        clearTimeout(timer);
    }
}

function normalizeField(field) {
    return {
        key: field.name || field.code || field.field || field.id || '',
        label: field.title || field.caption || field.name || field.code || field.field || 'field'
    };
}

function renderFields(fields) {
    const cont = document.getElementById('fieldsContainer');
    cont.innerHTML = '';
    if (!fields.length) {
        cont.textContent = 'Поля не найдены';
        return;
    }
    fields.forEach((f, idx) => {
        const id = `fld_${f.key}`;
        const wrap = document.createElement('div');
        wrap.className = 'form-check mb-1';
        wrap.innerHTML = `
            <input class="form-check-input entity-field" type="checkbox" value="${f.key}" id="${id}" ${idx < 4 ? 'checked' : ''}>
            <label class="form-check-label" for="${id}">${f.label}</label>
        `;
        cont.appendChild(wrap);
    });
}

function buildHeader(selectedFields) {
    const headerRow = document.getElementById('dataHeader');
    headerRow.innerHTML = '';
    selectedFields.forEach(f => {
        const th = document.createElement('th');
        th.textContent = f.label;
        headerRow.appendChild(th);
    });
}

function buildBody(data, selectedFields) {
    const body = document.getElementById('dataBody');
    body.innerHTML = '';
    if (!data.length || !selectedFields.length) {
        body.innerHTML = '<tr><td>Нет данных</td></tr>';
        return;
    }
    data.forEach(row => {
        const tr = document.createElement('tr');
        selectedFields.forEach(f => {
            const td = document.createElement('td');
            const val = row[f.key];
            td.textContent = (val === undefined || val === null) ? '' : val;
            tr.appendChild(td);
        });
        body.appendChild(tr);
    });
}

function updateVizFieldSelect(fields) {
    const sel = document.getElementById('vizField');
    sel.innerHTML = '<option value=\"\">Выберите поле</option>';
    if (!fields.length) {
        sel.disabled = true;
        return;
    }
    fields.forEach(f => {
        const opt = document.createElement('option');
        opt.value = f.key;
        opt.textContent = f.label;
        sel.appendChild(opt);
    });
    sel.disabled = false;
}

function buildChart(data, selectedFields) {
    const hint = document.getElementById('chartHint');
    const componentType = document.getElementById('componentType').value;
    const vizFieldKey = document.getElementById('vizField').value || (selectedFields[0]?.key || '');
    const limit = Math.min(Math.max(parseInt(document.getElementById('topLimit').value || '12', 10), 1), 50);
    const stacked = document.getElementById('stackedToggle').checked;
    const horizontal = document.getElementById('horizontalToggle').checked;

    if (componentType === 'table') {
        hint.textContent = 'Режим: только таблица';
        if (chart) chart.destroy();
        chart = null;
        document.getElementById('chartArea').innerHTML = '';
        return;
    }

    if (!selectedFields.length || !data.length || !vizFieldKey) {
        hint.textContent = 'Выберите тип и поле для диаграммы';
        if (chart) chart.destroy();
        chart = null;
        document.getElementById('chartArea').innerHTML = '';
        return;
    }
    const field = selectedFields.find(f => f.key === vizFieldKey) || selectedFields[0];
    const freq = {};
    data.forEach(row => {
        const v = row[field.key];
        const key = (v === undefined || v === null || v === '') ? '—' : String(v);
        freq[key] = (freq[key] || 0) + 1;
    });
    const entries = Object.entries(freq)
        .sort((a,b) => b[1]-a[1])
        .slice(0, limit);
    const categories = entries.map(e => e[0]);
    const counts = entries.map(e => e[1]);

    hint.textContent = `Распределение по полю: ${field.label}`;

    let options;
    if (componentType === 'pie' || componentType === 'donut') {
        options = {
            chart: { type: componentType, height: 420, toolbar: { show: false } },
            series: counts,
            labels: categories,
            colors: palette,
            dataLabels: { enabled: true, formatter: (val, opts) => `${opts.w.config.labels[opts.seriesIndex]}: ${val.toFixed(1)}%` },
            legend: { position: 'bottom' },
            stroke: { colors: ['#fff'] }
        };
    } else if (componentType === 'line' || componentType === 'area') {
        options = {
            chart: { type: componentType, height: 420, toolbar: { show: false } },
            series: [{ name: 'Count', data: counts }],
            xaxis: { categories, labels: { rotate: -45 } },
            stroke: { curve: 'smooth' },
            dataLabels: { enabled: false },
            tooltip: { y: { formatter: val => val } },
            colors: [palette[0]]
        };
    } else {
        // bar (default)
        options = {
            chart: { type: 'bar', height: 420, toolbar: { show: false }, stacked },
            series: [{ name: 'Count', data: counts }],
            xaxis: { categories, labels: { rotate: horizontal ? 0 : -45 } },
            plotOptions: {
                bar: {
                    horizontal,
                    columnWidth: horizontal ? '55%' : '55%',
                    distributed: !stacked
                }
            },
            dataLabels: { enabled: false },
            tooltip: { y: { formatter: val => val } },
            colors: palette
        };
    }
    if (chart) chart.destroy();
    chart = new ApexCharts(document.querySelector("#chartArea"), options);
    chart.render();
}

async function loadAndRender() {
    document.getElementById('loaderOverlay').style.display = 'flex';
    const entity = document.getElementById('entitySelect').value;
    const fieldInputs = Array.from(document.querySelectorAll('.entity-field'));
    const selectedKeys = fieldInputs.filter(f => f.checked).map(f => f.value);
    const selectedLabels = fieldInputs.filter(f => f.checked).map(f => f.nextElementSibling.textContent);
    const selectedFields = selectedKeys.map((k, idx) => ({ key: k, label: selectedLabels[idx] || k }));
    lastSelectedFields = selectedFields;
    updateVizFieldSelect(selectedFields);

    const rowsCount = document.getElementById('rowsCount');
    rowsCount.textContent = 'Загрузка...';

    try {
        const dataUrl = endpoints[entity].data;
        const dataRes = await fetchJson(dataUrl);
        const rows = dataRes.data || dataRes || [];

        buildHeader(selectedFields);
        buildBody(rows, selectedFields);
        buildChart(rows, selectedFields);
        rowsCount.textContent = `${rows.length} записей`;
    } catch (err) {
        console.error(err);
        rowsCount.textContent = 'Ошибка загрузки';
        document.getElementById('dataBody').innerHTML = `<tr><td>Ошибка: ${err.message}</td></tr>`;
        document.getElementById('dataHeader').innerHTML = '<th>Ошибка</th>';
        buildChart([], []);
    }
    document.getElementById('loaderOverlay').style.display = 'none';
}

async function initFields() {
    const entity = document.getElementById('entitySelect').value;
    updateBadges(entity);
    const cont = document.getElementById('fieldsContainer');
    cont.textContent = 'Загрузка полей...';
    try {
        const res = await fetchJson(endpoints[entity].fields);
        const rawFields = res.data || res.fields || res || [];
        allFields = rawFields
            .map(normalizeField)
            .filter(f => f.key);
        renderFields(allFields);
        updateVizFieldSelect(allFields.slice(0, 4)); // default checked subset
    } catch (err) {
        console.error(err);
        cont.textContent = 'Ошибка загрузки полей';
    }
}

document.addEventListener('DOMContentLoaded', async () => {
    updateBadges('deal');
    await initFields();
    await loadAndRender();

    document.getElementById('entitySelect').addEventListener('change', async () => {
        await initFields();
    });

    document.getElementById('applySelection').addEventListener('click', async () => {
        await loadAndRender();
    });

    document.getElementById('componentType').addEventListener('change', async () => {
        // При смене типа диаграммы перерисовать с текущими данными
        await loadAndRender();
    });

    document.getElementById('vizField').addEventListener('change', async () => {
        // Перерисовать диаграмму с выбранным полем
        await loadAndRender();
    });

    // Поиск по полям
    document.getElementById('fieldsSearch').addEventListener('input', (e) => {
        const q = e.target.value.toLowerCase();
        const filtered = allFields.filter(f => f.label.toLowerCase().includes(q) || f.key.toLowerCase().includes(q));
        renderFields(filtered);
    });

    // Выбрать всё
    document.getElementById('selectAllFields').addEventListener('click', () => {
        document.querySelectorAll('.entity-field').forEach(ch => ch.checked = true);
    });

    // Снять всё
    document.getElementById('clearAllFields').addEventListener('click', () => {
        document.querySelectorAll('.entity-field').forEach(ch => ch.checked = false);
    });

    // Пресеты
    function loadPresets() {
        const saved = localStorage.getItem(PRESET_KEY);
        if (!saved) return {};
        try { return JSON.parse(saved); } catch { return {}; }
    }

    function savePresets(presets) {
        localStorage.setItem(PRESET_KEY, JSON.stringify(presets));
    }

    function refreshPresetSelect() {
        const sel = document.getElementById('presetSelect');
        const presets = loadPresets();
        sel.innerHTML = '<option value=\"\">—</option>';
        Object.keys(presets).forEach(name => {
            const opt = document.createElement('option');
            opt.value = name;
            opt.textContent = name;
            sel.appendChild(opt);
        });
    }

    refreshPresetSelect();

    document.getElementById('savePreset').addEventListener('click', () => {
        const name = prompt('Название пресета');
        if (!name) return;
        const fieldInputs = Array.from(document.querySelectorAll('.entity-field'));
        const selectedKeys = fieldInputs.filter(f => f.checked).map(f => f.value);
        const entity = document.getElementById('entitySelect').value;
        const componentType = document.getElementById('componentType').value;
        const vizField = document.getElementById('vizField').value;
        const topLimit = document.getElementById('topLimit').value;
        const stacked = document.getElementById('stackedToggle').checked;
        const horizontal = document.getElementById('horizontalToggle').checked;
        const presets = loadPresets();
        presets[name] = { entity, selectedKeys, componentType, vizField, topLimit, stacked, horizontal };
        savePresets(presets);
        refreshPresetSelect();
        alert('Сохранено');
    });

    document.getElementById('loadPreset').addEventListener('click', async () => {
        const name = document.getElementById('presetSelect').value;
        if (!name) return;
        const presets = loadPresets();
        const p = presets[name];
        if (!p) return;
        document.getElementById('entitySelect').value = p.entity || 'deal';
        document.getElementById('componentType').value = p.componentType || 'table';
        document.getElementById('topLimit').value = p.topLimit || '12';
        document.getElementById('stackedToggle').checked = !!p.stacked;
        document.getElementById('horizontalToggle').checked = !!p.horizontal;

        await initFields();
        document.querySelectorAll('.entity-field').forEach(ch => {
            ch.checked = p.selectedKeys ? p.selectedKeys.includes(ch.value) : ch.checked;
        });
        if (p.vizField) {
            document.getElementById('vizField').value = p.vizField;
        }
        await loadAndRender();
    });

    // Экспорт CSV
    document.getElementById('exportCsv').addEventListener('click', () => {
        const rows = [];
        const headerCells = Array.from(document.querySelectorAll('#dataHeader th')).map(th => th.innerText);
        const bodyRows = Array.from(document.querySelectorAll('#dataBody tr'));
        if (!bodyRows.length) return;
        rows.push(headerCells);
        bodyRows.forEach(tr => {
            const cells = Array.from(tr.querySelectorAll('td')).map(td => td.innerText);
            rows.push(cells);
        });
        const csv = rows.map(r => r.map(v => `"${(v || '').replace(/"/g,'""')}"`).join(',')).join('\n');
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'data.csv';
        a.click();
        URL.revokeObjectURL(url);
    });
});
</script>
{% endblock javascripts %}
